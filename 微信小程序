dormitory-management-system/
â”œâ”€â”€ miniprogram/                    # å¾®ä¿¡å°ç¨‹åºå‰ç«¯
â”‚   â”œâ”€â”€ app.js                     # å°ç¨‹åºå…¥å£æ–‡ä»¶ âœ…KOPBB
â”‚   â”œâ”€â”€ app.json                   # å°ç¨‹åºé…ç½®æ–‡ä»¶ âœ…KOPBB
â”‚   â”œâ”€â”€ app.wxss                   # å…¨å±€æ ·å¼æ–‡ä»¶ âœ…KOPBB
â”‚   â”œâ”€â”€ project.config.json        # é¡¹ç›®é…ç½® âœ…KOPBB
â”‚   â”œâ”€â”€ sitemap.json               # æœç´¢ç´¢å¼•é…ç½® âœ…KOPBB
â”‚   â”œâ”€â”€ pages/                     # é¡µé¢æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ index/                 # é¦–é¡µ âœ…O
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js  PBB
â”‚   â”‚   â”‚   â”œâ”€â”€ index.json   PBB
â”‚   â”‚   â”‚   â”œâ”€â”€ index.wxml   PBB
â”‚   â”‚   â”‚   â””â”€â”€ index.wxss   PBB
â”‚   â”‚   â”œâ”€â”€ login/                 # ç™»å½•é¡µé¢ âœ…O
â”‚   â”‚   â”‚   â”œâ”€â”€ login.js  PBB
â”‚   â”‚   â”‚   â”œâ”€â”€ login.json   PBB
â”‚   â”‚   â”‚   â”œâ”€â”€ login.wxml   PBB
â”‚   â”‚   â”‚   â””â”€â”€ login.wxss   PBB
â”‚   â”‚   â”œâ”€â”€ register/              # æ³¨å†Œé¡µé¢ âœ…O
â”‚   â”‚   â”‚   â”œâ”€â”€ register.js   PB
â”‚   â”‚   â”‚   â”œâ”€â”€ register.json   PB
â”‚   â”‚   â”‚   â”œâ”€â”€ register.wxml   PB
â”‚   â”‚   â”‚   â””â”€â”€ register.wxss   PB
â”‚   â”‚   â”œâ”€â”€ profile/               # ä¸ªäººä¿¡æ¯é¡µé¢ âœ…O
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.js   PB
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.json   PB
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.wxml   PB
â”‚   â”‚   â”‚   â””â”€â”€ profile.wxss   PB
â”‚   â”‚   â”œâ”€â”€ dormitory/             # å®¿èˆç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ buildings/         # æ¥¼æ ‹ç®¡ç† âœ…O
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ buildings.js   PB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ buildings.json    B
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ buildings.wxml   PB
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ buildings.wxss    B
â”‚   â”‚   â”‚   â””â”€â”€ rooms/             # æˆ¿é—´ç®¡ç† âœ…O
â”‚   â”‚   â”‚       â”œâ”€â”€ rooms.js   PB
â”‚   â”‚   â”‚       â”œâ”€â”€ rooms.json   B
â”‚   â”‚   â”‚       â”œâ”€â”€ rooms.wxml    B
â”‚   â”‚   â”‚       â””â”€â”€ rooms.wxss    B
â”‚   â”‚   â”œâ”€â”€ repair/                # æŠ¥ä¿®ç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ list/              # æŠ¥ä¿®åˆ—è¡¨ âœ…O
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ list.js    PB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ list.json   PB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ list.wxml   PB
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ list.wxss   PB
â”‚   â”‚   â”‚   â””â”€â”€ submit/            # æäº¤æŠ¥ä¿® âœ…O
â”‚   â”‚   â”‚       â”œâ”€â”€ submit.js   P B
â”‚   â”‚   â”‚       â”œâ”€â”€ submit.json   B
â”‚   â”‚   â”‚       â”œâ”€â”€ submit.wxml   PB
â”‚   â”‚   â”‚       â””â”€â”€ submit.wxss  B
â”‚   â”‚   â”œâ”€â”€ visitor/               # è®¿å®¢ç®¡ç†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ register/          # è®¿å®¢ç™»è®° âœ…O
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ register.js   PB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ register.json   PB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ register.wxml   PB
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ register.wxss   PB
â”‚   â”‚   â”‚   â””â”€â”€ list/              # è®¿å®¢è®°å½• âœ…O
â”‚   â”‚   â”‚       â”œâ”€â”€ list.js   B
â”‚   â”‚   â”‚       â”œâ”€â”€ list.json   B
â”‚   â”‚   â”‚       â”œâ”€â”€ list.wxml   B
â”‚   â”‚   â”‚       â””â”€â”€ list.wxss   B
â”‚   â”‚   â”œâ”€â”€ hygiene/               # å«ç”Ÿæ£€æŸ¥æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ check/             # å«ç”Ÿæ£€æŸ¥ âœ…O
â”‚   â”‚   â”‚       â”œâ”€â”€ check.js   PB
â”‚   â”‚   â”‚       â”œâ”€â”€ check.json   B
â”‚   â”‚   â”‚       â”œâ”€â”€ check.wxml   PB
â”‚   â”‚   â”‚       â””â”€â”€ check.wxss   B
â”‚   â”‚   â””â”€â”€ notice/                # å…¬å‘Šé€šçŸ¥æ¨¡å—O
â”‚   â”‚         â””â”€â”€ list/              # å…¬å‘Šåˆ—è¡¨ âœ…
â”‚   â”‚            â”œâ”€â”€ list.js   PPB
â”‚   â”‚            â”œâ”€â”€ list.json  PB
â”‚   â”‚            â”œâ”€â”€ list.wxml   PB
â”‚   â”‚            â””â”€â”€ list.wxss   P B      
â””â”€â”€ server/                        # Node.jsåç«¯
    â”œâ”€â”€ package.json               # é¡¹ç›®ä¾èµ– âœ…KOPAB
    â”œâ”€â”€ app.js                     # Expressåº”ç”¨ä¸»æ–‡ä»¶ âœ…OPAB
    â”œâ”€â”€ server.js                  # æœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶ âœ…KOPAB
    â”œâ”€â”€ .env                       # ç¯å¢ƒå˜é‡é…ç½® âœ…KPAB
    â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶ç›®å½•O
    â”‚   â””â”€â”€ database.js            # æ•°æ®åº“é…ç½® âœ…KOPAB
    â”œâ”€â”€ middleware/                # ä¸­é—´ä»¶ç›®å½•
    â”‚   â””â”€â”€ auth.js                # è®¤è¯ä¸­é—´ä»¶ âœ…KOPAB
    â”œâ”€â”€ routes/                    # è·¯ç”±æ–‡ä»¶ç›®å½•
    â”‚   â”œâ”€â”€ auth.js                # è®¤è¯è·¯ç”± âœ…KOPAB
    â”‚   â”œâ”€â”€ users.js               # ç”¨æˆ·è·¯ç”± âœ…KOPAB
    â”‚   â”œâ”€â”€ dormitory.js           # å®¿èˆè·¯ç”± âœ…KOPAB
    â”‚   â”œâ”€â”€ students.js            # å­¦ç”Ÿè·¯ç”± âœ…KOPAB
    â”‚   â”œâ”€â”€ repairs.js             # æŠ¥ä¿®è·¯ç”± âœ…KOPAB
    â”‚   â”œâ”€â”€ hygiene.js             # å«ç”Ÿæ£€æŸ¥è·¯ç”± âœ…OPAB
    â”‚   â”œâ”€â”€ visitors.js            # è®¿å®¢è·¯ç”± âœ…OPAB
    â”‚   â””â”€â”€ notices.js             # å…¬å‘Šè·¯ç”± âœ…OPAB
    â””â”€â”€ utils/                     # å·¥å…·å‡½æ•°ç›®å½•
        â””â”€â”€ jwt.js                 # JWTå·¥å…·å‡½æ•° âœ…KOPAB




-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS dormitory_system DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_unicode_ci;
USE dormitory_system;

-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    role ENUM('admin', 'student', 'staff') DEFAULT 'student',
    real_name VARCHAR(50),
    student_id VARCHAR(20) UNIQUE,
    building_id INT,
    room_id INT,
    avatar_url VARCHAR(255),
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_role (role)
);

-- æ¥¼æ ‹è¡¨
CREATE TABLE buildings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    building_name VARCHAR(50) NOT NULL,
    building_code VARCHAR(20) UNIQUE NOT NULL,
    floors INT DEFAULT 6,
    rooms_per_floor INT DEFAULT 20,
    total_rooms INT DEFAULT 120,
    occupied_rooms INT DEFAULT 0,
    available_rooms INT DEFAULT 120,
    manager_id INT,
    description TEXT,
    status ENUM('active', 'maintenance', 'closed') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_building_code (building_code)
);

-- æˆ¿é—´è¡¨
CREATE TABLE rooms (
    id INT PRIMARY KEY AUTO_INCREMENT,
    building_id INT NOT NULL,
    room_number VARCHAR(20) NOT NULL,
    floor INT NOT NULL,
    capacity INT DEFAULT 4,
    current_occupancy INT DEFAULT 0,
    room_type ENUM('standard', 'premium', 'suite') DEFAULT 'standard',
    facilities JSON,
    monthly_fee DECIMAL(10, 2) DEFAULT 0,
    status ENUM('available', 'occupied', 'maintenance', 'reserved') DEFAULT 'available',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_room (building_id, room_number),
    INDEX idx_building_floor (building_id, floor),
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE
);

-- æŠ¥ä¿®è®°å½•è¡¨
CREATE TABLE repairs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    repair_number VARCHAR(50) UNIQUE NOT NULL,
    student_id INT NOT NULL,
    building_id INT NOT NULL,
    room_id INT NOT NULL,
    repair_type ENUM('electricity', 'plumbing', 'furniture', 'air_conditioner', 'other') NOT NULL,
    description TEXT NOT NULL,
    images JSON,
    status ENUM('pending', 'processing', 'completed', 'cancelled') DEFAULT 'pending',
    priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',
    assigned_staff_id INT,
    completed_at TIMESTAMP NULL,
    feedback TEXT,
    rating INT CHECK (rating >= 1 AND rating <= 5),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_student (student_id),
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE
);

-- è®¿å®¢è®°å½•è¡¨
CREATE TABLE visitors (
    id INT PRIMARY KEY AUTO_INCREMENT,
    student_id INT NOT NULL,
    visitor_name VARCHAR(50) NOT NULL,
    visitor_phone VARCHAR(20) NOT NULL,
    visitor_id_card VARCHAR(50),
    relationship ENUM('family', 'friend', 'relative', 'other') DEFAULT 'friend',
    visit_reason TEXT,
    building_id INT NOT NULL,
    room_id INT NOT NULL,
    expected_arrival TIMESTAMP NOT NULL,
    expected_leave TIMESTAMP,
    actual_arrival TIMESTAMP NULL,
    actual_leave TIMESTAMP NULL,
    status ENUM('pending', 'arrived', 'left', 'cancelled') DEFAULT 'pending',
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_student (student_id),
    INDEX idx_status (status),
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE
);

-- å«ç”Ÿæ£€æŸ¥è¡¨
CREATE TABLE hygiene_checks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    check_number VARCHAR(50) UNIQUE NOT NULL,
    building_id INT NOT NULL,
    floor INT NOT NULL,
    checker_id INT NOT NULL,
    check_date DATE NOT NULL,
    room_scores JSON,
    total_score DECIMAL(5, 2),
    average_score DECIMAL(5, 2),
    comments TEXT,
    passed_rooms INT DEFAULT 0,
    failed_rooms INT DEFAULT 0,
    status ENUM('draft', 'completed', 'published') DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_check_date (check_date),
    INDEX idx_building (building_id),
    FOREIGN KEY (building_id) REFERENCES buildings(id) ON DELETE CASCADE,
    FOREIGN KEY (checker_id) REFERENCES users(id) ON DELETE CASCADE
);

-- å…¬å‘Šè¡¨
CREATE TABLE notices (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    publisher_id INT NOT NULL,
    notice_type ENUM('system', 'maintenance', 'activity', 'emergency', 'other') DEFAULT 'system',
    target_roles JSON,
    target_buildings JSON,
    is_top BOOLEAN DEFAULT FALSE,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    status ENUM('draft', 'published', 'expired') DEFAULT 'draft',
    view_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_type (notice_type),
    FOREIGN KEY (publisher_id) REFERENCES users(id) ON DELETE CASCADE
);

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO buildings (building_name, building_code, floors, rooms_per_floor, total_rooms, available_rooms) VALUES
('Aæ ‹å®¿èˆæ¥¼', 'A001', 6, 20, 120, 120),
('Bæ ‹å®¿èˆæ¥¼', 'B001', 6, 20, 120, 120),
('Cæ ‹å®¿èˆæ¥¼', 'C001', 8, 25, 200, 200);

INSERT INTO rooms (building_id, room_number, floor, capacity, room_type, monthly_fee) VALUES
(1, '101', 1, 4, 'standard', 1200.00),
(1, '102', 1, 4, 'standard', 1200.00),
(1, '201', 2, 4, 'standard', 1200.00),
(1, '202', 2, 4, 'standard', 1200.00),
(1, '301', 3, 4, 'premium', 1500.00),
(2, '101', 1, 6, 'standard', 1000.00),
(2, '102', 1, 6, 'standard', 1000.00),
(3, '101', 1, 4, 'suite', 2000.00),
(3, '102', 1, 4, 'suite', 2000.00);

-- åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå¯†ç ï¼šadmin123ï¼‰
INSERT INTO users (username, password, email, role, real_name, status) VALUES
('admin', '$2b$10$7znq0N3zqk3l5k5l5k5l5u', 'admin@dorm.com', 'admin', 'ç³»ç»Ÿç®¡ç†å‘˜', 'active');

-- åˆ›å»ºæµ‹è¯•å­¦ç”Ÿç”¨æˆ·ï¼ˆå¯†ç ï¼šstudent123ï¼‰
INSERT INTO users (username, password, email, role, real_name, student_id, building_id, room_id, status) VALUES
('student001', '$2b$10$7znq0N3zqk3l5k5l5k5l5v', 'student001@school.com', 'student', 'å¼ ä¸‰', '20230001', 1, 1, 'active'),
('student002', '$2b$10$7znq0N3zqk3l5k5l5k5l5w', 'student002@school.com', 'student', 'æå››', '20230002', 1, 2, 'active');







// pages/dormitory/buildings/buildings.js
const app = getApp()

Page({
  data: {
    buildings: [],
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20,
    total: 0,
    filters: {
      keyword: '',
      status: ''
    },
    userRole: '',
    showFilter: false
  },

  onLoad() {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/dormitory/buildings/buildings')
      })
      return
    }

    const userInfo = app.getUserInfo()
    if (!app.checkPermission(['admin', 'staff'])) {
      app.showPermissionError()
      wx.navigateBack()
      return
    }

    this.setData({
      userRole: userInfo.role
    })

    this.loadBuildings()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      buildings: [],
      hasMore: true
    })
    this.loadBuildings()
  },

  // åŠ è½½æ¥¼æ ‹åˆ—è¡¨
  async loadBuildings(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        buildings: [],
        loading: true
      })
    }

    try {
      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      const res = await app.request('/dormitory/buildings', 'GET', params)

      const newBuildings = loadMore ? 
        [...this.data.buildings, ...res.data.list] : 
        res.data.list

      this.setData({
        buildings: newBuildings,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // æœç´¢è¾“å…¥
  onSearchInput(e) {
    this.setData({
      'filters.keyword': e.detail.value
    })
  },

  // æ‰§è¡Œæœç´¢
  onSearch() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadBuildings()
  },

  // çŠ¶æ€ç­›é€‰
  onStatusChange(e) {
    this.setData({
      'filters.status': e.detail.value
    })
    this.onSearch()
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    this.setData({
      showFilter: !this.data.showFilter
    })
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadBuildings(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadBuildings().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹æ¥¼æ ‹è¯¦æƒ…
  viewBuildingDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/building-detail/building-detail?id=${id}`
    })
  },

  // ç¼–è¾‘æ¥¼æ ‹
  editBuilding(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/building-edit/building-edit?id=${id}`
    })
  },

  // åˆ é™¤æ¥¼æ ‹
  async deleteBuilding(e) {
    const { id, name } = e.currentTarget.dataset

    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: `ç¡®å®šè¦åˆ é™¤æ¥¼æ ‹"${name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      confirmColor: '#fa541c',
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/dormitory/buildings/${id}`, 'DELETE')
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadBuildings()

          } catch (error) {
            console.error('åˆ é™¤æ¥¼æ ‹å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // æ·»åŠ æ–°æ¥¼æ ‹
  addBuilding() {
    wx.navigateTo({
      url: '/pages/dormitory/building-edit/building-edit'
    })
  },

  // æŸ¥çœ‹æ¥¼æ ‹ç»Ÿè®¡
  viewBuildingStats(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/building-stats/building-stats?id=${id}`
    })
  },

  // ç®¡ç†æˆ¿é—´
  manageRooms(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/rooms/rooms?building_id=${id}`
    })
  }
})




{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "æ¥¼æ ‹ç®¡ç†"
}



<!--pages/dormitory/buildings/buildings.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="æœç´¢æ¥¼æ ‹åç§°æˆ–ç¼–å·"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <view class="filter-item">
      <view class="filter-label">çŠ¶æ€</view>
      <picker
        range="{{['å…¨éƒ¨', 'active', 'maintenance', 'closed']}}"
        range-key="{{['å…¨éƒ¨', 'ä½¿ç”¨ä¸­', 'ç»´æŠ¤ä¸­', 'å·²å…³é—­']}}"
        value="{{filters.status ? ['active', 'maintenance', 'closed'].indexOf(filters.status) + 1 : 0}}"
        bindchange="onStatusChange"
      >
        <view class="filter-value">
          {{filters.status === 'active' ? 'ä½¿ç”¨ä¸­' : filters.status === 'maintenance' ? 'ç»´æŠ¤ä¸­' : filters.status === 'closed' ? 'å·²å…³é—­' : 'å…¨éƒ¨'}}
        </view>
      </picker>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{userRole === 'admin'}}">
    <button class="btn-primary" bindtap="addBuilding">æ·»åŠ æ¥¼æ ‹</button>
  </view>

  <!-- æ¥¼æ ‹åˆ—è¡¨ -->
  <view class="building-list">
    <block wx:for="{{buildings}}" wx:key="id">
      <view class="building-item card">
        <view class="building-header">
          <view class="building-title">
            <text class="building-name">{{item.building_name}}</text>
            <text class="building-code">({{item.building_code}})</text>
          </view>
          <view class="building-status {{item.status}}">
            {{item.status === 'active' ? 'ä½¿ç”¨ä¸­' : item.status === 'maintenance' ? 'ç»´æŠ¤ä¸­' : 'å·²å…³é—­'}}
          </view>
        </view>

        <view class="building-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æ¥¼å±‚æ•°ï¼š</text>
              <text class="info-value">{{item.floors}}å±‚</text>
            </view>
            <view class="info-item">
              <text class="info-label">æ€»æˆ¿é—´æ•°ï¼š</text>
              <text class="info-value">{{item.total_rooms}}é—´</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">å·²å…¥ä½ï¼š</text>
              <text class="info-value">{{item.occupied_rooms}}é—´</text>
            </view>
            <view class="info-item">
              <text class="info-label">å¯ç”¨ï¼š</text>
              <text class="info-value">{{item.available_rooms}}é—´</text>
            </view>
          </view>
        </view>

        <view class="building-actions">
          <view 
            class="action-btn" 
            bindtap="viewBuildingDetail"
            data-id="{{item.id}}"
          >
            è¯¦æƒ…
          </view>
          <view 
            class="action-btn" 
            bindtap="manageRooms"
            data-id="{{item.id}}"
          >
            æˆ¿é—´ç®¡ç†
          </view>
          <view 
            class="action-btn" 
            bindtap="viewBuildingStats"
            data-id="{{item.id}}"
          >
            ç»Ÿè®¡
          </view>
          <view 
            class="action-btn" 
            wx:if="{{userRole === 'admin'}}"
            bindtap="editBuilding"
            data-id="{{item.id}}"
          >
            ç¼–è¾‘
          </view>
          <view 
            class="action-btn delete" 
            wx:if="{{userRole === 'admin'}}"
            bindtap="deleteBuilding"
            data-id="{{item.id}}"
            data-name="{{item.building_name}}"
          >
            åˆ é™¤
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && buildings.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && buildings.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— æ¥¼æ ‹æ•°æ®</view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && buildings.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && buildings.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/dormitory/buildings/buildings.wxss */

.search-bar {
  display: flex;
  align-items: center;
  gap: 20rpx;
  margin-bottom: 30rpx;
}

.search-input {
  flex: 1;
  position: relative;
}

.search-input input {
  width: 100%;
  height: 80rpx;
  background: #fff;
  border: 2rpx solid #e8e8e8;
  border-radius: 40rpx;
  padding: 0 80rpx 0 30rpx;
  font-size: 28rpx;
  box-sizing: border-box;
}

.search-icon {
  position: absolute;
  right: 30rpx;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32rpx;
  color: #999;
}

.filter-btn {
  height: 80rpx;
  padding: 0 30rpx;
  background: #fff;
  border: 2rpx solid #e8e8e8;
  border-radius: 40rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28rpx;
  color: #333;
}

.filter-icon {
  margin-left: 10rpx;
  font-size: 20rpx;
}

.filter-panel {
  background: #fff;
  border-radius: 16rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
  box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
}

.filter-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20rpx;
}

.filter-item:last-child {
  margin-bottom: 0;
}

.filter-label {
  font-size: 28rpx;
  color: #333;
}

.filter-value {
  font-size: 28rpx;
  color: #1890ff;
  padding: 10rpx 20rpx;
  border: 2rpx solid #1890ff;
  border-radius: 8rpx;
}

.action-bar {
  margin-bottom: 30rpx;
}

.action-bar .btn-primary {
  height: 80rpx;
  line-height: 80rpx;
  font-size: 28rpx;
}

.building-list {
  margin-bottom: 30rpx;
}

.building-item {
  margin-bottom: 30rpx;
}

.building-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.building-title {
  display: flex;
  align-items: baseline;
}

.building-name {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  margin-right: 20rpx;
}

.building-code {
  font-size: 24rpx;
  color: #666;
  background: #f5f5f5;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.building-status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 16rpx;
}

.building-status.active {
  background: #f6ffed;
  color: #52c41a;
}

.building-status.maintenance {
  background: #fff7e6;
  color: #fa8c16;
}

.building-status.closed {
  background: #f5f5f5;
  color: #999;
}

.building-info {
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-item {
  flex: 1;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.building-actions {
  display: flex;
  gap: 20rpx;
  flex-wrap: wrap;
}

.action-btn {
  padding: 12rpx 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 24rpx;
  color: #333;
  text-align: center;
  min-width: 120rpx;
}

.action-btn:active {
  background: #e8e8e8;
}

.action-btn.delete {
  background: #fff1f0;
  color: #ff4d4f;
}

.action-btn.delete:active {
  background: #ffccc7;
}

.loading-state,
.empty-state {
  text-align: center;
  padding: 100rpx 0;
}

.loading-image,
.empty-image {
  width: 200rpx;
  height: 200rpx;
  margin-bottom: 30rpx;
}

.loading-text,
.empty-text {
  font-size: 28rpx;
  color: #999;
}

.load-more {
  text-align: center;
  padding: 40rpx;
  font-size: 28rpx;
  color: #999;
}

.load-more text:active {
  color: #1890ff;
}



// pages/dormitory/rooms/rooms.js
const app = getApp()

Page({
  data: {
    rooms: [],
    buildings: [],
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20,
    total: 0,
    filters: {
      building_id: '',
      floor: '',
      room_type: '',
      status: '',
      keyword: ''
    },
    userRole: '',
    showFilter: false,
    selectedBuilding: null,
    
    // ä¿®å¤ï¼špickerç»„ä»¶valueå€¼
    buildingIndex: -1,
    floorIndex: -1,
    roomTypeIndex: 0,
    statusIndex: 0,
    
    // ç­›é€‰é€‰é¡¹
    roomTypeOptions: ['å…¨éƒ¨', 'standard', 'premium', 'suite'],
    roomTypeLabels: ['å…¨éƒ¨', 'æ ‡å‡†é—´', 'é«˜çº§é—´', 'å¥—é—´'],
    statusOptions: ['å…¨éƒ¨', 'available', 'occupied', 'maintenance', 'reserved'],
    statusLabels: ['å…¨éƒ¨', 'å¯ç”¨', 'å·²å…¥ä½', 'ç»´ä¿®ä¸­', 'å·²é¢„å®š'],
    floorOptions: [],
    floorLabels: []
  },

  onLoad(options) {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/dormitory/rooms/rooms')
      })
      return
    }

    const userInfo = app.getUserInfo()
    if (!app.checkPermission(['admin', 'staff'])) {
      app.showPermissionError()
      wx.navigateBack()
      return
    }

    this.setData({
      userRole: userInfo.role
    })

    // å¦‚æœæœ‰building_idå‚æ•°ï¼Œè®¾ç½®ä¸ºç­›é€‰æ¡ä»¶
    if (options.building_id) {
      this.setData({
        'filters.building_id': options.building_id
      })
    }

    this.loadBuildings()
    this.loadRooms()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      rooms: [],
      hasMore: true
    })
    this.loadRooms()
  },

  // åŠ è½½æ¥¼æ ‹åˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ï¼‰
  async loadBuildings() {
    try {
      const res = await app.request('/dormitory/buildings', 'GET', {
        page: 1,
        pageSize: 100
      })

      this.setData({
        buildings: res.data.list
      })

      // è®¡ç®—buildingIndex
      this.updateBuildingIndex()
      
      // æ›´æ–°æ¥¼å±‚é€‰é¡¹
      this.updateFloorOptions()

    } catch (error) {
      console.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥:', error)
    }
  },

  // æ›´æ–°buildingIndex
  updateBuildingIndex() {
    let buildingIndex = -1
    if (this.data.filters.building_id && this.data.buildings.length > 0) {
      buildingIndex = this.data.buildings.findIndex(b => b.id == this.data.filters.building_id)
    }
    
    this.setData({
      buildingIndex: buildingIndex
    })

    // å¦‚æœæŒ‡å®šäº†æ¥¼æ ‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¥¼æ ‹ä¿¡æ¯
    if (buildingIndex >= 0) {
      const building = this.data.buildings[buildingIndex]
      this.setData({
        selectedBuilding: building
      })
      // æ›´æ–°æ¥¼å±‚é€‰é¡¹
      this.updateFloorOptions()
    } else {
      this.setData({
        selectedBuilding: null
      })
    }
  },

  // æ›´æ–°æ¥¼å±‚é€‰é¡¹
  updateFloorOptions() {
    if (!this.data.selectedBuilding) {
      this.setData({
        floorOptions: [],
        floorLabels: [],
        floorIndex: -1
      })
      return
    }
    
    // ç”Ÿæˆæ¥¼å±‚é€‰é¡¹ï¼ˆä»1åˆ°æ€»æ¥¼å±‚æ•°ï¼‰
    const floors = this.data.selectedBuilding.floors
    const floorOptions = Array.from({length: floors}, (_, i) => (i + 1).toString())
    const floorLabels = floorOptions.map(f => `${f}å±‚`)
    
    // è®¡ç®—å½“å‰æ¥¼å±‚ç´¢å¼•
    let floorIndex = -1
    if (this.data.filters.floor) {
      floorIndex = floorOptions.indexOf(this.data.filters.floor)
    }
    
    this.setData({
      floorOptions: ['å…¨éƒ¨', ...floorOptions],
      floorLabels: ['å…¨éƒ¨æ¥¼å±‚', ...floorLabels],
      floorIndex: floorIndex + 1 // +1æ˜¯å› ä¸ºç¬¬ä¸€ä¸ªæ˜¯"å…¨éƒ¨"
    })
  },

  // æ›´æ–°å…¶ä»–ç­›é€‰ç´¢å¼•
  updateFilterIndexes() {
    // æ›´æ–°roomTypeIndex
    let roomTypeIndex = 0
    if (this.data.filters.room_type) {
      roomTypeIndex = this.data.roomTypeOptions.indexOf(this.data.filters.room_type)
      if (roomTypeIndex === -1) roomTypeIndex = 0
    }
    
    // æ›´æ–°statusIndex
    let statusIndex = 0
    if (this.data.filters.status) {
      statusIndex = this.data.statusOptions.indexOf(this.data.filters.status)
      if (statusIndex === -1) statusIndex = 0
    }
    
    this.setData({
      roomTypeIndex: roomTypeIndex,
      statusIndex: statusIndex
    })
  },

  // åŠ è½½æˆ¿é—´åˆ—è¡¨
  async loadRooms(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        rooms: [],
        loading: true
      })
    }

    try {
      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      const res = await app.request('/dormitory/rooms', 'GET', params)

      const newRooms = loadMore ? 
        [...this.data.rooms, ...res.data.list] : 
        res.data.list

      this.setData({
        rooms: newRooms,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // æœç´¢è¾“å…¥
  onSearchInput(e) {
    this.setData({
      'filters.keyword': e.detail.value
    })
  },

  // æ‰§è¡Œæœç´¢
  onSearch() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadRooms()
  },

  // æ¥¼æ ‹ç­›é€‰å˜åŒ–
  onBuildingChange(e) {
    const index = parseInt(e.detail.value)
    const buildingId = index >= 0 ? this.data.buildings[index].id : ''
    
    this.setData({
      'filters.building_id': buildingId,
      buildingIndex: index,
      'filters.floor': '' // åˆ‡æ¢æ¥¼æ ‹æ—¶é‡ç½®æ¥¼å±‚
    })

    // æ‰¾åˆ°é€‰ä¸­çš„æ¥¼æ ‹ä¿¡æ¯
    const building = index >= 0 ? this.data.buildings[index] : null
    this.setData({
      selectedBuilding: building
    })
    
    // æ›´æ–°æ¥¼å±‚é€‰é¡¹
    this.updateFloorOptions()
    
    this.onSearch()
  },

  // æ¥¼å±‚ç­›é€‰å˜åŒ–
  onFloorChange(e) {
    const index = parseInt(e.detail.value)
    const floor = index > 0 ? this.data.floorOptions[index] : ''
    
    this.setData({
      'filters.floor': floor,
      floorIndex: index
    })
    
    this.onSearch()
  },

  // æˆ¿é—´ç±»å‹ç­›é€‰å˜åŒ–
  onRoomTypeChange(e) {
    const index = parseInt(e.detail.value)
    const roomType = index > 0 ? this.data.roomTypeOptions[index] : ''
    
    this.setData({
      'filters.room_type': roomType,
      roomTypeIndex: index
    })
    
    this.onSearch()
  },

  // çŠ¶æ€ç­›é€‰å˜åŒ–
  onStatusChange(e) {
    const index = parseInt(e.detail.value)
    const status = index > 0 ? this.data.statusOptions[index] : ''
    
    this.setData({
      'filters.status': status,
      statusIndex: index
    })
    
    this.onSearch()
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    this.setData({
      showFilter: !this.data.showFilter
    })
    
    // æ›´æ–°ç­›é€‰ç´¢å¼•
    if (!this.data.showFilter) {
      this.updateFilterIndexes()
    }
  },

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    this.setData({
      showFilter: false,
      page: 1,
      hasMore: true
    })
    this.loadRooms()
  },

  // é‡ç½®ç­›é€‰
  resetFilters() {
    this.setData({
      filters: {
        building_id: '',
        floor: '',
        room_type: '',
        status: '',
        keyword: ''
      },
      selectedBuilding: null,
      buildingIndex: -1,
      floorIndex: -1,
      roomTypeIndex: 0,
      statusIndex: 0,
      page: 1,
      hasMore: true
    })
    
    // é‡ç½®æ¥¼å±‚é€‰é¡¹
    this.setData({
      floorOptions: [],
      floorLabels: []
    })
    
    this.loadRooms()
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadRooms(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadRooms().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹æˆ¿é—´è¯¦æƒ…
  viewRoomDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/room-detail/room-detail?id=${id}`
    })
  },

  // ç¼–è¾‘æˆ¿é—´
  editRoom(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/room-edit/room-edit?id=${id}`
    })
  },

  // åˆ é™¤æˆ¿é—´
  async deleteRoom(e) {
    const { id, number } = e.currentTarget.dataset

    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: `ç¡®å®šè¦åˆ é™¤æˆ¿é—´"${number}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      confirmColor: '#fa541c',
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/dormitory/rooms/${id}`, 'DELETE')
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadRooms()

          } catch (error) {
            console.error('åˆ é™¤æˆ¿é—´å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // æ·»åŠ æ–°æˆ¿é—´
  addRoom() {
    wx.navigateTo({
      url: '/pages/dormitory/room-edit/room-edit'
    })
  },

  // åˆ†é…æˆ¿é—´ç»™ç”¨æˆ·
  assignRoom(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/dormitory/room-assign/room-assign?id=${id}`
    })
  },

  // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
  formatStatus(status) {
    const statusMap = {
      'available': 'å¯ç”¨',
      'occupied': 'å·²å…¥ä½',
      'maintenance': 'ç»´ä¿®ä¸­',
      'reserved': 'å·²é¢„å®š'
    }
    return statusMap[status] || status
  },

  // æ ¼å¼åŒ–æˆ¿é—´ç±»å‹æ˜¾ç¤º
  formatRoomType(type) {
    const typeMap = {
      'standard': 'æ ‡å‡†é—´',
      'premium': 'é«˜çº§é—´',
      'suite': 'å¥—é—´'
    }
    return typeMap[type] || type
  },

  // è·å–å½“å‰æ¥¼å±‚æ˜¾ç¤ºæ–‡æœ¬
  getFloorDisplayText() {
    if (!this.data.filters.floor) {
      return 'å…¨éƒ¨æ¥¼å±‚'
    }
    return `${this.data.filters.floor}å±‚`
  },

  // è·å–æˆ¿é—´ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
  getRoomTypeDisplayText() {
    const { filters, roomTypeLabels, roomTypeIndex } = this.data
    if (!filters.room_type) {
      return 'å…¨éƒ¨'
    }
    return roomTypeLabels[roomTypeIndex] || 'å…¨éƒ¨'
  },

  // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
  getStatusDisplayText() {
    const { filters, statusLabels, statusIndex } = this.data
    if (!filters.status) {
      return 'å…¨éƒ¨'
    }
    return statusLabels[statusIndex] || 'å…¨éƒ¨'
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "æˆ¿é—´ç®¡ç†"
}



<!--pages/dormitory/rooms/rooms.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="æœç´¢æˆ¿é—´å·"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <view class="filter-item">
      <view class="filter-label">æ¥¼æ ‹</view>
      <picker
        range="{{buildings}}"
        range-key="building_name"
        value="{{buildingIndex}}"
        bindchange="onBuildingChange"
      >
        <view class="filter-value">
          {{selectedBuilding ? selectedBuilding.building_name : 'å…¨éƒ¨æ¥¼æ ‹'}}
        </view>
      </picker>
    </view>

    <view class="filter-item" wx:if="{{selectedBuilding}}">
      <view class="filter-label">æ¥¼å±‚</view>
      <picker
        range="{{floorOptions}}"
        range-key="{{floorLabels}}"
        value="{{floorIndex}}"
        bindchange="onFloorChange"
      >
        <view class="filter-value">
          {{getFloorDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">æˆ¿é—´ç±»å‹</view>
      <picker
        range="{{roomTypeOptions}}"
        range-key="{{roomTypeLabels}}"
        value="{{roomTypeIndex}}"
        bindchange="onRoomTypeChange"
      >
        <view class="filter-value">
          {{getRoomTypeDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">çŠ¶æ€</view>
      <picker
        range="{{statusOptions}}"
        range-key="{{statusLabels}}"
        value="{{statusIndex}}"
        bindchange="onStatusChange"
      >
        <view class="filter-value">
          {{getStatusDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-actions">
      <view class="filter-action-btn" bindtap="resetFilters">é‡ç½®</view>
      <view class="filter-action-btn primary" bindtap="applyFilters">åº”ç”¨</view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{userRole === 'admin'}}">
    <button class="btn-primary" bindtap="addRoom">æ·»åŠ æˆ¿é—´</button>
  </view>

  <!-- æˆ¿é—´åˆ—è¡¨ -->
  <view class="room-list">
    <block wx:for="{{rooms}}" wx:key="id">
      <view class="room-item card">
        <view class="room-header">
          <view class="room-title">
            <text class="room-name">{{item.building_name}}</text>
            <text class="room-number">{{item.room_number}}</text>
          </view>
          <view class="room-status {{item.status}}">
            {{formatStatus(item.status)}}
          </view>
        </view>

        <view class="room-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æ¥¼å±‚ï¼š</text>
              <text class="info-value">{{item.floor}}å±‚</text>
            </view>
            <view class="info-item">
              <text class="info-label">ç±»å‹ï¼š</text>
              <text class="info-value">{{formatRoomType(item.room_type)}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">å®¹é‡ï¼š</text>
              <text class="info-value">{{item.capacity}}äºº</text>
            </view>
            <view class="info-item">
              <text class="info-label">å·²ä½ï¼š</text>
              <text class="info-value">{{item.current_occupancy}}äºº</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æœˆè´¹ï¼š</text>
              <text class="info-value">Â¥{{item.monthly_fee}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">å…¥ä½è€…ï¼š</text>
              <text class="info-value">{{item.occupants || 'æ— '}}</text>
            </view>
          </view>
        </view>

        <view class="room-actions">
          <view 
            class="action-btn" 
            bindtap="viewRoomDetail"
            data-id="{{item.id}}"
          >
            è¯¦æƒ…
          </view>
          <view 
            class="action-btn" 
            wx:if="{{item.status === 'available' && userRole === 'admin'}}"
            bindtap="assignRoom"
            data-id="{{item.id}}"
          >
            åˆ†é…
          </view>
          <view 
            class="action-btn" 
            wx:if="{{userRole === 'admin'}}"
            bindtap="editRoom"
            data-id="{{item.id}}"
          >
            ç¼–è¾‘
          </view>
          <view 
            class="action-btn delete" 
            wx:if="{{userRole === 'admin' && item.current_occupancy === 0}}"
            bindtap="deleteRoom"
            data-id="{{item.id}}"
            data-number="{{item.room_number}}"
          >
            åˆ é™¤
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && rooms.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && rooms.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— æˆ¿é—´æ•°æ®</view>
    <view class="empty-action" bindtap="addRoom" wx:if="{{userRole === 'admin'}}">
      æ·»åŠ æˆ¿é—´
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && rooms.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && rooms.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/dormitory/rooms/rooms.wxss */

.filter-actions {
  display: flex;
  gap: 30rpx;
  margin-top: 40rpx;
}

.filter-action-btn {
  flex: 1;
  text-align: center;
  padding: 20rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
}

.filter-action-btn.primary {
  background: #1890ff;
  color: #fff;
}

.room-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.room-title {
  display: flex;
  align-items: baseline;
  flex-wrap: wrap;
}

.room-name {
  font-size: 28rpx;
  color: #666;
  margin-right: 20rpx;
}

.room-number {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
}

.room-status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 16rpx;
}

.room-status.available {
  background: #f6ffed;
  color: #52c41a;
}

.room-status.occupied {
  background: #e6f7ff;
  color: #1890ff;
}

.room-status.maintenance {
  background: #fff7e6;
  color: #fa8c16;
}

.room-status.reserved {
  background: #f9f0ff;
  color: #722ed1;
}

.room-info {
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-item {
  flex: 1;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.room-actions {
  display: flex;
  gap: 20rpx;
  flex-wrap: wrap;
}

.action-btn {
  padding: 12rpx 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 24rpx;
  color: #333;
  text-align: center;
  min-width: 120rpx;
}

.action-btn:active {
  background: #e8e8e8;
}

.action-btn.delete {
  background: #fff1f0;
  color: #ff4d4f;
}

.action-btn.delete:active {
  background: #ffccc7;
}



// pages/hygiene/check/check.js
const app = getApp()

Page({
  data: {
    checks: [], // å«ç”Ÿæ£€æŸ¥åˆ—è¡¨
    buildings: [], // æ¥¼æ ‹åˆ—è¡¨
    loading: false, // åŠ è½½çŠ¶æ€
    hasMore: true, // æ˜¯å¦æœ‰æ›´å¤šæ•°æ®
    page: 1, // å½“å‰é¡µç 
    pageSize: 20, // æ¯é¡µæ•°é‡
    total: 0, // æ€»æ•°
    userRole: '', // ç”¨æˆ·è§’è‰²
    showFilter: false, // æ˜¯å¦æ˜¾ç¤ºç­›é€‰é¢æ¿
    
    // ç­›é€‰æ¡ä»¶
    filters: {
      building_id: '',
      status: '',
      start_date: '',
      end_date: ''
    },
    
    // Pickerç´¢å¼•å€¼ï¼ˆä¿®å¤WXMLé”™è¯¯çš„å…³é”®ï¼‰
    buildingIndex: -1, // æ¥¼æ ‹ç­›é€‰ç´¢å¼•
    statusIndex: 0, // çŠ¶æ€ç­›é€‰ç´¢å¼•
    
    // ç­›é€‰é€‰é¡¹
    statusOptions: ['å…¨éƒ¨', 'draft', 'completed', 'published'],
    statusLabels: ['å…¨éƒ¨', 'æœªå®Œæˆ', 'å·²å®Œæˆ', 'å·²å‘å¸ƒ'],
    
    // å…¶ä»–æ•°æ®
    selectedBuilding: null,
    today: ''
  },

  onLoad() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/hygiene/check/check')
      })
      return
    }

    const userInfo = app.getUserInfo()
    // åªæœ‰ç®¡ç†å‘˜å’Œå®¿ç®¡å¯ä»¥æŸ¥çœ‹å«ç”Ÿæ£€æŸ¥
    if (!app.checkPermission(['admin', 'staff'])) {
      app.showPermissionError()
      wx.navigateBack()
      return
    }

    this.setData({
      userRole: userInfo.role,
      today: this.getTodayDate()
    })

    this.loadBuildings()
    this.loadHygieneChecks()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      checks: [],
      hasMore: true
    })
    this.loadHygieneChecks()
  },

  // è·å–ä»Šå¤©æ—¥æœŸ
  getTodayDate() {
    const now = new Date()
    const year = now.getFullYear()
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const day = String(now.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  },

  // åŠ è½½æ¥¼æ ‹åˆ—è¡¨
  async loadBuildings() {
    try {
      const res = await app.request('/dormitory/buildings', 'GET', {
        page: 1,
        pageSize: 100,
        status: 'active'
      })

      this.setData({
        buildings: res.data.list
      })

      // æ›´æ–°æ¥¼æ ‹ç´¢å¼•
      this.updateBuildingIndex()

    } catch (error) {
      console.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥',
        icon: 'none'
      })
    }
  },

  // æ›´æ–°æ¥¼æ ‹ç­›é€‰ç´¢å¼•
  updateBuildingIndex() {
    let buildingIndex = -1
    if (this.data.filters.building_id && this.data.buildings.length > 0) {
      buildingIndex = this.data.buildings.findIndex(b => b.id == this.data.filters.building_id)
    }
    
    this.setData({
      buildingIndex: buildingIndex
    })

    // æ›´æ–°é€‰ä¸­çš„æ¥¼æ ‹ä¿¡æ¯
    if (buildingIndex >= 0) {
      const building = this.data.buildings[buildingIndex]
      this.setData({
        selectedBuilding: building
      })
    } else {
      this.setData({
        selectedBuilding: null
      })
    }
  },

  // æ›´æ–°çŠ¶æ€ç­›é€‰ç´¢å¼•
  updateStatusIndex() {
    let statusIndex = 0
    if (this.data.filters.status) {
      statusIndex = this.data.statusOptions.indexOf(this.data.filters.status)
      if (statusIndex === -1) statusIndex = 0
    }
    
    this.setData({
      statusIndex: statusIndex
    })
  },

  // åŠ è½½å«ç”Ÿæ£€æŸ¥è®°å½•
  async loadHygieneChecks(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        checks: [],
        loading: true
      })
    }

    try {
      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      const res = await app.request('/hygiene/checks', 'GET', params)

      const newChecks = loadMore ? 
        [...this.data.checks, ...res.data.list] : 
        res.data.list

      this.setData({
        checks: newChecks,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½å«ç”Ÿæ£€æŸ¥è®°å½•å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // æœç´¢è¾“å…¥
  onSearchInput(e) {
    this.setData({
      'filters.keyword': e.detail.value
    })
  },

  // æ‰§è¡Œæœç´¢
  onSearch() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadHygieneChecks()
  },

  // æ¥¼æ ‹ç­›é€‰å˜åŒ–
  onBuildingChange(e) {
    const index = parseInt(e.detail.value)
    const buildingId = index >= 0 ? this.data.buildings[index].id : ''
    
    this.setData({
      'filters.building_id': buildingId,
      buildingIndex: index
    })

    // æ‰¾åˆ°é€‰ä¸­çš„æ¥¼æ ‹ä¿¡æ¯
    const building = index >= 0 ? this.data.buildings[index] : null
    this.setData({
      selectedBuilding: building
    })
    
    this.onSearch()
  },

  // çŠ¶æ€ç­›é€‰å˜åŒ–
  onStatusChange(e) {
    const index = parseInt(e.detail.value)
    const status = index > 0 ? this.data.statusOptions[index] : ''
    
    this.setData({
      'filters.status': status,
      statusIndex: index
    })
    
    this.onSearch()
  },

  // æ—¥æœŸç­›é€‰å˜åŒ–
  onDateChange(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`filters.${field}`]: e.detail.value
    })
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    // æ˜¾ç¤ºç­›é€‰é¢æ¿å‰æ›´æ–°ç´¢å¼•å€¼
    if (!this.data.showFilter) {
      this.updateBuildingIndex()
      this.updateStatusIndex()
    }
    
    this.setData({
      showFilter: !this.data.showFilter
    })
  },

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    this.setData({
      showFilter: false,
      page: 1,
      hasMore: true
    })
    this.loadHygieneChecks()
  },

  // é‡ç½®ç­›é€‰
  resetFilters() {
    this.setData({
      filters: {
        building_id: '',
        status: '',
        start_date: '',
        end_date: ''
      },
      buildingIndex: -1,
      statusIndex: 0,
      selectedBuilding: null,
      page: 1,
      hasMore: true
    })
    
    this.loadHygieneChecks()
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadHygieneChecks(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadHygieneChecks().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹æ£€æŸ¥è¯¦æƒ…
  viewCheckDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/hygiene/detail/detail?id=${id}`
    })
  },

  // åˆ›å»ºæ–°çš„å«ç”Ÿæ£€æŸ¥
  createNewCheck() {
    wx.navigateTo({
      url: '/pages/hygiene/create/create'
    })
  },

  // ç¼–è¾‘æ£€æŸ¥è®°å½•
  editCheck(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/hygiene/edit/edit?id=${id}`
    })
  },

  // åˆ é™¤æ£€æŸ¥è®°å½•
  async deleteCheck(e) {
    const { id, number } = e.currentTarget.dataset

    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: `ç¡®å®šè¦åˆ é™¤å«ç”Ÿæ£€æŸ¥è®°å½•"${number}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      confirmColor: '#fa541c',
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/hygiene/checks/${id}`, 'DELETE')
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadHygieneChecks()

          } catch (error) {
            console.error('åˆ é™¤å«ç”Ÿæ£€æŸ¥è®°å½•å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // å‘å¸ƒæ£€æŸ¥ç»“æœ
  async publishCheck(e) {
    const { id, index } = e.currentTarget.dataset
    const check = this.data.checks[index]

    wx.showModal({
      title: 'å‘å¸ƒæ£€æŸ¥ç»“æœ',
      content: `ç¡®å®šè¦å‘å¸ƒ"${check.check_number}"çš„æ£€æŸ¥ç»“æœå—ï¼Ÿå‘å¸ƒåå­¦ç”Ÿå°†å¯è§ã€‚`,
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/hygiene/checks/${id}/publish`, 'POST')

            wx.showToast({
              title: 'å‘å¸ƒæˆåŠŸ',
              icon: 'success'
            })

            // æ›´æ–°æœ¬åœ°æ•°æ®
            const checks = [...this.data.checks]
            checks[index].status = 'published'
            this.setData({ checks })

          } catch (error) {
            console.error('å‘å¸ƒæ£€æŸ¥ç»“æœå¤±è´¥:', error)
          }
        }
      }
    })
  },

  // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
  formatStatus(status) {
    const statusMap = {
      'draft': 'æœªå®Œæˆ',
      'completed': 'å·²å®Œæˆ',
      'published': 'å·²å‘å¸ƒ'
    }
    return statusMap[status] || status
  },

  // è·å–çŠ¶æ€æ ‡ç­¾çš„ç±»å
  getStatusClass(status) {
    return `status-${status}`
  },

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(dateStr) {
    if (!dateStr) return ''
    const date = new Date(dateStr)
    const month = date.getMonth() + 1
    const day = date.getDate()
    return `${month}æœˆ${day}æ—¥`
  },

  // æ ¼å¼åŒ–åˆ†æ•°æ˜¾ç¤º
  formatScore(score) {
    if (score === null || score === undefined) return '--'
    return score.toFixed(1)
  },

  // è·å–æ¥¼æ ‹æ˜¾ç¤ºæ–‡æœ¬
  getBuildingDisplayText() {
    if (this.data.buildingIndex >= 0) {
      return this.data.buildings[this.data.buildingIndex].building_name
    }
    return 'å…¨éƒ¨æ¥¼æ ‹'
  },

  // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
  getStatusDisplayText() {
    return this.data.statusLabels[this.data.statusIndex]
  },

  // åˆ¤æ–­æ˜¯å¦å¯æ“ä½œ
  canOperate(check) {
    if (this.data.userRole === 'admin') {
      return true
    }
    // å®¿ç®¡åªèƒ½æ“ä½œè‡ªå·±æ¥¼æ ‹çš„æ£€æŸ¥
    if (this.data.userRole === 'staff') {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ£€æŸ¥æ˜¯å¦å±äºå®¿ç®¡ç®¡ç†çš„æ¥¼æ ‹çš„é€»è¾‘
      return true
    }
    return false
  },

  // åˆ¤æ–­æ˜¯å¦å¯ç¼–è¾‘ï¼ˆä»…è‰ç¨¿çŠ¶æ€å¯ç¼–è¾‘ï¼‰
  canEdit(check) {
    return check.status === 'draft' && this.canOperate(check)
  },

  // åˆ¤æ–­æ˜¯å¦å¯åˆ é™¤ï¼ˆä»…è‰ç¨¿çŠ¶æ€å¯åˆ é™¤ï¼‰
  canDelete(check) {
    return check.status === 'draft' && this.data.userRole === 'admin'
  },

  // åˆ¤æ–­æ˜¯å¦å¯å‘å¸ƒï¼ˆä»…å®ŒæˆçŠ¶æ€å¯å‘å¸ƒï¼‰
  canPublish(check) {
    return check.status === 'completed' && this.canOperate(check)
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "å«ç”Ÿæ£€æŸ¥"
}



<!--pages/hygiene/check/check.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="æœç´¢æ£€æŸ¥ç¼–å·"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <view class="filter-item">
      <view class="filter-label">æ¥¼æ ‹</view>
      <picker
        range="{{buildings}}"
        range-key="building_name"
        value="{{buildingIndex}}"
        bindchange="onBuildingChange"
      >
        <view class="filter-value">
          {{getBuildingDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">æ£€æŸ¥çŠ¶æ€</view>
      <picker
        range="{{statusOptions}}"
        range-key="{{statusLabels}}"
        value="{{statusIndex}}"
        bindchange="onStatusChange"
      >
        <view class="filter-value">
          {{getStatusDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">å¼€å§‹æ—¥æœŸ</view>
      <picker
        mode="date"
        start="2023-01-01"
        end="{{today}}"
        value="{{filters.start_date}}"
        bindchange="onDateChange"
        data-field="start_date"
      >
        <view class="filter-value">
          {{filters.start_date || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">ç»“æŸæ—¥æœŸ</view>
      <picker
        mode="date"
        start="{{filters.start_date || '2023-01-01'}}"
        end="{{today}}"
        value="{{filters.end_date}}"
        bindchange="onDateChange"
        data-field="end_date"
      >
        <view class="filter-value">
          {{filters.end_date || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-actions">
      <view class="filter-action-btn" bindtap="resetFilters">é‡ç½®</view>
      <view class="filter-action-btn primary" bindtap="applyFilters">åº”ç”¨</view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{userRole === 'admin' || userRole === 'staff'}}">
    <button class="btn-primary" bindtap="createNewCheck">æ–°å»ºå«ç”Ÿæ£€æŸ¥</button>
  </view>

  <!-- å«ç”Ÿæ£€æŸ¥åˆ—è¡¨ -->
  <view class="check-list">
    <block wx:for="{{checks}}" wx:key="id" wx:for-index="idx">
      <view 
        class="check-item card" 
        bindtap="viewCheckDetail"
        data-id="{{item.id}}"
      >
        <view class="check-header">
          <view class="check-title">
            <text class="check-number">{{item.check_number}}</text>
            <text class="check-status {{getStatusClass(item.status)}}">
              {{formatStatus(item.status)}}
            </text>
          </view>
          <view class="check-date">
            {{formatDate(item.check_date)}}
          </view>
        </view>

        <view class="check-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æ¥¼æ ‹ï¼š</text>
              <text class="info-value">{{item.building_name}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æ¥¼å±‚ï¼š</text>
              <text class="info-value">{{item.floor}}å±‚</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æ€»åˆ†ï¼š</text>
              <text class="info-value score">{{formatScore(item.total_score)}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">å¹³å‡åˆ†ï¼š</text>
              <text class="info-value">{{formatScore(item.average_score)}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">åˆæ ¼æˆ¿é—´ï¼š</text>
              <text class="info-value success">{{item.passed_rooms}}é—´</text>
            </view>
            <view class="info-item">
              <text class="info-label">ä¸åˆæ ¼æˆ¿é—´ï¼š</text>
              <text class="info-value danger">{{item.failed_rooms}}é—´</text>
            </view>
          </view>
          <view class="info-row" wx:if="{{item.comments}}">
            <view class="info-item full-width">
              <text class="info-label">å¤‡æ³¨ï¼š</text>
              <text class="info-value">{{item.comments}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="check-actions" wx:if="{{canOperate(item)}}">
          <view 
            class="action-btn" 
            bindtap="viewCheckDetail"
            data-id="{{item.id}}"
          >
            è¯¦æƒ…
          </view>
          <view 
            class="action-btn" 
            wx:if="{{canEdit(item)}}"
            bindtap="editCheck"
            data-id="{{item.id}}"
          >
            ç¼–è¾‘
          </view>
          <view 
            class="action-btn primary" 
            wx:if="{{canPublish(item)}}"
            bindtap="publishCheck"
            data-id="{{item.id}}"
            data-index="{{idx}}"
          >
            å‘å¸ƒ
          </view>
          <view 
            class="action-btn delete" 
            wx:if="{{canDelete(item)}}"
            bindtap="deleteCheck"
            data-id="{{item.id}}"
            data-number="{{item.check_number}}"
          >
            åˆ é™¤
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && checks.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && checks.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— å«ç”Ÿæ£€æŸ¥è®°å½•</view>
    <view class="empty-action" 
          wx:if="{{userRole === 'admin' || userRole === 'staff'}}" 
          bindtap="createNewCheck">
      æ–°å»ºæ£€æŸ¥
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && checks.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && checks.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/hygiene/check/check.wxss */

.check-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.check-title {
  display: flex;
  align-items: baseline;
  flex-wrap: wrap;
}

.check-number {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-right: 20rpx;
}

.check-building {
  font-size: 24rpx;
  color: #1890ff;
  background: #e6f7ff;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.check-status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 16rpx;
}

.check-status.status-draft {
  background: #f5f5f5;
  color: #999;
}

.check-status.status-completed {
  background: #e6f7ff;
  color: #1890ff;
}

.check-status.status-published {
  background: #f6ffed;
  color: #52c41a;
}

.check-info {
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-item {
  flex: 1;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.info-value.score {
  color: #fa8c16;
  font-size: 32rpx;
  font-weight: 600;
}

.check-actions {
  display: flex;
  gap: 20rpx;
  flex-wrap: wrap;
  padding-top: 20rpx;
  border-top: 2rpx solid #f0f0f0;
}

.action-btn {
  padding: 12rpx 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 24rpx;
  color: #333;
  text-align: center;
  min-width: 120rpx;
}

.action-btn:active {
  background: #e8e8e8;
}

.action-btn.publish {
  background: #f6ffed;
  color: #52c41a;
}

.action-btn.publish:active {
  background: #d9f7be;
}

.action-btn.delete {
  background: #fff1f0;
  color: #ff4d4f;
}

.action-btn.delete:active {
  background: #ffccc7;
}



// pages/index/index.js
const app = getApp()

Page({
  data: {
    userInfo: null,
    role: null,
    stats: {
      repairCount: 0,
      visitorCount: 0,
      noticeCount: 0,
      buildingCount: 0
    },
    quickActions: [],
    recentNotices: [],
    loading: true
  },

  onLoad() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login'
      })
      return
    }
  },

  onShow() {
    this.loadUserInfo()
    this.loadDashboardData()
  },

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  loadUserInfo() {
    const userInfo = app.getUserInfo()
    this.setData({
      userInfo,
      role: userInfo.role
    })
  },

  // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
  async loadDashboardData() {
    this.setData({ loading: true })
    
    try {
      const userInfo = this.data.userInfo
      
      // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®å¿«é€Ÿæ“ä½œ
      let quickActions = []
      
      if (userInfo.role === 'admin' || userInfo.role === 'staff') {
        quickActions = [
          { icon: 'ğŸ¢', text: 'æ¥¼æ ‹ç®¡ç†', url: '/pages/dormitory/buildings/buildings' },
          { icon: 'ğŸ ', text: 'æˆ¿é—´ç®¡ç†', url: '/pages/dormitory/rooms/rooms' },
          { icon: 'ğŸ”§', text: 'æŠ¥ä¿®å¤„ç†', url: '/pages/repair/list/list' },
          { icon: 'ğŸ‘¥', text: 'è®¿å®¢ç®¡ç†', url: '/pages/visitor/list/list' },
          { icon: 'ğŸ§¹', text: 'å«ç”Ÿæ£€æŸ¥', url: '/pages/hygiene/check/check' },
          { icon: 'ğŸ“¢', text: 'å‘å¸ƒå…¬å‘Š', url: '/pages/notice/list/list?action=create' }
        ]
      } else if (userInfo.role === 'student') {
        quickActions = [
          { icon: 'ğŸ”§', text: 'æˆ‘è¦æŠ¥ä¿®', url: '/pages/repair/submit/submit' },
          { icon: 'ğŸ‘¥', text: 'è®¿å®¢ç™»è®°', url: '/pages/visitor/register/register' },
          { icon: 'ğŸ“‹', text: 'æˆ‘çš„æŠ¥ä¿®', url: '/pages/repair/list/list' },
          { icon: 'ğŸ“', text: 'è®¿å®¢è®°å½•', url: '/pages/visitor/list/list' },
          { icon: 'ğŸ“¢', text: 'æŸ¥çœ‹å…¬å‘Š', url: '/pages/notice/list/list' },
          { icon: 'ğŸ‘¤', text: 'ä¸ªäººä¿¡æ¯', url: '/pages/profile/profile' }
        ]
      }
      
      this.setData({ quickActions })
      
      // åŠ è½½ç»Ÿè®¡æ•°æ®
      await this.loadStats()
      
      // åŠ è½½æœ€æ–°å…¬å‘Š
      await this.loadRecentNotices()
      
    } catch (error) {
      console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    } finally {
      this.setData({ loading: false })
    }
  },

  // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
  async loadStats() {
    try {
      const userInfo = this.data.userInfo
      const stats = {
        repairCount: 0,
        visitorCount: 0,
        noticeCount: 0,
        buildingCount: 0
      }
      
      // è·å–å…¬å‘Šæ•°é‡
      const noticeRes = await app.request('/notices', 'GET', { pageSize: 1 })
      stats.noticeCount = noticeRes.data.pagination.total
      
      if (userInfo.role === 'admin' || userInfo.role === 'staff') {
        // ç®¡ç†å‘˜/å®¿ç®¡ï¼šè·å–æ‰€æœ‰ç»Ÿè®¡æ•°æ®
        const repairRes = await app.request('/repairs', 'GET', { pageSize: 1 })
        stats.repairCount = repairRes.data.pagination.total
        
        const visitorRes = await app.request('/visitors', 'GET', { pageSize: 1 })
        stats.visitorCount = visitorRes.data.pagination.total
        
        const buildingRes = await app.request('/dormitory/buildings', 'GET', { pageSize: 1 })
        stats.buildingCount = buildingRes.data.pagination.total
      } else if (userInfo.role === 'student') {
        // å­¦ç”Ÿï¼šè·å–ä¸ªäººç»Ÿè®¡æ•°æ®
        const repairRes = await app.request('/students/my/repairs', 'GET', { pageSize: 1 })
        stats.repairCount = repairRes.data.pagination.total
        
        const visitorRes = await app.request('/students/my/visitors', 'GET', { pageSize: 1 })
        stats.visitorCount = visitorRes.data.pagination.total
      }
      
      this.setData({ stats })
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
    }
  },

  // åŠ è½½æœ€æ–°å…¬å‘Š
  async loadRecentNotices() {
    try {
      const res = await app.request('/notices', 'GET', {
        page: 1,
        pageSize: 5
      })
      
      this.setData({
        recentNotices: res.data.list
      })
    } catch (error) {
      console.error('åŠ è½½æœ€æ–°å…¬å‘Šå¤±è´¥:', error)
    }
  },

  // å¤„ç†å¿«é€Ÿæ“ä½œç‚¹å‡»
  handleQuickAction(e) {
    const { url } = e.currentTarget.dataset
    
    if (url) {
      wx.navigateTo({
        url: url
      })
    }
  },

  // æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…
  viewNoticeDetail(e) {
    const { id } = e.currentTarget.dataset
    
    wx.navigateTo({
      url: `/pages/notice/list/list?action=detail&id=${id}`
    })
  },

  // åˆ·æ–°æ•°æ®
  onPullDownRefresh() {
    this.loadDashboardData().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // åˆ†äº«åŠŸèƒ½
  onShareAppMessage() {
    return {
      title: 'å®¿èˆç®¡ç†ç³»ç»Ÿ',
      path: '/pages/index/index'
    }
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "å®¿èˆç®¡ç†ç³»ç»Ÿ"
}



<!--pages/index/index.wxml-->
<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="card" wx:if="{{userInfo}}">
    <view class="flex align-center">
      <image 
        src="{{userInfo.avatar_url || '/images/avatar-default.png'}}" 
        class="avatar"
        mode="aspectFill"
      ></image>
      <view class="ml-30 flex-1">
        <view class="user-name">{{userInfo.real_name || userInfo.username}}</view>
        <view class="user-role">{{roleText}}</view>
        <view class="user-dorm" wx:if="{{userInfo.building_info}}">
          {{userInfo.building_info.building_name}} {{userInfo.building_info.room_number}}
        </view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <view class="card stats-grid" wx:if="{{!loading}}">
    <view class="stat-item">
      <view class="stat-number">{{stats.repairCount}}</view>
      <view class="stat-label">æŠ¥ä¿®è®°å½•</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{stats.visitorCount}}</view>
      <view class="stat-label">è®¿å®¢è®°å½•</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{stats.noticeCount}}</view>
      <view class="stat-label">å…¬å‘Šé€šçŸ¥</view>
    </view>
    <view class="stat-item">
      <view class="stat-number">{{stats.buildingCount}}</view>
      <view class="stat-label">æ¥¼æ ‹æ€»æ•°</view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œ -->
  <view class="card" wx:if="{{quickActions.length > 0 && !loading}}">
    <view class="section-title">å¿«é€Ÿæ“ä½œ</view>
    <view class="quick-actions">
      <block wx:for="{{quickActions}}" wx:key="index">
        <view 
          class="action-item" 
          bindtap="handleQuickAction"
          data-url="{{item.url}}"
        >
          <view class="action-icon">{{item.icon}}</view>
          <view class="action-text">{{item.text}}</view>
        </view>
      </block>
    </view>
  </view>

  <!-- æœ€æ–°å…¬å‘Š -->
  <view class="card" wx:if="{{recentNotices.length > 0 && !loading}}">
    <view class="section-title">æœ€æ–°å…¬å‘Š</view>
    <view class="notice-list">
      <block wx:for="{{recentNotices}}" wx:key="id">
        <view 
          class="notice-item" 
          bindtap="viewNoticeDetail"
          data-id="{{item.id}}"
        >
          <view class="notice-title">{{item.title}}</view>
          <view class="notice-meta">
            <text class="notice-type">{{item.notice_type}}</text>
            <text class="notice-time">{{formatTime(item.created_at)}}</text>
          </view>
        </view>
      </block>
    </view>
    <view 
      class="view-all" 
      bindtap="handleQuickAction"
      data-url="/pages/notice/list/list"
    >
      æŸ¥çœ‹å…¨éƒ¨å…¬å‘Š â†’
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="empty-state" wx:if="{{loading}}">
    <image src="/images/loading.gif" class="empty-image"></image>
    <view class="empty-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && recentNotices.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— æ•°æ®</view>
  </view>
</view>



/* pages/index/index.wxss */

.avatar {
  width: 120rpx;
  height: 120rpx;
  border-radius: 50%;
  border: 4rpx solid #1890ff;
}

.user-name {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 8rpx;
}

.user-role {
  font-size: 28rpx;
  color: #1890ff;
  margin-bottom: 8rpx;
}

.user-dorm {
  font-size: 24rpx;
  color: #666;
  background: #f5f5f5;
  padding: 8rpx 16rpx;
  border-radius: 16rpx;
  display: inline-block;
}

/* ç»Ÿè®¡ç½‘æ ¼ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 32rpx;
}

.stat-item {
  text-align: center;
  padding: 32rpx;
  background: #fafafa;
  border-radius: 16rpx;
}

.stat-number {
  font-size: 48rpx;
  font-weight: 600;
  color: #1890ff;
  margin-bottom: 8rpx;
}

.stat-label {
  font-size: 24rpx;
  color: #666;
}

/* å¿«é€Ÿæ“ä½œ */
.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 32rpx;
  padding-bottom: 16rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 32rpx;
}

.action-item {
  text-align: center;
  padding: 32rpx 0;
  border-radius: 16rpx;
  background: #fafafa;
  transition: all 0.3s;
}

.action-item:active {
  background: #e6f7ff;
  transform: scale(0.98);
}

.action-icon {
  font-size: 60rpx;
  margin-bottom: 16rpx;
}

.action-text {
  font-size: 24rpx;
  color: #333;
}

/* å…¬å‘Šåˆ—è¡¨ */
.notice-list {
  margin-bottom: 32rpx;
}

.notice-item {
  padding: 24rpx 0;
  border-bottom: 2rpx solid #f0f0f0;
}

.notice-item:last-child {
  border-bottom: none;
}

.notice-item:active {
  background: #fafafa;
}

.notice-title {
  font-size: 28rpx;
  color: #333;
  margin-bottom: 16rpx;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
}

.notice-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notice-type {
  font-size: 24rpx;
  color: #1890ff;
  background: #e6f7ff;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.notice-time {
  font-size: 24rpx;
  color: #999;
}

.view-all {
  text-align: center;
  color: #1890ff;
  font-size: 28rpx;
  padding: 16rpx;
  border-top: 2rpx solid #f0f0f0;
}

.view-all:active {
  background: #fafafa;
}



// pages/login/login.js
const app = getApp()

Page({
  data: {
    username: '',
    password: '',
    loading: false,
    showPassword: false
  },

  onLoad(options) {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if (app.checkLogin()) {
      wx.switchTab({
        url: '/pages/index/index'
      })
      return
    }
    
    // è·å–é‡å®šå‘URL
    if (options.redirect) {
      wx.setStorageSync('redirect_url', options.redirect)
    }
  },

  onShow() {
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯çŠ¶æ€
    this.setData({
      username: '',
      password: '',
      loading: false
    })
  },

  // è¾“å…¥å¤„ç†
  onUsernameInput(e) {
    this.setData({
      username: e.detail.value.trim()
    })
  },

  onPasswordInput(e) {
    this.setData({
      password: e.detail.value
    })
  },

  // åˆ‡æ¢å¯†ç æ˜¾ç¤º
  togglePassword() {
    this.setData({
      showPassword: !this.data.showPassword
    })
  },

  // è¡¨å•éªŒè¯
  validateForm() {
    const { username, password } = this.data
    
    if (!username) {
      wx.showToast({
        title: 'è¯·è¾“å…¥ç”¨æˆ·å',
        icon: 'none'
      })
      return false
    }

    if (!password) {
      wx.showToast({
        title: 'è¯·è¾“å…¥å¯†ç ',
        icon: 'none'
      })
      return false
    }

    if (password.length < 6) {
      wx.showToast({
        title: 'å¯†ç é•¿åº¦è‡³å°‘6ä½',
        icon: 'none'
      })
      return false
    }

    return true
  },

  // ç™»å½•
  async login() {
    if (!this.validateForm()) {
      return
    }

    if (this.data.loading) return

    this.setData({ loading: true })

    try {
      const res = await app.request('/auth/login', 'POST', {
        username: this.data.username,
        password: this.data.password
      })

      // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
      app.setToken(res.data.token)
      app.setUserInfo(res.data.user)

      wx.showToast({
        title: 'ç™»å½•æˆåŠŸ',
        icon: 'success',
        duration: 1500
      })

      // è·³è½¬
      setTimeout(() => {
        const redirectUrl = wx.getStorageSync('redirect_url')
        if (redirectUrl) {
          wx.redirectTo({
            url: redirectUrl
          })
          wx.removeStorageSync('redirect_url')
        } else {
          wx.switchTab({
            url: '/pages/index/index'
          })
        }
      }, 1500)

    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      this.setData({ loading: false })
    }
  },

  // å¿«é€Ÿæµ‹è¯•ç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
  quickLogin(role) {
    const testAccounts = {
      'admin': { username: 'admin', password: 'admin123' },
      'student': { username: 'student001', password: 'student123' },
      'staff': { username: 'staff001', password: 'staff123' }
    }

    const account = testAccounts[role]
    if (account) {
      this.setData({
        username: account.username,
        password: account.password
      })
      this.login()
    }
  },

  // è·³è½¬åˆ°æ³¨å†Œé¡µé¢
  gotoRegister() {
    wx.navigateTo({
      url: '/pages/register/register'
    })
  },

  // å¿˜è®°å¯†ç 
  forgotPassword() {
    wx.showModal({
      title: 'å¿˜è®°å¯†ç ',
      content: 'è¯·è”ç³»å®¿èˆç®¡ç†å‘˜é‡ç½®å¯†ç ',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    })
  },

  // é”®ç›˜å®Œæˆäº‹ä»¶
  onInputConfirm(e) {
    if (e.detail.value && this.data.password) {
      this.login()
    }
  }
})



{
  "usingComponents": {},
  "navigationBarTitleText": "ç™»å½•"
}



<!--pages/login/login.wxml-->
<view class="container">
  <view class="login-card card">
    <!-- Logo -->
    <view class="logo">
      <image src="/images/logo.png" mode="aspectFit"></image>
      <view class="logo-text">å®¿èˆç®¡ç†ç³»ç»Ÿ</view>
      <view class="logo-subtext">å®‰å…¨ â€¢ ä¾¿æ· â€¢ æ™ºèƒ½</view>
    </view>

    <!-- ç™»å½•è¡¨å• -->
    <view class="form">
      <view class="form-group">
        <view class="form-label">
          <text class="form-icon">ğŸ‘¤</text>
          <text>ç”¨æˆ·å</text>
        </view>
        <input
          type="text"
          placeholder="è¯·è¾“å…¥ç”¨æˆ·å/å­¦å·/é‚®ç®±"
          value="{{username}}"
          bindinput="onUsernameInput"
          bindconfirm="onInputConfirm"
          class="form-input"
          maxlength="50"
        />
      </view>

      <view class="form-group">
        <view class="form-label">
          <text class="form-icon">ğŸ”’</text>
          <text>å¯†ç </text>
        </view>
        <view class="password-input">
          <input
            type="{{showPassword ? 'text' : 'password'}}"
            placeholder="è¯·è¾“å…¥å¯†ç "
            value="{{password}}"
            bindinput="onPasswordInput"
            bindconfirm="onInputConfirm"
            class="form-input"
            maxlength="20"
          />
          <view class="password-toggle" bindtap="togglePassword">
            <text wx:if="{{showPassword}}">ğŸ™ˆ</text>
            <text wx:else>ğŸ‘ï¸</text>
          </view>
        </view>
      </view>

      <!-- å¿˜è®°å¯†ç  -->
      <view class="forgot-password" bindtap="forgotPassword">
        <text>å¿˜è®°å¯†ç ï¼Ÿ</text>
      </view>

      <!-- ç™»å½•æŒ‰é’® -->
      <button
        class="btn-primary login-btn"
        bindtap="login"
        disabled="{{loading}}"
      >
        {{loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}}
      </button>

      <!-- å¿«é€Ÿç™»å½•ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ -->
      <view class="quick-login" wx:if="{{false}}"> <!-- é»˜è®¤éšè—ï¼Œå¼€å‘æ—¶å¯è®¾ä¸ºtrue -->
        <view class="quick-title">å¿«é€Ÿç™»å½•ï¼ˆä»…å¼€å‘ï¼‰</view>
        <view class="quick-buttons">
          <button class="quick-btn admin" bindtap="quickLogin" data-role="admin">ç®¡ç†å‘˜</button>
          <button class="quick-btn student" bindtap="quickLogin" data-role="student">å­¦ç”Ÿ</button>
          <button class="quick-btn staff" bindtap="quickLogin" data-role="staff">å®¿ç®¡</button>
        </view>
      </view>

      <!-- æ³¨å†Œé“¾æ¥ -->
      <view class="register-section">
        <text>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</text>
        <text class="register-link" bindtap="gotoRegister">ç«‹å³æ³¨å†Œ</text>
      </view>
    </view>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <view class="footer">
      <text>Â© 2023 å®¿èˆç®¡ç†ç³»ç»Ÿ v1.0</text>
    </view>
  </view>
</view>



/* pages/login/login.wxss */

.container {
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40rpx;
}

.login-card {
  width: 100%;
  max-width: 600rpx;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 24rpx;
  padding: 60rpx 50rpx;
  box-shadow: 0 20rpx 60rpx rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(20rpx);
}

/* Logo æ ·å¼ */
.logo {
  text-align: center;
  margin-bottom: 80rpx;
}

.logo image {
  width: 180rpx;
  height: 180rpx;
  margin-bottom: 30rpx;
  border-radius: 50%;
  box-shadow: 0 10rpx 30rpx rgba(102, 126, 234, 0.3);
}

.logo-text {
  font-size: 40rpx;
  font-weight: 700;
  color: #333;
  margin-bottom: 10rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-subtext {
  font-size: 24rpx;
  color: #999;
  letter-spacing: 2rpx;
}

/* è¡¨å•æ ·å¼ */
.form {
  margin-bottom: 50rpx;
}

.form-group {
  margin-bottom: 40rpx;
}

.form-label {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.form-icon {
  margin-right: 15rpx;
  font-size: 32rpx;
}

.form-input {
  width: 100%;
  height: 90rpx;
  padding: 0 30rpx;
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 45rpx;
  font-size: 28rpx;
  color: #333;
  box-sizing: border-box;
  transition: all 0.3s;
}

.form-input:focus {
  border-color: #667eea;
  background: #fff;
  box-shadow: 0 0 0 4rpx rgba(102, 126, 234, 0.1);
}

.password-input {
  position: relative;
}

.password-toggle {
  position: absolute;
  right: 30rpx;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32rpx;
  color: #999;
  width: 50rpx;
  height: 50rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f8f9fa;
}

.password-toggle:active {
  background: #e9ecef;
}

/* å¿˜è®°å¯†ç  */
.forgot-password {
  text-align: right;
  margin-bottom: 50rpx;
}

.forgot-password text {
  font-size: 26rpx;
  color: #667eea;
  text-decoration: underline;
}

.forgot-password text:active {
  color: #764ba2;
}

/* ç™»å½•æŒ‰é’® */
.login-btn {
  height: 100rpx;
  line-height: 100rpx;
  font-size: 32rpx;
  font-weight: 600;
  border-radius: 50rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  margin-bottom: 40rpx;
  transition: all 0.3s;
}

.login-btn:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.login-btn[disabled] {
  opacity: 0.6;
}

/* å¿«é€Ÿç™»å½• */
.quick-login {
  margin-bottom: 40rpx;
  padding-top: 40rpx;
  border-top: 2rpx solid #f0f0f0;
}

.quick-title {
  font-size: 26rpx;
  color: #666;
  text-align: center;
  margin-bottom: 30rpx;
}

.quick-buttons {
  display: flex;
  justify-content: center;
  gap: 20rpx;
  flex-wrap: wrap;
}

.quick-btn {
  padding: 16rpx 32rpx;
  font-size: 26rpx;
  border-radius: 40rpx;
  border: none;
  min-width: 150rpx;
}

.quick-btn.admin {
  background: #ff6b6b;
  color: white;
}

.quick-btn.student {
  background: #4ecdc4;
  color: white;
}

.quick-btn.staff {
  background: #45b7d1;
  color: white;
}

/* æ³¨å†Œéƒ¨åˆ† */
.register-section {
  text-align: center;
  font-size: 28rpx;
  color: #666;
}

.register-link {
  color: #667eea;
  font-weight: 600;
  margin-left: 10rpx;
  text-decoration: underline;
}

.register-link:active {
  color: #764ba2;
}

/* åº•éƒ¨ä¿¡æ¯ */
.footer {
  text-align: center;
  padding-top: 40rpx;
  border-top: 2rpx solid #f0f0f0;
  font-size: 22rpx;
  color: #999;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 375px) {
  .login-card {
    padding: 40rpx 30rpx;
  }
  
  .logo image {
    width: 150rpx;
    height: 150rpx;
  }
  
  .logo-text {
    font-size: 36rpx;
  }
  
  .form-input {
    height: 80rpx;
  }
  
  .login-btn {
    height: 90rpx;
    line-height: 90rpx;
  }
}



// pages/notice/list/list.js
const app = getApp()

Page({
  data: {
    notices: [],
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20,
    total: 0,
    filters: {
      notice_type: '',
      status: 'published',
      keyword: ''
    },
    userRole: '',
    showFilter: false,
    showCreateBtn: false
  },

  onLoad(options) {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/notice/list/list')
      })
      return
    }

    const userInfo = app.getUserInfo()
    this.setData({
      userRole: userInfo.role,
      showCreateBtn: userInfo.role === 'admin' || userInfo.role === 'staff'
    })

    // å¦‚æœæ˜¯æŸ¥çœ‹è¯¦æƒ…ï¼Œç›´æ¥è·³è½¬åˆ°è¯¦æƒ…é¡µ
    if (options.action === 'detail' && options.id) {
      wx.navigateTo({
        url: `/pages/notice/detail/detail?id=${options.id}`
      })
      return
    }

    this.loadNotices()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      notices: [],
      hasMore: true
    })
    this.loadNotices()
  },

  // åŠ è½½å…¬å‘Šåˆ—è¡¨
  async loadNotices(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        notices: [],
        loading: true
      })
    }

    try {
      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      // å­¦ç”Ÿåªèƒ½æŸ¥çœ‹å·²å‘å¸ƒçš„å…¬å‘Š
      if (this.data.userRole === 'student') {
        params.status = 'published'
      }

      const res = await app.request('/notices', 'GET', params)

      const newNotices = loadMore ? 
        [...this.data.notices, ...res.data.list] : 
        res.data.list

      this.setData({
        notices: newNotices,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½å…¬å‘Šåˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // æœç´¢è¾“å…¥
  onSearchInput(e) {
    this.setData({
      'filters.keyword': e.detail.value
    })
  },

  // æ‰§è¡Œæœç´¢
  onSearch() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadNotices()
  },

  // ç­›é€‰æ¡ä»¶å˜åŒ–
  onFilterChange(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`filters.${field}`]: e.detail.value
    })
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    this.setData({
      showFilter: !this.data.showFilter
    })
  },

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    this.setData({
      showFilter: false,
      page: 1,
      hasMore: true
    })
    this.loadNotices()
  },

  // é‡ç½®ç­›é€‰
  resetFilters() {
    this.setData({
      filters: {
        notice_type: '',
        status: this.data.userRole === 'student' ? 'published' : '',
        keyword: ''
      },
      page: 1,
      hasMore: true
    })
    this.loadNotices()
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadNotices(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadNotices().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…
  viewNoticeDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/notice/detail/detail?id=${id}`
    })
  },

  // åˆ›å»ºå…¬å‘Š
  createNotice() {
    wx.navigateTo({
      url: '/pages/notice/create/create'
    })
  },

  // ç¼–è¾‘å…¬å‘Š
  editNotice(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/notice/edit/edit?id=${id}`
    })
  },

  // åˆ é™¤å…¬å‘Š
  async deleteNotice(e) {
    const { id, title } = e.currentTarget.dataset

    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: `ç¡®å®šè¦åˆ é™¤å…¬å‘Š"${title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      confirmColor: '#fa541c',
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/notices/${id}`, 'DELETE')
            
            wx.showToast({
              title: 'åˆ é™¤æˆåŠŸ',
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadNotices()

          } catch (error) {
            console.error('åˆ é™¤å…¬å‘Šå¤±è´¥:', error)
          }
        }
      }
    })
  },

  // å‘å¸ƒå…¬å‘Š
  async publishNotice(e) {
    const { id, title } = e.currentTarget.dataset

    wx.showModal({
      title: 'ç¡®è®¤å‘å¸ƒ',
      content: `ç¡®å®šè¦å‘å¸ƒå…¬å‘Š"${title}"å—ï¼Ÿ`,
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/notices/${id}/publish`, 'POST')
            
            wx.showToast({
              title: 'å‘å¸ƒæˆåŠŸ',
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadNotices()

          } catch (error) {
            console.error('å‘å¸ƒå…¬å‘Šå¤±è´¥:', error)
          }
        }
      }
    })
  },

  // ç½®é¡¶/å–æ¶ˆç½®é¡¶
  async toggleTop(e) {
    const { id, is_top, title } = e.currentTarget.dataset
    const action = is_top ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'

    wx.showModal({
      title: `ç¡®è®¤${action}`,
      content: `ç¡®å®šè¦${action}å…¬å‘Š"${title}"å—ï¼Ÿ`,
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/notices/${id}/toggle-top`, 'POST')
            
            wx.showToast({
              title: `${action}æˆåŠŸ`,
              icon: 'success'
            })

            // é‡æ–°åŠ è½½åˆ—è¡¨
            this.loadNotices()

          } catch (error) {
            console.error(`${action}å…¬å‘Šå¤±è´¥:`, error)
          }
        }
      }
    })
  },

  // æ ¼å¼åŒ–å…¬å‘Šç±»å‹æ˜¾ç¤º
  formatNoticeType(type) {
    const typeMap = {
      'system': 'ç³»ç»Ÿé€šçŸ¥',
      'maintenance': 'ç»´ä¿®é€šçŸ¥',
      'activity': 'æ´»åŠ¨é€šçŸ¥',
      'emergency': 'ç´§æ€¥é€šçŸ¥',
      'other': 'å…¶ä»–'
    }
    return typeMap[type] || type
  },

  // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
  formatStatus(status) {
    const statusMap = {
      'draft': 'è‰ç¨¿',
      'published': 'å·²å‘å¸ƒ',
      'expired': 'å·²è¿‡æœŸ'
    }
    return statusMap[status] || status
  },

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(dateStr) {
    if (!dateStr) return ''
    const date = new Date(dateStr)
    const month = date.getMonth() + 1
    const day = date.getDate()
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    return `${month}/${day} ${hours}:${minutes}`
  },

  // è·å–çŠ¶æ€æ ‡ç­¾çš„ç±»å
  getStatusClass(status) {
    return `status-${status}`
  },

  // åˆ¤æ–­æ˜¯å¦å¯ç¼–è¾‘
  canEdit(notice) {
    return (notice.status === 'draft' || notice.status === 'published') && 
           (this.data.userRole === 'admin' || this.data.userRole === 'staff')
  },

  // åˆ¤æ–­æ˜¯å¦å¯å‘å¸ƒ
  canPublish(notice) {
    return notice.status === 'draft' && 
           (this.data.userRole === 'admin' || this.data.userRole === 'staff')
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "å…¬å‘Šé€šçŸ¥"
}



<!--pages/notice/list/list.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="æœç´¢å…¬å‘Šæ ‡é¢˜"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <view class="filter-item">
      <view class="filter-label">å…¬å‘Šç±»å‹</view>
      <picker
        range="{{['å…¨éƒ¨', 'system', 'maintenance', 'activity', 'emergency', 'other']}}"
        range-key="{{['å…¨éƒ¨', 'ç³»ç»Ÿé€šçŸ¥', 'ç»´ä¿®é€šçŸ¥', 'æ´»åŠ¨é€šçŸ¥', 'ç´§æ€¥é€šçŸ¥', 'å…¶ä»–']}}"
        value="{{filters.notice_type ? ['system', 'maintenance', 'activity', 'emergency', 'other'].indexOf(filters.notice_type) + 1 : 0}}"
        bindchange="onFilterChange"
        data-field="notice_type"
      >
        <view class="filter-value">
          {{formatNoticeType(filters.notice_type) || 'å…¨éƒ¨'}}
        </view>
      </picker>
    </view>

    <view class="filter-item" wx:if="{{userRole !== 'student'}}">
      <view class="filter-label">çŠ¶æ€</view>
      <picker
        range="{{['å…¨éƒ¨', 'draft', 'published', 'expired']}}"
        range-key="{{['å…¨éƒ¨', 'è‰ç¨¿', 'å·²å‘å¸ƒ', 'å·²è¿‡æœŸ']}}"
        value="{{filters.status ? ['draft', 'published', 'expired'].indexOf(filters.status) + 1 : 0}}"
        bindchange="onFilterChange"
        data-field="status"
      >
        <view class="filter-value">
          {{formatStatus(filters.status) || 'å…¨éƒ¨'}}
        </view>
      </picker>
    </view>

    <view class="filter-actions">
      <view class="filter-action-btn" bindtap="resetFilters">é‡ç½®</view>
      <view class="filter-action-btn primary" bindtap="applyFilters">åº”ç”¨</view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{showCreateBtn}}">
    <button class="btn-primary" bindtap="createNotice">å‘å¸ƒå…¬å‘Š</button>
  </view>

  <!-- å…¬å‘Šåˆ—è¡¨ -->
  <view class="notice-list">
    <block wx:for="{{notices}}" wx:key="id">
      <view 
        class="notice-item card {{item.is_top ? 'top-notice' : ''}}" 
        bindtap="viewNoticeDetail"
        data-id="{{item.id}}"
      >
        <view class="notice-header">
          <view class="notice-title">
            <text class="notice-text">{{item.title}}</text>
            <text class="notice-top" wx:if="{{item.is_top}}">ç½®é¡¶</text>
          </view>
          <view class="notice-status {{getStatusClass(item.status)}}">
            {{formatStatus(item.status)}}
          </view>
        </view>

        <view class="notice-content">
          <text class="notice-preview">{{item.content.substring(0, 80)}}{{item.content.length > 80 ? '...' : ''}}</text>
        </view>

        <view class="notice-footer">
          <view class="notice-meta">
            <text class="notice-type">{{formatNoticeType(item.notice_type)}}</text>
            <text class="notice-time">{{formatDate(item.created_at)}}</text>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="notice-actions" wx:if="{{canEdit(item) || canPublish(item)}}">
            <view 
              class="action-btn" 
              wx:if="{{canPublish(item)}}"
              bindtap="publishNotice"
              data-id="{{item.id}}"
              data-title="{{item.title}}"
            >
              å‘å¸ƒ
            </view>
            <view 
              class="action-btn" 
              wx:if="{{canEdit(item)}}"
              bindtap="editNotice"
              data-id="{{item.id}}"
            >
              ç¼–è¾‘
            </view>
            <view 
              class="action-btn" 
              wx:if="{{userRole === 'admin'}}"
              bindtap="toggleTop"
              data-id="{{item.id}}"
              data-is_top="{{item.is_top}}"
              data-title="{{item.title}}"
            >
              {{item.is_top ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}}
            </view>
            <view 
              class="action-btn delete" 
              wx:if="{{canEdit(item)}}"
              bindtap="deleteNotice"
              data-id="{{item.id}}"
              data-title="{{item.title}}"
            >
              åˆ é™¤
            </view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && notices.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && notices.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— å…¬å‘Šé€šçŸ¥</view>
    <view class="empty-action" wx:if="{{showCreateBtn}}" bindtap="createNotice">
      å‘å¸ƒå…¬å‘Š
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && notices.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && notices.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/notice/list/list.wxss */

.notice-item.top-notice {
  border: 4rpx solid #ffd666;
  background: #fffbe6;
}

.notice-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24rpx;
}

.notice-title {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  flex: 1;
}

.notice-text {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-right: 20rpx;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.notice-top {
  font-size: 20rpx;
  color: #fa8c16;
  background: #fff7e6;
  padding: 4rpx 8rpx;
  border-radius: 6rpx;
}

.notice-status {
  font-size: 22rpx;
  padding: 6rpx 12rpx;
  border-radius: 12rpx;
  white-space: nowrap;
}

.notice-status.status-draft {
  background: #f5f5f5;
  color: #999;
}

.notice-status.status-published {
  background: #e6f7ff;
  color: #1890ff;
}

.notice-status.status-expired {
  background: #f5f5f5;
  color: #999;
}

.notice-content {
  margin-bottom: 24rpx;
}

.notice-preview {
  font-size: 28rpx;
  color: #666;
  line-height: 1.6;
}

.notice-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 20rpx;
  border-top: 2rpx solid #f0f0f0;
}

.notice-meta {
  display: flex;
  align-items: center;
  gap: 20rpx;
}

.notice-type {
  font-size: 24rpx;
  color: #1890ff;
  background: #e6f7ff;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.notice-time {
  font-size: 24rpx;
  color: #999;
}

.notice-actions {
  display: flex;
  gap: 16rpx;
}

.action-btn {
  padding: 8rpx 16rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 22rpx;
  color: #333;
  text-align: center;
  white-space: nowrap;
}

.action-btn:active {
  background: #e8e8e8;
}

.action-btn.delete {
  background: #fff1f0;
  color: #ff4d4f;
}

.action-btn.delete:active {
  background: #ffccc7;
}



// pages/profile/profile.js
const app = getApp()

Page({
  data: {
    userInfo: null,
    loading: false,
    editing: false,
    editForm: {},
    originalForm: {}
  },

  onLoad() {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login'
      })
      return
    }
  },

  onShow() {
    this.loadUserInfo()
  },

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  async loadUserInfo() {
    this.setData({ loading: true })
    
    try {
      const res = await app.request('/auth/me')
      const userInfo = res.data
      
      app.setUserInfo(userInfo)
      
      this.setData({
        userInfo,
        editForm: {
          email: userInfo.email || '',
          phone: userInfo.phone || '',
          avatar_url: userInfo.avatar_url || ''
        },
        originalForm: {
          email: userInfo.email || '',
          phone: userInfo.phone || '',
          avatar_url: userInfo.avatar_url || ''
        }
      })
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    } finally {
      this.setData({ loading: false })
    }
  },

  // å¼€å§‹ç¼–è¾‘
  startEdit() {
    this.setData({
      editing: true
    })
  },

  // å–æ¶ˆç¼–è¾‘
  cancelEdit() {
    this.setData({
      editing: false,
      editForm: { ...this.data.originalForm }
    })
  },

  // è¾“å…¥æ¡†ç»‘å®š
  onInput(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`editForm.${field}`]: e.detail.value
    })
  },

  // éªŒè¯è¡¨å•
  validateForm() {
    const { editForm } = this.data

    if (editForm.email && !this.validateEmail(editForm.email)) {
      wx.showToast({ title: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', icon: 'none' })
      return false
    }

    if (editForm.phone && !this.validatePhone(editForm.phone)) {
      wx.showToast({ title: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®', icon: 'none' })
      return false
    }

    return true
  },

  // é‚®ç®±éªŒè¯
  validateEmail(email) {
    const reg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
    return reg.test(email)
  },

  // æ‰‹æœºå·éªŒè¯
  validatePhone(phone) {
    const reg = /^1[3-9]\d{9}$/
    return reg.test(phone)
  },

  // ä¿å­˜ç¼–è¾‘
  async saveEdit() {
    if (!this.validateForm()) {
      return
    }

    this.setData({ loading: true })

    try {
      const { editForm } = this.data
      
      await app.request('/students/profile', 'PUT', editForm)

      wx.showToast({
        title: 'ä¿å­˜æˆåŠŸ',
        icon: 'success',
        duration: 2000
      })

      // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
      await this.loadUserInfo()
      
      this.setData({
        editing: false,
        originalForm: { ...editForm }
      })

    } catch (error) {
      console.error('ä¿å­˜å¤±è´¥:', error)
    } finally {
      this.setData({ loading: false })
    }
  },

  // ä¿®æ”¹å¯†ç 
  onChangePassword() {
    wx.navigateTo({
      url: '/pages/profile/change-password/change-password'
    })
  },

  // é€€å‡ºç™»å½•
  onLogout() {
    wx.showModal({
      title: 'ç¡®è®¤é€€å‡º',
      content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
      success: (res) => {
        if (res.confirm) {
          app.clearToken()
          wx.reLaunch({
            url: '/pages/login/login'
          })
        }
      }
    })
  },

  // ä¸Šä¼ å¤´åƒ
  async onUploadAvatar() {
    if (!this.data.editing) {
      return
    }

    wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera'],
      success: async (res) => {
        const tempFilePath = res.tempFilePaths[0]
        
        wx.showLoading({
          title: 'ä¸Šä¼ ä¸­...',
          mask: true
        })

        try {
          // è¿™é‡Œéœ€è¦å®ç°æ–‡ä»¶ä¸Šä¼ æ¥å£
          // å‡è®¾ä¸Šä¼ æ¥å£è¿”å›å›¾ç‰‡URL
          const uploadRes = await app.uploadFile('/upload/avatar', tempFilePath)
          
          this.setData({
            'editForm.avatar_url': uploadRes.data.url
          })
          
          wx.hideLoading()
        } catch (error) {
          wx.hideLoading()
          wx.showToast({
            title: 'ä¸Šä¼ å¤±è´¥',
            icon: 'none'
          })
        }
      }
    })
  },

  // æŸ¥çœ‹å®¿èˆä¿¡æ¯
  viewDormitoryInfo() {
    const { userInfo } = this.data
    if (userInfo.building_info) {
      wx.showModal({
        title: 'å®¿èˆä¿¡æ¯',
        content: `æ¥¼æ ‹ï¼š${userInfo.building_info.building_name}\næˆ¿é—´ï¼š${userInfo.building_info.room_number}\næ¥¼å±‚ï¼š${userInfo.building_info.floor}å±‚`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†'
      })
    } else {
      wx.showToast({
        title: 'æœªåˆ†é…å®¿èˆ',
        icon: 'none'
      })
    }
  }
})



{
  "usingComponents": {},
  "navigationBarTitleText": "ä¸ªäººä¸­å¿ƒ"
}



<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- ç”¨æˆ·å¤´åƒå’Œä¿¡æ¯ -->
  <view class="profile-header card">
    <view class="avatar-section">
      <view class="avatar-wrapper" bindtap="onUploadAvatar">
        <image 
          src="{{editForm.avatar_url || userInfo.avatar_url || '/images/avatar-default.png'}}" 
          class="avatar"
          mode="aspectFill"
        />
        <view class="avatar-edit" wx:if="{{editing}}">âœï¸</view>
      </view>
      <view class="user-info">
        <view class="user-name">{{userInfo.real_name || userInfo.username}}</view>
        <view class="user-role">{{userInfo.role === 'admin' ? 'ç®¡ç†å‘˜' : userInfo.role === 'staff' ? 'å®¿ç®¡' : 'å­¦ç”Ÿ'}}</view>
        <view class="user-id">ID: {{userInfo.student_id || userInfo.id}}</view>
      </view>
    </view>
  </view>

  <!-- ä¸ªäººä¿¡æ¯è¡¨å• -->
  <view class="card">
    <view class="section-title">
      ä¸ªäººä¿¡æ¯
      <view class="section-actions">
        <text 
          class="action-btn" 
          wx:if="{{!editing}}" 
          bindtap="startEdit"
        >
          ç¼–è¾‘
        </text>
        <text 
          class="action-btn" 
          wx:if="{{editing}}" 
          bindtap="cancelEdit"
        >
          å–æ¶ˆ
        </text>
        <text 
          class="action-btn primary" 
          wx:if="{{editing}}" 
          bindtap="saveEdit"
        >
          ä¿å­˜
        </text>
      </view>
    </view>

    <view class="form-group">
      <view class="form-label">ç”¨æˆ·å</view>
      <view class="form-value">{{userInfo.username}}</view>
    </view>

    <view class="form-group">
      <view class="form-label">é‚®ç®±</view>
      <input
        wx:if="{{editing}}"
        class="form-input"
        type="text"
        placeholder="è¯·è¾“å…¥é‚®ç®±"
        value="{{editForm.email}}"
        bindinput="onInput"
        data-field="email"
      />
      <view wx:else class="form-value">{{userInfo.email || 'æœªè®¾ç½®'}}</view>
    </view>

    <view class="form-group">
      <view class="form-label">æ‰‹æœºå·</view>
      <input
        wx:if="{{editing}}"
        class="form-input"
        type="number"
        placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
        value="{{editForm.phone}}"
        bindinput="onInput"
        data-field="phone"
      />
      <view wx:else class="form-value">{{userInfo.phone || 'æœªè®¾ç½®'}}</view>
    </view>

    <view class="form-group">
      <view class="form-label">çœŸå®å§“å</view>
      <view class="form-value">{{userInfo.real_name || 'æœªè®¾ç½®'}}</view>
    </view>

    <view class="form-group">
      <view class="form-label">å­¦å·</view>
      <view class="form-value">{{userInfo.student_id || 'æœªè®¾ç½®'}}</view>
    </view>

    <view class="form-group">
      <view class="form-label">æ³¨å†Œæ—¶é—´</view>
      <view class="form-value">{{formatTime(userInfo.created_at)}}</view>
    </view>
  </view>

  <!-- å®¿èˆä¿¡æ¯ -->
  <view class="card" wx:if="{{userInfo.building_info}}">
    <view class="section-title">
      å®¿èˆä¿¡æ¯
      <view class="section-actions">
        <text class="action-btn" bindtap="viewDormitoryInfo">æŸ¥çœ‹</text>
      </view>
    </view>
    <view class="dormitory-info">
      <view class="info-item">
        <view class="info-label">æ¥¼æ ‹</view>
        <view class="info-value">{{userInfo.building_info.building_name}}</view>
      </view>
      <view class="info-item">
        <view class="info-label">æˆ¿é—´å·</view>
        <view class="info-value">{{userInfo.building_info.room_number}}</view>
      </view>
      <view class="info-item">
        <view class="info-label">æ¥¼å±‚</view>
        <view class="info-value">{{userInfo.building_info.floor}}å±‚</view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½èœå• -->
  <view class="card menu-list">
    <view class="menu-item" bindtap="onChangePassword">
      <view class="menu-icon">ğŸ”’</view>
      <view class="menu-text">ä¿®æ”¹å¯†ç </view>
      <view class="menu-arrow">â€º</view>
    </view>
    <view class="menu-item" bindtap="onLogout">
      <view class="menu-icon">ğŸšª</view>
      <view class="menu-text">é€€å‡ºç™»å½•</view>
      <view class="menu-arrow">â€º</view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="empty-state" wx:if="{{loading}}">
    <image src="/images/loading.gif" class="empty-image"></image>
    <view class="empty-text">åŠ è½½ä¸­...</view>
  </view>
</view>



/* pages/profile/profile.wxss */

.profile-header {
  text-align: center;
}

.avatar-section {
  display: flex;
  align-items: center;
}

.avatar-wrapper {
  position: relative;
  width: 160rpx;
  height: 160rpx;
  border-radius: 50%;
  overflow: hidden;
  border: 4rpx solid #1890ff;
}

.avatar {
  width: 100%;
  height: 100%;
}

.avatar-edit {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 48rpx;
}

.user-info {
  flex: 1;
  margin-left: 40rpx;
  text-align: left;
}

.user-name {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 8rpx;
}

.user-role {
  font-size: 28rpx;
  color: #1890ff;
  margin-bottom: 8rpx;
}

.user-id {
  font-size: 24rpx;
  color: #666;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 32rpx;
  padding-bottom: 16rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.section-actions {
  display: flex;
  gap: 32rpx;
}

.action-btn {
  font-size: 28rpx;
  color: #666;
  padding: 8rpx 16rpx;
  border-radius: 8rpx;
  border: 2rpx solid #d9d9d9;
}

.action-btn.primary {
  color: #1890ff;
  border-color: #1890ff;
}

.form-group {
  display: flex;
  align-items: center;
  margin-bottom: 32rpx;
  padding: 16rpx 0;
  border-bottom: 2rpx solid #fafafa;
}

.form-group:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.form-label {
  width: 200rpx;
  font-size: 28rpx;
  color: #666;
}

.form-value {
  flex: 1;
  font-size: 28rpx;
  color: #333;
}

.form-input {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  padding: 16rpx;
  background: #fafafa;
  border-radius: 8rpx;
  border: 2rpx solid #e8e8e8;
}

.dormitory-info {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 32rpx;
  text-align: center;
}

.info-item {
  padding: 24rpx;
  background: #fafafa;
  border-radius: 16rpx;
}

.info-label {
  font-size: 24rpx;
  color: #666;
  margin-bottom: 8rpx;
}

.info-value {
  font-size: 32rpx;
  font-weight: 600;
  color: #1890ff;
}

.menu-list {
  padding: 0;
}

.menu-item {
  display: flex;
  align-items: center;
  padding: 32rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:active {
  background: #fafafa;
}

.menu-icon {
  font-size: 48rpx;
  margin-right: 32rpx;
}

.menu-text {
  flex: 1;
  font-size: 28rpx;
  color: #333;
}

.menu-arrow {
  font-size: 48rpx;
  color: #999;
}



// pages/register/register.js
const app = getApp()

Page({
  data: {
    formData: {
      username: '',
      password: '',
      confirmPassword: '',
      email: '',
      real_name: '',
      student_id: '',
      phone: ''
    },
    loading: false,
    showPassword: false,
    showConfirmPassword: false,
    agreementChecked: false
  },

  // è¾“å…¥æ¡†ç»‘å®š
  onInput(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`formData.${field}`]: e.detail.value
    })
  },

  // åˆ‡æ¢å¯†ç æ˜¾ç¤º
  togglePassword(field) {
    if (field === 'password') {
      this.setData({
        showPassword: !this.data.showPassword
      })
    } else {
      this.setData({
        showConfirmPassword: !this.data.showConfirmPassword
      })
    }
  },

  // åè®®å‹¾é€‰
  onAgreementChange(e) {
    this.setData({
      agreementChecked: e.detail.value.length > 0
    })
  },

  // æŸ¥çœ‹ç”¨æˆ·åè®®
  viewAgreement() {
    wx.showModal({
      title: 'ç”¨æˆ·åè®®',
      content: 'è¯·éµå®ˆå­¦æ ¡å®¿èˆç®¡ç†è§„å®šï¼Œå¦¥å–„ä½¿ç”¨æœ¬ç³»ç»Ÿã€‚',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    })
  },

  // è¡¨å•éªŒè¯
  validateForm() {
    const { formData, agreementChecked } = this.data

    if (!formData.username.trim()) {
      wx.showToast({ title: 'è¯·è¾“å…¥ç”¨æˆ·å', icon: 'none' })
      return false
    }

    if (formData.username.length < 3 || formData.username.length > 50) {
      wx.showToast({ title: 'ç”¨æˆ·åé•¿åº¦3-50å­—ç¬¦', icon: 'none' })
      return false
    }

    if (!formData.password) {
      wx.showToast({ title: 'è¯·è¾“å…¥å¯†ç ', icon: 'none' })
      return false
    }

    if (formData.password.length < 6) {
      wx.showToast({ title: 'å¯†ç é•¿åº¦è‡³å°‘6ä½', icon: 'none' })
      return false
    }

    if (formData.password !== formData.confirmPassword) {
      wx.showToast({ title: 'ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´', icon: 'none' })
      return false
    }

    if (formData.email && !this.validateEmail(formData.email)) {
      wx.showToast({ title: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', icon: 'none' })
      return false
    }

    if (formData.phone && !this.validatePhone(formData.phone)) {
      wx.showToast({ title: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®', icon: 'none' })
      return false
    }

    if (!agreementChecked) {
      wx.showToast({ title: 'è¯·é˜…è¯»å¹¶åŒæ„ç”¨æˆ·åè®®', icon: 'none' })
      return false
    }

    return true
  },

  // é‚®ç®±éªŒè¯
  validateEmail(email) {
    const reg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
    return reg.test(email)
  },

  // æ‰‹æœºå·éªŒè¯
  validatePhone(phone) {
    const reg = /^1[3-9]\d{9}$/
    return reg.test(phone)
  },

  // è¡¨å•æäº¤
  async handleSubmit() {
    if (!this.validateForm()) {
      return
    }

    this.setData({ loading: true })

    try {
      const { formData } = this.data
      
      const res = await app.request('/auth/register', 'POST', {
        username: formData.username,
        password: formData.password,
        email: formData.email || undefined,
        real_name: formData.real_name || undefined,
        student_id: formData.student_id || undefined,
        phone: formData.phone || undefined
      })

      wx.showToast({
        title: 'æ³¨å†ŒæˆåŠŸ',
        icon: 'success',
        duration: 2000
      })

      // è‡ªåŠ¨ç™»å½•
      app.setToken(res.data.token)
      app.setUserInfo(res.data.user)

      // è·³è½¬åˆ°é¦–é¡µ
      setTimeout(() => {
        wx.reLaunch({
          url: '/pages/index/index'
        })
      }, 1500)

    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
    } finally {
      this.setData({ loading: false })
    }
  },

  // è¿”å›ç™»å½•
  navigateToLogin() {
    wx.navigateBack()
  }
})



{
  "usingComponents": {},
  "navigationBarTitleText": "æ³¨å†Œ"
}



<!--pages/register/register.wxml-->
<view class="container">
  <view class="register-header">
    <view class="title">åˆ›å»ºè´¦æˆ·</view>
    <view class="subtitle">å¡«å†™ä»¥ä¸‹ä¿¡æ¯å®Œæˆæ³¨å†Œ</view>
  </view>

  <view class="register-form">
    <view class="input-group">
      <view class="input-label">ç”¨æˆ·å</view>
      <input
        class="input-field"
        type="text"
        placeholder="è¯·è¾“å…¥ç”¨æˆ·å (3-50å­—ç¬¦)"
        value="{{formData.username}}"
        bindinput="onInput"
        data-field="username"
        maxlength="50"
      />
    </view>

    <view class="input-group">
      <view class="input-label">å¯†ç </view>
      <view class="password-input">
        <input
          class="input-field"
          type="{{showPassword ? 'text' : 'password'}}"
          placeholder="è¯·è¾“å…¥å¯†ç  (è‡³å°‘6ä½)"
          value="{{formData.password}}"
          bindinput="onInput"
          data-field="password"
          maxlength="50"
        />
        <view class="password-toggle" bindtap="togglePassword" data-field="password">
          <text class="icon">{{showPassword ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}}</text>
        </view>
      </view>
    </view>

    <view class="input-group">
      <view class="input-label">ç¡®è®¤å¯†ç </view>
      <view class="password-input">
        <input
          class="input-field"
          type="{{showConfirmPassword ? 'text' : 'password'}}"
          placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
          value="{{formData.confirmPassword}}"
          bindinput="onInput"
          data-field="confirmPassword"
          maxlength="50"
        />
        <view class="password-toggle" bindtap="togglePassword" data-field="confirmPassword">
          <text class="icon">{{showConfirmPassword ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}}</text>
        </view>
      </view>
    </view>

    <view class="input-group">
      <view class="input-label">é‚®ç®±</view>
      <input
        class="input-field"
        type="text"
        placeholder="è¯·è¾“å…¥é‚®ç®± (é€‰å¡«)"
        value="{{formData.email}}"
        bindinput="onInput"
        data-field="email"
      />
    </view>

    <view class="input-group">
      <view class="input-label">çœŸå®å§“å</view>
      <input
        class="input-field"
        type="text"
        placeholder="è¯·è¾“å…¥çœŸå®å§“å (é€‰å¡«)"
        value="{{formData.real_name}}"
        bindinput="onInput"
        data-field="real_name"
      />
    </view>

    <view class="input-group">
      <view class="input-label">å­¦å·</view>
      <input
        class="input-field"
        type="text"
        placeholder="è¯·è¾“å…¥å­¦å· (é€‰å¡«)"
        value="{{formData.student_id}}"
        bindinput="onInput"
        data-field="student_id"
      />
    </view>

    <view class="input-group">
      <view class="input-label">æ‰‹æœºå·</view>
      <input
        class="input-field"
        type="number"
        placeholder="è¯·è¾“å…¥æ‰‹æœºå· (é€‰å¡«)"
        value="{{formData.phone}}"
        bindinput="onInput"
        data-field="phone"
      />
    </view>

    <view class="agreement">
      <checkbox
        checked="{{agreementChecked}}"
        bindchange="onAgreementChange"
      />
      <text class="agreement-text">
        æˆ‘å·²é˜…è¯»å¹¶åŒæ„
        <text class="link" bindtap="viewAgreement">ã€Šç”¨æˆ·åè®®ã€‹</text>
      </text>
    </view>

    <button
      class="btn-primary"
      bindtap="handleSubmit"
      loading="{{loading}}"
      disabled="{{loading || !agreementChecked}}"
    >
      æ³¨å†Œ
    </button>

    <view class="login-link">
      å·²æœ‰è´¦æˆ·ï¼Ÿ
      <text class="link" bindtap="navigateToLogin">ç«‹å³ç™»å½•</text>
    </view>
  </view>
</view>



/* pages/register/register.wxss */

.container {
  min-height: 100vh;
  background: #f5f5f5;
  padding: 40rpx;
}

.register-header {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  font-size: 48rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
}

.subtitle {
  font-size: 28rpx;
  color: #666;
}

.register-form {
  background: #fff;
  border-radius: 32rpx;
  padding: 60rpx 50rpx;
  box-shadow: 0 10rpx 40rpx rgba(0, 0, 0, 0.08);
}

.agreement {
  display: flex;
  align-items: center;
  margin: 40rpx 0 60rpx;
  padding: 20rpx;
  background: #fafafa;
  border-radius: 16rpx;
}

.agreement-text {
  font-size: 24rpx;
  color: #666;
  margin-left: 20rpx;
}

.agreement-text .link {
  color: #1890ff;
}

.login-link {
  text-align: center;
  font-size: 28rpx;
  color: #666;
  margin-top: 40rpx;
}

.login-link .link {
  color: #1890ff;
  margin-left: 10rpx;
}

.login-link .link:active {
  opacity: 0.8;
}



// pages/repair/list/list.js
const app = getApp()

Page({
  data: {
    repairs: [], // æŠ¥ä¿®åˆ—è¡¨
    buildings: [], // æ¥¼æ ‹åˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ï¼‰
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20,
    total: 0,
    userRole: '',
    showFilter: false,
    
    // ç­›é€‰æ¡ä»¶
    filters: {
      building_id: '',
      repair_type: '',
      status: '',
      priority: '',
      start_date: '',
      end_date: ''
    },
    
    // Pickerç´¢å¼•å€¼ï¼ˆä¿®å¤WXMLé”™è¯¯çš„å…³é”®ï¼‰
    buildingIndex: -1,
    repairTypeIndex: 0,
    statusIndex: 0,
    priorityIndex: 0,
    
    // ç­›é€‰é€‰é¡¹
    repairTypeOptions: ['å…¨éƒ¨', 'electricity', 'plumbing', 'furniture', 'air_conditioner', 'other'],
    repairTypeLabels: ['å…¨éƒ¨', 'ç”µåŠ›', 'ç®¡é“', 'å®¶å…·', 'ç©ºè°ƒ', 'å…¶ä»–'],
    statusOptions: ['å…¨éƒ¨', 'pending', 'processing', 'completed', 'cancelled'],
    statusLabels: ['å…¨éƒ¨', 'å¾…å¤„ç†', 'å¤„ç†ä¸­', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'],
    priorityOptions: ['å…¨éƒ¨', 'low', 'medium', 'high', 'urgent'],
    priorityLabels: ['å…¨éƒ¨', 'ä½', 'ä¸­', 'é«˜', 'ç´§æ€¥'],
    
    // å…¶ä»–æ•°æ®
    today: ''
  },

  onLoad(options) {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/repair/list/list')
      })
      return
    }

    const userInfo = app.getUserInfo()
    this.setData({
      userRole: userInfo.role,
      today: this.getTodayDate()
    })

    // å¦‚æœæ˜¯å­¦ç”Ÿï¼Œæ ‡é¢˜æ”¹ä¸ºâ€œæˆ‘çš„æŠ¥ä¿®â€
    if (userInfo.role === 'student') {
      wx.setNavigationBarTitle({
        title: 'æˆ‘çš„æŠ¥ä¿®'
      })
    }

    this.loadBuildings()
    this.loadRepairs()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      repairs: [],
      hasMore: true
    })
    this.loadRepairs()
  },

  // è·å–ä»Šå¤©æ—¥æœŸ
  getTodayDate() {
    const now = new Date()
    const year = now.getFullYear()
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const day = String(now.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  },

  // åŠ è½½æ¥¼æ ‹åˆ—è¡¨
  async loadBuildings() {
    try {
      // å­¦ç”Ÿä¸éœ€è¦æ¥¼æ ‹ç­›é€‰
      if (this.data.userRole === 'student') {
        this.setData({ buildings: [] })
        return
      }

      const res = await app.request('/dormitory/buildings', 'GET', {
        page: 1,
        pageSize: 100,
        status: 'active'
      })

      this.setData({
        buildings: res.data.list
      })

      // æ›´æ–°æ¥¼æ ‹ç´¢å¼•
      this.updateBuildingIndex()

    } catch (error) {
      console.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥:', error)
    }
  },

  // æ›´æ–°æ¥¼æ ‹ç­›é€‰ç´¢å¼•
  updateBuildingIndex() {
    let buildingIndex = -1
    if (this.data.filters.building_id && this.data.buildings.length > 0) {
      buildingIndex = this.data.buildings.findIndex(b => b.id == this.data.filters.building_id)
    }
    
    this.setData({
      buildingIndex: buildingIndex
    })
  },

  // æ›´æ–°å…¶ä»–ç­›é€‰ç´¢å¼•
  updateFilterIndexes() {
    let repairTypeIndex = 0
    if (this.data.filters.repair_type) {
      repairTypeIndex = this.data.repairTypeOptions.indexOf(this.data.filters.repair_type)
      if (repairTypeIndex === -1) repairTypeIndex = 0
    }
    
    let statusIndex = 0
    if (this.data.filters.status) {
      statusIndex = this.data.statusOptions.indexOf(this.data.filters.status)
      if (statusIndex === -1) statusIndex = 0
    }
    
    let priorityIndex = 0
    if (this.data.filters.priority) {
      priorityIndex = this.data.priorityOptions.indexOf(this.data.filters.priority)
      if (priorityIndex === -1) priorityIndex = 0
    }
    
    this.setData({
      repairTypeIndex: repairTypeIndex,
      statusIndex: statusIndex,
      priorityIndex: priorityIndex
    })
  },

  // åŠ è½½æŠ¥ä¿®åˆ—è¡¨
  async loadRepairs(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        repairs: [],
        loading: true
      })
    }

    try {
      let url = '/repairs'
      if (this.data.userRole === 'student') {
        url = '/students/my/repairs'
      }

      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      const res = await app.request(url, 'GET', params)

      const newRepairs = loadMore ? 
        [...this.data.repairs, ...res.data.list] : 
        res.data.list

      this.setData({
        repairs: newRepairs,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½æŠ¥ä¿®åˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // æœç´¢è¾“å…¥
  onSearchInput(e) {
    this.setData({
      'filters.keyword': e.detail.value
    })
  },

  // æ‰§è¡Œæœç´¢
  onSearch() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadRepairs()
  },

  // æ¥¼æ ‹ç­›é€‰å˜åŒ–
  onBuildingChange(e) {
    const index = parseInt(e.detail.value)
    const buildingId = index >= 0 ? this.data.buildings[index].id : ''
    
    this.setData({
      'filters.building_id': buildingId,
      buildingIndex: index
    })
    
    this.onSearch()
  },

  // æŠ¥ä¿®ç±»å‹ç­›é€‰å˜åŒ–
  onRepairTypeChange(e) {
    const index = parseInt(e.detail.value)
    const repairType = index > 0 ? this.data.repairTypeOptions[index] : ''
    
    this.setData({
      'filters.repair_type': repairType,
      repairTypeIndex: index
    })
    
    this.onSearch()
  },

  // çŠ¶æ€ç­›é€‰å˜åŒ–
  onStatusChange(e) {
    const index = parseInt(e.detail.value)
    const status = index > 0 ? this.data.statusOptions[index] : ''
    
    this.setData({
      'filters.status': status,
      statusIndex: index
    })
    
    this.onSearch()
  },

  // ä¼˜å…ˆçº§ç­›é€‰å˜åŒ–
  onPriorityChange(e) {
    const index = parseInt(e.detail.value)
    const priority = index > 0 ? this.data.priorityOptions[index] : ''
    
    this.setData({
      'filters.priority': priority,
      priorityIndex: index
    })
    
    this.onSearch()
  },

  // æ—¥æœŸç­›é€‰å˜åŒ–
  onDateChange(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`filters.${field}`]: e.detail.value
    })
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    // æ˜¾ç¤ºç­›é€‰é¢æ¿å‰æ›´æ–°æ‰€æœ‰ç´¢å¼•å€¼
    if (!this.data.showFilter) {
      this.updateBuildingIndex()
      this.updateFilterIndexes()
    }
    
    this.setData({
      showFilter: !this.data.showFilter
    })
  },

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    this.setData({
      showFilter: false,
      page: 1,
      hasMore: true
    })
    this.loadRepairs()
  },

  // é‡ç½®ç­›é€‰
  resetFilters() {
    const resetData = {
      filters: {
        building_id: '',
        repair_type: '',
        status: '',
        priority: '',
        start_date: '',
        end_date: '',
        keyword: ''
      },
      buildingIndex: -1,
      repairTypeIndex: 0,
      statusIndex: 0,
      priorityIndex: 0,
      page: 1,
      hasMore: true
    }
    
    this.setData(resetData)
    this.loadRepairs()
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadRepairs(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadRepairs().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹æŠ¥ä¿®è¯¦æƒ…
  viewRepairDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/repair/detail/detail?id=${id}`
    })
  },

  // æäº¤æ–°æŠ¥ä¿®
  submitNewRepair() {
    wx.navigateTo({
      url: '/pages/repair/submit/submit'
    })
  },

  // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
  formatStatus(status) {
    const statusMap = {
      'pending': 'å¾…å¤„ç†',
      'processing': 'å¤„ç†ä¸­',
      'completed': 'å·²å®Œæˆ',
      'cancelled': 'å·²å–æ¶ˆ'
    }
    return statusMap[status] || status
  },

  // æ ¼å¼åŒ–æŠ¥ä¿®ç±»å‹æ˜¾ç¤º
  formatRepairType(type) {
    const typeMap = {
      'electricity': 'ç”µåŠ›',
      'plumbing': 'ç®¡é“',
      'furniture': 'å®¶å…·',
      'air_conditioner': 'ç©ºè°ƒ',
      'other': 'å…¶ä»–'
    }
    return typeMap[type] || type
  },

  // æ ¼å¼åŒ–ä¼˜å…ˆçº§æ˜¾ç¤º
  formatPriority(priority) {
    const priorityMap = {
      'low': 'ä½',
      'medium': 'ä¸­',
      'high': 'é«˜',
      'urgent': 'ç´§æ€¥'
    }
    return priorityMap[priority] || priority
  },

  // è·å–çŠ¶æ€æ ‡ç­¾çš„ç±»å
  getStatusClass(status) {
    return `status-${status}`
  },

  // è·å–ä¼˜å…ˆçº§æ ‡ç­¾çš„ç±»å
  getPriorityClass(priority) {
    return `priority-${priority}`
  },

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(time) {
    if (!time) return ''
    const date = new Date(time)
    const month = date.getMonth() + 1
    const day = date.getDate()
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    return `${month}/${day} ${hours}:${minutes}`
  },

  // è·å–æ¥¼æ ‹æ˜¾ç¤ºæ–‡æœ¬
  getBuildingDisplayText() {
    if (this.data.buildingIndex >= 0) {
      return this.data.buildings[this.data.buildingIndex].building_name
    }
    return 'å…¨éƒ¨æ¥¼æ ‹'
  },

  // è·å–æŠ¥ä¿®ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
  getRepairTypeDisplayText() {
    return this.data.repairTypeLabels[this.data.repairTypeIndex]
  },

  // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
  getStatusDisplayText() {
    return this.data.statusLabels[this.data.statusIndex]
  },

  // è·å–ä¼˜å…ˆçº§æ˜¾ç¤ºæ–‡æœ¬
  getPriorityDisplayText() {
    return this.data.priorityLabels[this.data.priorityIndex]
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "æŠ¥ä¿®ç®¡ç†"
}



<!--pages/repair/list/list.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="{{userRole === 'student' ? 'æœç´¢æˆ‘çš„æŠ¥ä¿®' : 'æœç´¢æŠ¥ä¿®ç¼–å·æˆ–æˆ¿é—´å·'}}"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <!-- æ¥¼æ ‹ç­›é€‰ï¼ˆç®¡ç†å‘˜/å®¿ç®¡å¯è§ï¼‰ -->
    <view class="filter-item" wx:if="{{userRole === 'admin' || userRole === 'staff'}}">
      <view class="filter-label">æ¥¼æ ‹</view>
      <picker
        range="{{buildings}}"
        range-key="building_name"
        value="{{buildingIndex}}"
        bindchange="onBuildingChange"
      >
        <view class="filter-value">
          {{getBuildingDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">æŠ¥ä¿®ç±»å‹</view>
      <picker
        range="{{repairTypeOptions}}"
        range-key="{{repairTypeLabels}}"
        value="{{repairTypeIndex}}"
        bindchange="onRepairTypeChange"
      >
        <view class="filter-value">
          {{getRepairTypeDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">å¤„ç†çŠ¶æ€</view>
      <picker
        range="{{statusOptions}}"
        range-key="{{statusLabels}}"
        value="{{statusIndex}}"
        bindchange="onStatusChange"
      >
        <view class="filter-value">
          {{getStatusDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">ä¼˜å…ˆçº§</view>
      <picker
        range="{{priorityOptions}}"
        range-key="{{priorityLabels}}"
        value="{{priorityIndex}}"
        bindchange="onPriorityChange"
      >
        <view class="filter-value">
          {{getPriorityDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">å¼€å§‹æ—¥æœŸ</view>
      <picker
        mode="date"
        start="2023-01-01"
        end="{{today}}"
        value="{{filters.start_date}}"
        bindchange="onDateChange"
        data-field="start_date"
      >
        <view class="filter-value">
          {{filters.start_date || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">ç»“æŸæ—¥æœŸ</view>
      <picker
        mode="date"
        start="{{filters.start_date || '2023-01-01'}}"
        end="{{today}}"
        value="{{filters.end_date}}"
        bindchange="onDateChange"
        data-field="end_date"
      >
        <view class="filter-value">
          {{filters.end_date || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-actions">
      <view class="filter-action-btn" bindtap="resetFilters">é‡ç½®</view>
      <view class="filter-action-btn primary" bindtap="applyFilters">åº”ç”¨</view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{userRole === 'student'}}">
    <button class="btn-primary" bindtap="submitNewRepair">æˆ‘è¦æŠ¥ä¿®</button>
  </view>

  <!-- æŠ¥ä¿®åˆ—è¡¨ -->
  <view class="repair-list">
    <block wx:for="{{repairs}}" wx:key="id">
      <view 
        class="repair-item card" 
        bindtap="viewRepairDetail"
        data-id="{{item.id}}"
      >
        <view class="repair-header">
          <view class="repair-title">
            <text class="repair-number">{{item.repair_number}}</text>
            <text class="repair-type">{{formatRepairType(item.repair_type)}}</text>
          </view>
          <view class="repair-meta">
            <text class="repair-status {{getStatusClass(item.status)}}">
              {{formatStatus(item.status)}}
            </text>
            <text class="repair-priority {{getPriorityClass(item.priority)}}">
              {{formatPriority(item.priority)}}
            </text>
          </view>
        </view>

        <view class="repair-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">ä½ç½®ï¼š</text>
              <text class="info-value">{{item.building_name}} {{item.room_number}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">é—®é¢˜æè¿°ï¼š</text>
              <text class="info-value">{{item.description}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æäº¤äººï¼š</text>
              <text class="info-value">{{item.student_name}} ({{item.student_id}})</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æäº¤æ—¶é—´ï¼š</text>
              <text class="info-value">{{formatTime(item.created_at)}}</text>
            </view>
            <view class="info-item">
              <text class="info-label" wx:if="{{item.completed_at}}">å®Œæˆæ—¶é—´ï¼š</text>
              <text class="info-value" wx:if="{{item.completed_at}}">{{formatTime(item.completed_at)}}</text>
            </view>
          </view>
          <view class="info-row" wx:if="{{item.staff_name}}">
            <view class="info-item">
              <text class="info-label">å¤„ç†äººå‘˜ï¼š</text>
              <text class="info-value">{{item.staff_name}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && repairs.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && repairs.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">
      {{userRole === 'student' ? 'æ‚¨è¿˜æ²¡æœ‰æäº¤è¿‡æŠ¥ä¿®' : 'æš‚æ— æŠ¥ä¿®è®°å½•'}}
    </view>
    <view class="empty-action" wx:if="{{userRole === 'student'}}" bindtap="submitNewRepair">
      å»æŠ¥ä¿®
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && repairs.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && repairs.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/repair/list/list.wxss */
/* pages/repair/list/list.wxss */

.repair-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.repair-title {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.repair-number {
  font-size: 28rpx;
  color: #666;
  margin-right: 20rpx;
}

.repair-type {
  font-size: 24rpx;
  color: #1890ff;
  background: #e6f7ff;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.repair-status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 16rpx;
}

.repair-status.status-pending {
  background: #fff7e6;
  color: #fa8c16;
}

.repair-status.status-processing {
  background: #e6f7ff;
  color: #1890ff;
}

.repair-status.status-completed {
  background: #f6ffed;
  color: #52c41a;
}

.repair-status.status-cancelled {
  background: #f5f5f5;
  color: #999;
}

.repair-info {
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-item {
  flex: 1;
}

.info-item.full-width {
  flex: 0 0 100%;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.priority-low {
  color: #52c41a;
}

.priority-medium {
  color: #fa8c16;
}

.priority-high {
  color: #f5222d;
}

.priority-urgent {
  color: #f5222d;
  font-weight: bold;
}

.repair-footer {
  text-align: right;
}

.repair-time {
  font-size: 24rpx;
  color: #999;
}

.empty-action {
  margin-top: 30rpx;
  padding: 20rpx 40rpx;
  background: #1890ff;
  color: #fff;
  border-radius: 8rpx;
  display: inline-block;
  font-size: 28rpx;
}



// pages/repair/submit/submit.js
const app = getApp()

Page({
  data: {
    formData: {
      repair_type: 'electricity',
      description: '',
      priority: 'medium',
      images: []
    },
    uploading: false,
    submitting: false,
    userInfo: null
  },

  onLoad() {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/repair/submit/submit')
      })
      return
    }

    const userInfo = app.getUserInfo()
    if (userInfo.role !== 'student') {
      app.showPermissionError()
      wx.navigateBack()
      return
    }

    this.setData({
      userInfo
    })
  },

  // è¡¨å•è¾“å…¥å¤„ç†
  onInput(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`formData.${field}`]: e.detail.value
    })
  },

  // é€‰æ‹©æŠ¥ä¿®ç±»å‹
  onRepairTypeChange(e) {
    this.setData({
      'formData.repair_type': e.detail.value
    })
  },

  // é€‰æ‹©ä¼˜å…ˆçº§
  onPriorityChange(e) {
    this.setData({
      'formData.priority': e.detail.value
    })
  },

  // é€‰æ‹©å›¾ç‰‡
  async chooseImage() {
    if (this.data.formData.images.length >= 9) {
      wx.showToast({
        title: 'æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡',
        icon: 'none'
      })
      return
    }

    try {
      const res = await wx.chooseMedia({
        count: 9 - this.data.formData.images.length,
        mediaType: ['image'],
        sourceType: ['album', 'camera'],
        maxDuration: 30,
        camera: 'back'
      })

      if (res.tempFiles && res.tempFiles.length > 0) {
        this.setData({
          uploading: true
        })

        // ä¸Šä¼ å›¾ç‰‡
        const uploadPromises = res.tempFiles.map(file => this.uploadImage(file.tempFilePath))
        const results = await Promise.all(uploadPromises)
        
        const newImages = [...this.data.formData.images]
        results.forEach(result => {
          if (result) {
            newImages.push(result)
          }
        })

        this.setData({
          'formData.images': newImages,
          uploading: false
        })
      }

    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error)
      this.setData({ uploading: false })
    }
  },

  // ä¸Šä¼ å•å¼ å›¾ç‰‡
  async uploadImage(filePath) {
    try {
      // è¿™é‡Œéœ€è¦æ ¹æ®åç«¯æ¥å£å®ç°æ–‡ä»¶ä¸Šä¼ 
      // å‡è®¾åç«¯æœ‰ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ¥å£ /upload/image
      const res = await app.uploadFile('/upload/image', filePath)
      return res.data.url // è¿”å›å›¾ç‰‡URL
    } catch (error) {
      console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error)
      wx.showToast({
        title: 'ä¸Šä¼ å¤±è´¥',
        icon: 'none'
      })
      return null
    }
  },

  // åˆ é™¤å›¾ç‰‡
  deleteImage(e) {
    const { index } = e.currentTarget.dataset
    const images = [...this.data.formData.images]
    images.splice(index, 1)
    this.setData({
      'formData.images': images
    })
  },

  // é¢„è§ˆå›¾ç‰‡
  previewImage(e) {
    const { index } = e.currentTarget.dataset
    const urls = this.data.formData.images.map(img => {
      if (typeof img === 'string') {
        return img.startsWith('http') ? img : `https://example.com${img}`
      }
      return img.url || img
    })
    
    wx.previewImage({
      current: urls[index],
      urls: urls
    })
  },

  // æäº¤æŠ¥ä¿®
  async submitRepair() {
    if (!this.validateForm()) {
      return
    }

    this.setData({ submitting: true })

    try {
      const formData = {
        ...this.data.formData,
        images: JSON.stringify(this.data.formData.images)
      }

      const res = await app.request('/repairs', 'POST', formData)

      wx.showToast({
        title: 'æŠ¥ä¿®æäº¤æˆåŠŸ',
        icon: 'success',
        duration: 2000
      })

      setTimeout(() => {
        wx.navigateBack()
      }, 1500)

    } catch (error) {
      console.error('æäº¤æŠ¥ä¿®å¤±è´¥:', error)
      this.setData({ submitting: false })
    }
  },

  // è¡¨å•éªŒè¯
  validateForm() {
    const { description } = this.data.formData

    if (!description || description.trim().length < 5) {
      wx.showToast({
        title: 'è¯·è¯¦ç»†æè¿°é—®é¢˜ï¼ˆè‡³å°‘5ä¸ªå­—ï¼‰',
        icon: 'none'
      })
      return false
    }

    if (description.length > 500) {
      wx.showToast({
        title: 'é—®é¢˜æè¿°ä¸èƒ½è¶…è¿‡500å­—',
        icon: 'none'
      })
      return false
    }

    return true
  },

  // æ ¼å¼åŒ–æŠ¥ä¿®ç±»å‹æ˜¾ç¤º
  formatRepairType(type) {
    const typeMap = {
      'electricity': 'ç”µè·¯é—®é¢˜',
      'plumbing': 'æ°´ç®¡é—®é¢˜',
      'furniture': 'å®¶å…·é—®é¢˜',
      'air_conditioner': 'ç©ºè°ƒé—®é¢˜',
      'other': 'å…¶ä»–é—®é¢˜'
    }
    return typeMap[type] || type
  },

  // æ ¼å¼åŒ–ä¼˜å…ˆçº§æ˜¾ç¤º
  formatPriority(priority) {
    const priorityMap = {
      'low': 'ä½',
      'medium': 'ä¸­',
      'high': 'é«˜',
      'urgent': 'ç´§æ€¥'
    }
    return priorityMap[priority] || priority
  }
})



{
  "usingComponents": {},
  "navigationBarTitleText": "æäº¤æŠ¥ä¿®"
}



<!--pages/repair/submit/submit.wxml-->
<view class="container">
  <view class="form-card card">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">æŠ¥ä¿®äººä¿¡æ¯</view>
      <view class="info-row">
        <view class="info-label">å§“å</view>
        <view class="info-value">{{userInfo.real_name || userInfo.username}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">å­¦å·</view>
        <view class="info-value">{{userInfo.student_id || '--'}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">å®¿èˆ</view>
        <view class="info-value">
          {{userInfo.building_info ? userInfo.building_info.building_name + ' ' + userInfo.building_info.room_number : 'æœªåˆ†é…å®¿èˆ'}}
        </view>
      </view>
    </view>

    <!-- æŠ¥ä¿®ç±»å‹ -->
    <view class="form-section">
      <view class="section-title">æŠ¥ä¿®ç±»å‹</view>
      <picker 
        range="{{['electricity', 'plumbing', 'furniture', 'air_conditioner', 'other']}}"
        range-key="{{['ç”µè·¯é—®é¢˜', 'æ°´ç®¡é—®é¢˜', 'å®¶å…·é—®é¢˜', 'ç©ºè°ƒé—®é¢˜', 'å…¶ä»–é—®é¢˜']}}"
        value="{{['electricity', 'plumbing', 'furniture', 'air_conditioner', 'other'].indexOf(formData.repair_type)}}"
        bindchange="onRepairTypeChange"
      >
        <view class="picker-item">
          <text>{{formatRepairType(formData.repair_type)}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- ä¼˜å…ˆçº§ -->
    <view class="form-section">
      <view class="section-title">ä¼˜å…ˆçº§</view>
      <picker 
        range="{{['low', 'medium', 'high', 'urgent']}}"
        range-key="{{['ä½', 'ä¸­', 'é«˜', 'ç´§æ€¥']}}"
        value="{{['low', 'medium', 'high', 'urgent'].indexOf(formData.priority)}}"
        bindchange="onPriorityChange"
      >
        <view class="picker-item">
          <text>{{formatPriority(formData.priority)}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- é—®é¢˜æè¿° -->
    <view class="form-section">
      <view class="section-title">é—®é¢˜æè¿°</view>
      <textarea 
        class="textarea-field"
        placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ï¼ˆè‡³å°‘5ä¸ªå­—ï¼‰"
        value="{{formData.description}}"
        bindinput="onInput"
        data-field="description"
        maxlength="500"
        auto-height
      ></textarea>
      <view class="word-count">{{formData.description.length}}/500</view>
    </view>

    <!-- å›¾ç‰‡ä¸Šä¼  -->
    <view class="form-section">
      <view class="section-title">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</view>
      <view class="image-upload">
        <block wx:for="{{formData.images}}" wx:key="index">
          <view class="image-item">
            <image 
              src="{{item}}" 
              mode="aspectFill"
              bindtap="previewImage"
              data-index="{{index}}"
            ></image>
            <view 
              class="image-delete"
              bindtap="deleteImage"
              data-index="{{index}}"
            >
              Ã—
            </view>
          </view>
        </block>
        <view 
          class="image-upload-btn" 
          bindtap="chooseImage"
          wx:if="{{formData.images.length < 9 && !uploading}}"
        >
          <text class="upload-icon">+</text>
          <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
        </view>
        <view class="image-upload-btn" wx:if="{{uploading}}">
          <text class="upload-text">ä¸Šä¼ ä¸­...</text>
        </view>
      </view>
      <view class="image-tips">æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡ï¼Œæ¯å¼ ä¸è¶…è¿‡5MB</view>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="form-actions">
    <button 
      class="btn-primary {{submitting ? 'btn-disabled' : ''}}"
      bindtap="submitRepair"
      disabled="{{submitting}}"
    >
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤æŠ¥ä¿®'}}
    </button>
  </view>
</view>



/* pages/repair/submit/submit.wxss */

.form-section {
  margin-bottom: 40rpx;
}

.form-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.picker-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
}

.picker-arrow {
  color: #999;
  font-size: 24rpx;
}

.textarea-field {
  width: 100%;
  min-height: 200rpx;
  padding: 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
  box-sizing: border-box;
  line-height: 1.5;
}

.word-count {
  text-align: right;
  font-size: 24rpx;
  color: #999;
  margin-top: 10rpx;
}

.image-upload {
  display: flex;
  flex-wrap: wrap;
  gap: 20rpx;
}

.image-item {
  position: relative;
  width: 160rpx;
  height: 160rpx;
  border-radius: 8rpx;
  overflow: hidden;
}

.image-item image {
  width: 100%;
  height: 100%;
}

.image-delete {
  position: absolute;
  top: 0;
  right: 0;
  width: 40rpx;
  height: 40rpx;
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  font-size: 32rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0 0 0 8rpx;
}

.image-upload-btn {
  width: 160rpx;
  height: 160rpx;
  border: 2rpx dashed #d9d9d9;
  border-radius: 8rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #999;
}

.upload-icon {
  font-size: 48rpx;
  margin-bottom: 10rpx;
}

.upload-text {
  font-size: 24rpx;
}

.image-tips {
  font-size: 24rpx;
  color: #999;
  margin-top: 10rpx;
}

.form-actions {
  margin-top: 60rpx;
}



// pages/visitor/list/list.js
const app = getApp()

Page({
  data: {
    visitors: [],
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20,
    total: 0,
    filters: {
      status: '',
      relationship: '',
      start_date: '',
      end_date: ''
    },
    userRole: '',
    showFilter: false,
    today: ''
  },

  onLoad() {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/visitor/list/list')
      })
      return
    }

    const userInfo = app.getUserInfo()
    this.setData({
      userRole: userInfo.role,
      today: this.getTodayDate()
    })

    this.loadVisitors()
  },

  onShow() {
    // åˆ·æ–°æ•°æ®
    this.setData({
      page: 1,
      visitors: [],
      hasMore: true
    })
    this.loadVisitors()
  },

  // è·å–ä»Šå¤©æ—¥æœŸ
  getTodayDate() {
    const now = new Date()
    const year = now.getFullYear()
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const day = String(now.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  },

  // åŠ è½½è®¿å®¢è®°å½•
  async loadVisitors(loadMore = false) {
    if (this.data.loading) return

    if (!loadMore) {
      this.setData({
        page: 1,
        visitors: [],
        loading: true
      })
    }

    try {
      let url = '/visitors'
      if (this.data.userRole === 'student') {
        url = '/students/my/visitors'
      }

      const params = {
        page: this.data.page,
        pageSize: this.data.pageSize,
        ...this.data.filters
      }

      const res = await app.request(url, 'GET', params)

      const newVisitors = loadMore ? 
        [...this.data.visitors, ...res.data.list] : 
        res.data.list

      this.setData({
        visitors: newVisitors,
        total: res.data.pagination.total,
        hasMore: this.data.page * this.data.pageSize < res.data.pagination.total,
        loading: false
      })

    } catch (error) {
      console.error('åŠ è½½è®¿å®¢è®°å½•å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
      this.setData({ loading: false })
    }
  },

  // ç­›é€‰æ¡ä»¶å˜åŒ–
  onFilterChange(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`filters.${field}`]: e.detail.value
    })
  },

  // æ—¥æœŸé€‰æ‹©å˜åŒ–
  onDateChange(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`filters.${field}`]: e.detail.value
    })
  },

  // åˆ‡æ¢ç­›é€‰é¢æ¿
  toggleFilter() {
    this.setData({
      showFilter: !this.data.showFilter
    })
  },

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    this.setData({
      showFilter: false,
      page: 1,
      hasMore: true
    })
    this.loadVisitors()
  },

  // é‡ç½®ç­›é€‰
  resetFilters() {
    this.setData({
      filters: {
        status: '',
        relationship: '',
        start_date: '',
        end_date: ''
      },
      page: 1,
      hasMore: true
    })
    this.loadVisitors()
  },

  // åŠ è½½æ›´å¤š
  onLoadMore() {
    if (!this.data.hasMore || this.data.loading) return

    this.setData({
      page: this.data.page + 1
    })
    this.loadVisitors(true)
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true
    })
    this.loadVisitors().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  // æŸ¥çœ‹è®¿å®¢è¯¦æƒ…
  viewVisitorDetail(e) {
    const { id } = e.currentTarget.dataset
    wx.navigateTo({
      url: `/pages/visitor/detail/detail?id=${id}`
    })
  },

  // ç™»è®°è®¿å®¢
  registerVisitor() {
    wx.navigateTo({
      url: '/pages/visitor/register/register'
    })
  },

  // æ ‡è®°åˆ°è¾¾
  async markArrived(e) {
    const { id, index } = e.currentTarget.dataset
    const visitor = this.data.visitors[index]

    wx.showModal({
      title: 'ç¡®è®¤åˆ°è¾¾',
      content: `ç¡®è®¤è®¿å®¢"${visitor.visitor_name}"å·²åˆ°è¾¾å—ï¼Ÿ`,
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/visitors/${id}/arrive`, 'POST')

            wx.showToast({
              title: 'æ ‡è®°æˆåŠŸ',
              icon: 'success'
            })

            // æ›´æ–°æœ¬åœ°æ•°æ®
            const visitors = [...this.data.visitors]
            visitors[index].status = 'arrived'
            visitors[index].actual_arrival = new Date().toISOString()
            this.setData({ visitors })

          } catch (error) {
            console.error('æ ‡è®°åˆ°è¾¾å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // æ ‡è®°ç¦»å¼€
  async markLeft(e) {
    const { id, index } = e.currentTarget.dataset
    const visitor = this.data.visitors[index]

    wx.showModal({
      title: 'ç¡®è®¤ç¦»å¼€',
      content: `ç¡®è®¤è®¿å®¢"${visitor.visitor_name}"å·²ç¦»å¼€å—ï¼Ÿ`,
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/visitors/${id}/leave`, 'POST')

            wx.showToast({
              title: 'æ ‡è®°æˆåŠŸ',
              icon: 'success'
            })

            // æ›´æ–°æœ¬åœ°æ•°æ®
            const visitors = [...this.data.visitors]
            visitors[index].status = 'left'
            visitors[index].actual_leave = new Date().toISOString()
            this.setData({ visitors })

          } catch (error) {
            console.error('æ ‡è®°ç¦»å¼€å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // å–æ¶ˆç™»è®°
  async cancelVisitor(e) {
    const { id, index } = e.currentTarget.dataset
    const visitor = this.data.visitors[index]

    wx.showModal({
      title: 'å–æ¶ˆç™»è®°',
      content: `ç¡®å®šè¦å–æ¶ˆ"${visitor.visitor_name}"çš„è®¿å®¢ç™»è®°å—ï¼Ÿ`,
      confirmColor: '#fa541c',
      success: async (res) => {
        if (res.confirm) {
          try {
            await app.request(`/visitors/${id}/cancel`, 'POST')

            wx.showToast({
              title: 'å–æ¶ˆæˆåŠŸ',
              icon: 'success'
            })

            // æ›´æ–°æœ¬åœ°æ•°æ®
            const visitors = [...this.data.visitors]
            visitors[index].status = 'cancelled'
            this.setData({ visitors })

          } catch (error) {
            console.error('å–æ¶ˆç™»è®°å¤±è´¥:', error)
          }
        }
      }
    })
  },

  // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
  formatStatus(status) {
    const statusMap = {
      'pending': 'å¾…åˆ°è¾¾',
      'arrived': 'å·²åˆ°è¾¾',
      'left': 'å·²ç¦»å¼€',
      'cancelled': 'å·²å–æ¶ˆ'
    }
    return statusMap[status] || status
  },

  // æ ¼å¼åŒ–å…³ç³»æ˜¾ç¤º
  formatRelationship(rel) {
    const relMap = {
      'family': 'å®¶äºº',
      'friend': 'æœ‹å‹',
      'relative': 'äº²æˆš',
      'other': 'å…¶ä»–'
    }
    return relMap[rel] || rel
  },

  // è·å–çŠ¶æ€æ ‡ç­¾çš„ç±»å
  getStatusClass(status) {
    return `status-${status}`
  },

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(time) {
    if (!time) return ''
    const date = new Date(time)
    const month = date.getMonth() + 1
    const day = date.getDate()
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    return `${month}/${day} ${hours}:${minutes}`
  },

  // åˆ¤æ–­æ˜¯å¦å¯æ“ä½œ
  canOperate(visitor) {
    if (this.data.userRole === 'student') {
      return visitor.status === 'pending'
    }
    return visitor.status === 'pending' || visitor.status === 'arrived'
  }
})



{
  "usingComponents": {},
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark",
  "navigationBarTitleText": "è®¿å®¢è®°å½•"
}



<!--pages/visitor/list/list.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input
        type="text"
        placeholder="æœç´¢è®¿å®¢å§“å"
        value="{{filters.keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <text class="search-icon" bindtap="onSearch">ğŸ”</text>
    </view>
    <view class="filter-btn" bindtap="toggleFilter">
      <text>ç­›é€‰</text>
      <text class="filter-icon">â–¼</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <view class="filter-item">
      <view class="filter-label">çŠ¶æ€</view>
      <picker
        range="{{statusOptions}}"
        range-key="{{statusLabels}}"
        value="{{statusIndex}}"
        bindchange="onStatusChange"
      >
        <view class="filter-value">
          {{getStatusDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">å…³ç³»</view>
      <picker
        range="{{relationshipOptions}}"
        range-key="{{relationshipLabels}}"
        value="{{relationshipIndex}}"
        bindchange="onRelationshipChange"
      >
        <view class="filter-value">
          {{getRelationshipDisplayText()}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">å¼€å§‹æ—¥æœŸ</view>
      <picker
        mode="date"
        start="2023-01-01"
        end="{{today}}"
        value="{{filters.start_date}}"
        bindchange="onDateChange"
        data-field="start_date"
      >
        <view class="filter-value">
          {{filters.start_date || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-item">
      <view class="filter-label">ç»“æŸæ—¥æœŸ</view>
      <picker
        mode="date"
        start="{{filters.start_date || '2023-01-01'}}"
        end="{{today}}"
        value="{{filters.end_date}}"
        bindchange="onDateChange"
        data-field="end_date"
      >
        <view class="filter-value">
          {{filters.end_date || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
        </view>
      </picker>
    </view>

    <view class="filter-actions">
      <view class="filter-action-btn" bindtap="resetFilters">é‡ç½®</view>
      <view class="filter-action-btn primary" bindtap="applyFilters">åº”ç”¨</view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-bar" wx:if="{{userRole === 'student'}}">
    <button class="btn-primary" bindtap="registerVisitor">è®¿å®¢ç™»è®°</button>
  </view>

  <!-- è®¿å®¢åˆ—è¡¨ -->
  <view class="visitor-list">
    <block wx:for="{{visitors}}" wx:key="id" wx:for-index="idx">
      <view 
        class="visitor-item card" 
        bindtap="viewVisitorDetail"
        data-id="{{item.id}}"
      >
        <view class="visitor-header">
          <view class="visitor-title">
            <text class="visitor-name">{{item.visitor_name}}</text>
            <text class="visitor-relationship">{{formatRelationship(item.relationship)}}</text>
          </view>
          <view class="visitor-status {{getStatusClass(item.status)}}">
            {{formatStatus(item.status)}}
          </view>
        </view>

        <view class="visitor-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æ‰‹æœºï¼š</text>
              <text class="info-value">{{item.visitor_phone}}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æ¥è®¿å®¿èˆï¼š</text>
              <text class="info-value">{{item.building_name}} {{item.room_number}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">é¢„è®¡åˆ°è¾¾ï¼š</text>
              <text class="info-value">{{formatTime(item.expected_arrival)}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">é¢„è®¡ç¦»å¼€ï¼š</text>
              <text class="info-value">{{formatTime(item.expected_leave)}}</text>
            </view>
          </view>
          <view class="info-row" wx:if="{{item.actual_arrival}}">
            <view class="info-item">
              <text class="info-label">å®é™…åˆ°è¾¾ï¼š</text>
              <text class="info-value">{{formatTime(item.actual_arrival)}}</text>
            </view>
          </view>
          <view class="info-row" wx:if="{{item.actual_leave}}">
            <view class="info-item">
              <text class="info-label">å®é™…ç¦»å¼€ï¼š</text>
              <text class="info-value">{{formatTime(item.actual_leave)}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="visitor-actions" wx:if="{{canOperate(item)}}">
          <view 
            class="action-btn" 
            wx:if="{{(userRole === 'admin' || userRole === 'staff') && item.status === 'pending'}}"
            bindtap="markArrived"
            data-id="{{item.id}}"
            data-index="{{idx}}"
          >
            åˆ°è¾¾
          </view>
          <view 
            class="action-btn" 
            wx:if="{{(userRole === 'admin' || userRole === 'staff') && item.status === 'arrived'}}"
            bindtap="markLeft"
            data-id="{{item.id}}"
            data-index="{{idx}}"
          >
            ç¦»å¼€
          </view>
          <view 
            class="action-btn cancel" 
            bindtap="cancelVisitor"
            data-id="{{item.id}}"
            data-index="{{idx}}"
            wx:if="{{item.status === 'pending'}}"
          >
            å–æ¶ˆ
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading && visitors.length === 0}}">
    <image src="/images/loading.gif" class="loading-image"></image>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && visitors.length === 0}}">
    <image src="/images/empty.png" class="empty-image"></image>
    <view class="empty-text">æš‚æ— è®¿å®¢è®°å½•</view>
    <view class="empty-action" wx:if="{{userRole === 'student'}}" bindtap="registerVisitor">
      å»ç™»è®°
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    class="load-more" 
    wx:if="{{!loading && hasMore && visitors.length > 0}}"
    bindtap="onLoadMore"
  >
    <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
  </view>

  <view class="load-more" wx:if="{{!hasMore && visitors.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
  </view>
</view>



/* pages/visitor/list/list.wxss */

.visitor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.visitor-title {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.visitor-name {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-right: 20rpx;
}

.visitor-relationship {
  font-size: 24rpx;
  color: #1890ff;
  background: #e6f7ff;
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.visitor-status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 16rpx;
}

.visitor-status.status-pending {
  background: #fff7e6;
  color: #fa8c16;
}

.visitor-status.status-arrived {
  background: #e6f7ff;
  color: #1890ff;
}

.visitor-status.status-left {
  background: #f6ffed;
  color: #52c41a;
}

.visitor-status.status-cancelled {
  background: #f5f5f5;
  color: #999;
}

.visitor-info {
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  margin-bottom: 16rpx;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-item {
  flex: 1;
}

.info-label {
  font-size: 28rpx;
  color: #666;
  min-width: 120rpx;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
  flex: 1;
}

.visitor-actions {
  display: flex;
  gap: 20rpx;
  flex-wrap: wrap;
  padding-top: 20rpx;
  border-top: 2rpx solid #f0f0f0;
}

.action-btn {
  padding: 12rpx 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 24rpx;
  color: #333;
  text-align: center;
  min-width: 120rpx;
}

.action-btn:active {
  background: #e8e8e8;
}

.action-btn.cancel {
  background: #fff1f0;
  color: #ff4d4f;
}

.action-btn.cancel:active {
  background: #ffccc7;
}



// pages/visitor/register/register.js
const app = getApp()

Page({
  data: {
    formData: {
      visitor_name: '',
      visitor_phone: '',
      visitor_id_card: '',
      relationship: 'friend',
      visit_reason: '',
      expected_arrival: '',
      expected_leave: ''
    },
    submitting: false,
    userInfo: null,
    timeRange: ['08:00', '22:00']
  },

  onLoad() {
    if (!app.checkLogin()) {
      wx.redirectTo({
        url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/visitor/register/register')
      })
      return
    }

    const userInfo = app.getUserInfo()
    if (userInfo.role !== 'student') {
      app.showPermissionError()
      wx.navigateBack()
      return
    }

    // è®¾ç½®é»˜è®¤æ—¶é—´ï¼ˆå½“å‰æ—¶é—´+1å°æ—¶ï¼ŒæŒç»­æ—¶é—´2å°æ—¶ï¼‰
    const now = new Date()
    const arrivalTime = new Date(now.getTime() + 60 * 60 * 1000)
    const leaveTime = new Date(arrivalTime.getTime() + 2 * 60 * 60 * 1000)

    this.setData({
      userInfo,
      'formData.expected_arrival': this.formatDateTime(arrivalTime),
      'formData.expected_leave': this.formatDateTime(leaveTime)
    })
  },

  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºå­—ç¬¦ä¸²
  formatDateTime(date) {
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    const hours = String(date.getHours()).padStart(2, '0')
    const minutes = String(date.getMinutes()).padStart(2, '0')
    return `${year}-${month}-${day} ${hours}:${minutes}`
  },

  // è¡¨å•è¾“å…¥å¤„ç†
  onInput(e) {
    const { field } = e.currentTarget.dataset
    this.setData({
      [`formData.${field}`]: e.detail.value
    })
  },

  // é€‰æ‹©è®¿å®¢å…³ç³»
  onRelationshipChange(e) {
    this.setData({
      'formData.relationship': e.detail.value
    })
  },

  // é€‰æ‹©é¢„è®¡åˆ°è¾¾æ—¶é—´
  onArrivalTimeChange(e) {
    this.setData({
      'formData.expected_arrival': e.detail.value
    })
  },

  // é€‰æ‹©é¢„è®¡ç¦»å¼€æ—¶é—´
  onLeaveTimeChange(e) {
    this.setData({
      'formData.expected_leave': e.detail.value
    })
  },

  // è¡¨å•éªŒè¯
  validateForm() {
    const { 
      visitor_name, 
      visitor_phone, 
      visit_reason,
      expected_arrival,
      expected_leave 
    } = this.data.formData

    if (!visitor_name || visitor_name.trim().length < 2) {
      wx.showToast({
        title: 'è¯·è¾“å…¥è®¿å®¢å§“åï¼ˆè‡³å°‘2ä¸ªå­—ï¼‰',
        icon: 'none'
      })
      return false
    }

    if (!visitor_phone || !/^1[3-9]\d{9}$/.test(visitor_phone)) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ',
        icon: 'none'
      })
      return false
    }

    if (!visit_reason || visit_reason.trim().length < 5) {
      wx.showToast({
        title: 'è¯·å¡«å†™æ¥è®¿äº‹ç”±ï¼ˆè‡³å°‘5ä¸ªå­—ï¼‰',
        icon: 'none'
      })
      return false
    }

    if (!expected_arrival) {
      wx.showToast({
        title: 'è¯·é€‰æ‹©é¢„è®¡åˆ°è¾¾æ—¶é—´',
        icon: 'none'
      })
      return false
    }

    if (!expected_leave) {
      wx.showToast({
        title: 'è¯·é€‰æ‹©é¢„è®¡ç¦»å¼€æ—¶é—´',
        icon: 'none'
      })
      return false
    }

    // æ£€æŸ¥æ—¶é—´åˆç†æ€§
    const arrivalTime = new Date(expected_arrival).getTime()
    const leaveTime = new Date(expected_leave).getTime()
    const now = Date.now()

    if (arrivalTime < now - 30 * 60 * 1000) { // 30åˆ†é’Ÿå‰
      wx.showToast({
        title: 'åˆ°è¾¾æ—¶é—´ä¸èƒ½æ˜¯è¿‡å»çš„æ—¶é—´',
        icon: 'none'
      })
      return false
    }

    if (leaveTime <= arrivalTime) {
      wx.showToast({
        title: 'ç¦»å¼€æ—¶é—´å¿…é¡»æ™šäºåˆ°è¾¾æ—¶é—´',
        icon: 'none'
      })
      return false
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸çš„æ—¶é—´èŒƒå›´å†…
    const arrivalHour = new Date(expected_arrival).getHours()
    const leaveHour = new Date(expected_leave).getHours()
    const [startHour, endHour] = this.data.timeRange.map(t => parseInt(t.split(':')[0]))

    if (arrivalHour < startHour || arrivalHour >= endHour) {
      wx.showToast({
        title: `è®¿å®¢æ—¶é—´åº”åœ¨${startHour}:00-${endHour}:00ä¹‹é—´`,
        icon: 'none'
      })
      return false
    }

    return true
  },

  // æäº¤è®¿å®¢ç™»è®°
  async submitVisitor() {
    if (!this.validateForm()) {
      return
    }

    this.setData({ submitting: true })

    try {
      const res = await app.request('/visitors', 'POST', this.data.formData)

      wx.showToast({
        title: 'è®¿å®¢ç™»è®°æˆåŠŸ',
        icon: 'success',
        duration: 2000
      })

      setTimeout(() => {
        wx.navigateTo({
          url: `/pages/visitor/detail/detail?id=${res.data.id}`
        })
      }, 1500)

    } catch (error) {
      console.error('è®¿å®¢ç™»è®°å¤±è´¥:', error)
      wx.showToast({
        title: error.message || 'ç™»è®°å¤±è´¥',
        icon: 'none'
      })
      this.setData({ submitting: false })
    }
  },

  // æ ¼å¼åŒ–å…³ç³»æ˜¾ç¤º
  formatRelationship(rel) {
    const relMap = {
      'family': 'å®¶äºº',
      'friend': 'æœ‹å‹',
      'relative': 'äº²æˆš',
      'other': 'å…¶ä»–'
    }
    return relMap[rel] || rel
  },

  // è·å–å½“å‰æ—¶é—´æˆ³
  getCurrentTime() {
    const now = new Date()
    return now.toISOString().slice(0, 16)
  },

  // è·å–æœ€å°æ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼‰
  getMinTime() {
    return this.getCurrentTime()
  },

  // è·å–æœ€å¤§æ—¶é—´ï¼ˆä»Šå¤©22:00ï¼‰
  getMaxTime() {
    const now = new Date()
    const today = now.toISOString().slice(0, 10)
    return `${today} ${this.data.timeRange[1]}:00`
  }
})



{
  "usingComponents": {},
  "navigationBarTitleText": "è®¿å®¢ç™»è®°"
}



<!--pages/visitor/register/register.wxml-->
<view class="container">
  <view class="form-card card">
    <!-- è®¿å®¢ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">è®¿å®¢ä¿¡æ¯</view>
      
      <view class="form-group">
        <view class="form-label">è®¿å®¢å§“å</view>
        <input
          class="form-input"
          type="text"
          placeholder="è¯·è¾“å…¥è®¿å®¢å§“å"
          value="{{formData.visitor_name}}"
          bindinput="onInput"
          data-field="visitor_name"
          maxlength="50"
        />
      </view>

      <view class="form-group">
        <view class="form-label">æ‰‹æœºå·ç </view>
        <input
          class="form-input"
          type="number"
          placeholder="è¯·è¾“å…¥è®¿å®¢æ‰‹æœºå·"
          value="{{formData.visitor_phone}}"
          bindinput="onInput"
          data-field="visitor_phone"
          maxlength="11"
        />
      </view>

      <view class="form-group">
        <view class="form-label">èº«ä»½è¯å·</view>
        <input
          class="form-input"
          type="idcard"
          placeholder="è¯·è¾“å…¥èº«ä»½è¯å·ï¼ˆé€‰å¡«ï¼‰"
          value="{{formData.visitor_id_card}}"
          bindinput="onInput"
          data-field="visitor_id_card"
          maxlength="18"
        />
      </view>

      <view class="form-group">
        <view class="form-label">ä¸è®¿å®¢å…³ç³»</view>
        <picker
          range="{{['family', 'friend', 'relative', 'other']}}"
          range-key="{{['å®¶äºº', 'æœ‹å‹', 'äº²æˆš', 'å…¶ä»–']}}"
          value="{{['family', 'friend', 'relative', 'other'].indexOf(formData.relationship)}}"
          bindchange="onRelationshipChange"
        >
          <view class="picker-item">
            <text>{{formatRelationship(formData.relationship)}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
    </view>

    <!-- æ¥è®¿ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">æ¥è®¿ä¿¡æ¯</view>
      
      <view class="form-group">
        <view class="form-label">æ¥è®¿äº‹ç”±</view>
        <textarea
          class="form-textarea"
          placeholder="è¯·å¡«å†™æ¥è®¿äº‹ç”±ï¼ˆè‡³å°‘5ä¸ªå­—ï¼‰"
          value="{{formData.visit_reason}}"
          bindinput="onInput"
          data-field="visit_reason"
          maxlength="200"
          auto-height
        ></textarea>
        <view class="word-count">{{formData.visit_reason.length}}/200</view>
      </view>

      <view class="form-group">
        <view class="form-label">é¢„è®¡åˆ°è¾¾æ—¶é—´</view>
        <picker
          mode="datetime"
          start="{{getMinTime()}}"
          end="{{getMaxTime()}}"
          value="{{formData.expected_arrival}}"
          bindchange="onArrivalTimeChange"
        >
          <view class="picker-item">
            <text>{{formData.expected_arrival || 'è¯·é€‰æ‹©åˆ°è¾¾æ—¶é—´'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>

      <view class="form-group">
        <view class="form-label">é¢„è®¡ç¦»å¼€æ—¶é—´</view>
        <picker
          mode="datetime"
          start="{{formData.expected_arrival || getMinTime()}}"
          end="{{getMaxTime()}}"
          value="{{formData.expected_leave}}"
          bindchange="onLeaveTimeChange"
        >
          <view class="picker-item">
            <text>{{formData.expected_leave || 'è¯·é€‰æ‹©ç¦»å¼€æ—¶é—´'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>

      <view class="time-tips">
        â° è®¿å®¢æ—¶é—´èŒƒå›´ï¼š{{timeRange[0]}} - {{timeRange[1]}}
      </view>
    </view>

    <!-- ç”³è¯·äººä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">ç”³è¯·äººä¿¡æ¯</view>
      <view class="info-row">
        <view class="info-label">å§“å</view>
        <view class="info-value">{{userInfo.real_name || userInfo.username}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">å­¦å·</view>
        <view class="info-value">{{userInfo.student_id || '--'}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">å®¿èˆ</view>
        <view class="info-value">
          {{userInfo.building_info ? userInfo.building_info.building_name + ' ' + userInfo.building_info.room_number : 'æœªåˆ†é…å®¿èˆ'}}
        </view>
      </view>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="form-actions">
    <button 
      class="btn-primary {{submitting ? 'btn-disabled' : ''}}"
      bindtap="submitVisitor"
      disabled="{{submitting}}"
    >
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤ç™»è®°'}}
    </button>
  </view>
</view>



/* pages/visitor/register/register.wxss */

.form-group {
  margin-bottom: 32rpx;
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-label {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
  margin-bottom: 16rpx;
  display: block;
}

.form-input {
  width: 100%;
  height: 80rpx;
  padding: 0 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
  box-sizing: border-box;
  border: 2rpx solid transparent;
}

.form-input:focus {
  border-color: #1890ff;
  background: #fff;
}

.form-textarea {
  width: 100%;
  min-height: 160rpx;
  padding: 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
  box-sizing: border-box;
  border: 2rpx solid transparent;
  line-height: 1.5;
}

.form-textarea:focus {
  border-color: #1890ff;
  background: #fff;
}

.picker-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 80rpx;
  padding: 0 24rpx;
  background: #f5f5f5;
  border-radius: 8rpx;
  font-size: 28rpx;
  color: #333;
}

.picker-arrow {
  color: #999;
  font-size: 24rpx;
}

.word-count {
  text-align: right;
  font-size: 24rpx;
  color: #999;
  margin-top: 10rpx;
}

.time-tips {
  font-size: 24rpx;
  color: #fa8c16;
  background: #fff7e6;
  padding: 16rpx;
  border-radius: 8rpx;
  margin-top: 20rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.info-row:last-child {
  margin-bottom: 0;
  border-bottom: none;
  padding-bottom: 0;
}

.info-label {
  font-size: 28rpx;
  color: #666;
}

.info-value {
  font-size: 28rpx;
  color: #333;
  font-weight: 500;
}

.form-actions {
  margin-top: 60rpx;
}



const mysql = require('mysql2/promise');
require('dotenv').config();

const pool = mysql.createPool({
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || 3306,
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_NAME || 'dormitory_system',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  enableKeepAlive: true,
  keepAliveInitialDelay: 0
});

// æµ‹è¯•æ•°æ®åº“è¿æ¥
pool.getConnection()
  .then(connection => {
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
    connection.release();
  })
  .catch(err => {
    console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', err.message);
    process.exit(1);
  });

module.exports = pool;



const JWTUtil = require('../utils/jwt');

// è®¤è¯ä¸­é—´ä»¶
const authMiddleware = (requiredRoles = []) => {
  return async (req, res, next) => {
    try {
      // ä»è¯·æ±‚å¤´è·å–token
      const token = JWTUtil.getTokenFromHeader(req);
      
      if (!token) {
        return res.status(401).json({
          code: 401,
          message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ'
        });
      }

      // éªŒè¯token
      const decoded = JWTUtil.verifyToken(token);
      
      if (!decoded) {
        return res.status(401).json({
          code: 401,
          message: 'è®¤è¯ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ'
        });
      }

      // æ£€æŸ¥è§’è‰²æƒé™
      if (requiredRoles.length > 0 && !requiredRoles.includes(decoded.role)) {
        return res.status(403).json({
          code: 403,
          message: 'æƒé™ä¸è¶³'
        });
      }

      // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¯¹è±¡
      req.user = decoded;
      
      // æ£€æŸ¥tokenæ˜¯å¦éœ€è¦åˆ·æ–°
      if (JWTUtil.isTokenExpiringSoon(token)) {
        const newToken = JWTUtil.refreshToken(token);
        if (newToken) {
          res.setHeader('X-New-Token', newToken);
        }
      }

      next();
    } catch (error) {
      console.error('è®¤è¯ä¸­é—´ä»¶é”™è¯¯:', error);
      return res.status(500).json({
        code: 500,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
      });
    }
  };
};

// å¯é€‰è®¤è¯ä¸­é—´ä»¶ï¼ˆä¸å¼ºåˆ¶è¦æ±‚ç™»å½•ï¼‰
const optionalAuthMiddleware = (req, res, next) => {
  try {
    const token = JWTUtil.getTokenFromHeader(req);
    
    if (token) {
      const decoded = JWTUtil.verifyToken(token);
      if (decoded) {
        req.user = decoded;
        
        // æ£€æŸ¥tokenæ˜¯å¦éœ€è¦åˆ·æ–°
        if (JWTUtil.isTokenExpiringSoon(token)) {
          const newToken = JWTUtil.refreshToken(token);
          if (newToken) {
            res.setHeader('X-New-Token', newToken);
          }
        }
      }
    }
    
    next();
  } catch (error) {
    console.error('å¯é€‰è®¤è¯ä¸­é—´ä»¶é”™è¯¯:', error);
    next();
  }
};

module.exports = {
  authMiddleware,
  optionalAuthMiddleware
};



const express = require('express');
const bcrypt = require('bcryptjs');
const { body, validationResult } = require('express-validator');
const pool = require('../config/database');
const JWTUtil = require('../utils/jwt');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// ç”¨æˆ·æ³¨å†Œ
router.post('/register', [
  body('username').isLength({ min: 3, max: 50 }).withMessage('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50å­—ç¬¦ä¹‹é—´'),
  body('password').isLength({ min: 6 }).withMessage('å¯†ç é•¿åº¦è‡³å°‘6ä½'),
  body('email').isEmail().withMessage('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  body('student_id').optional().isLength({ min: 5 }).withMessage('å­¦å·æ ¼å¼ä¸æ­£ç¡®'),
  body('real_name').optional().isLength({ min: 2 }).withMessage('çœŸå®å§“åè‡³å°‘2ä¸ªå­—ç¬¦')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { username, password, email, student_id, real_name, phone } = req.body;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const [existingUser] = await pool.execute(
      'SELECT id FROM users WHERE username = ?',
      [username]
    );

    if (existingUser.length > 0) {
      return res.status(400).json({
        code: 400,
        message: 'ç”¨æˆ·åå·²å­˜åœ¨'
      });
    }

    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if (email) {
      const [existingEmail] = await pool.execute(
        'SELECT id FROM users WHERE email = ?',
        [email]
      );

      if (existingEmail.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'é‚®ç®±å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨
    if (student_id) {
      const [existingStudentId] = await pool.execute(
        'SELECT id FROM users WHERE student_id = ?',
        [student_id]
      );

      if (existingStudentId.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'å­¦å·å·²å­˜åœ¨'
        });
      }
    }

    // åŠ å¯†å¯†ç 
    const hashedPassword = await bcrypt.hash(password, 10);

    // åˆ›å»ºç”¨æˆ·
    const [result] = await pool.execute(
      `INSERT INTO users (username, password, email, student_id, real_name, phone, role) 
       VALUES (?, ?, ?, ?, ?, ?, 'student')`,
      [username, hashedPassword, email, student_id, real_name, phone]
    );

    // ç”ŸæˆToken
    const user = {
      id: result.insertId,
      username,
      email,
      real_name,
      role: 'student'
    };
    
    const token = JWTUtil.generateToken(user);

    res.status(201).json({
      code: 200,
      message: 'æ³¨å†ŒæˆåŠŸ',
      data: {
        user,
        token
      }
    });

  } catch (error) {
    console.error('æ³¨å†Œé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// ç”¨æˆ·ç™»å½•
router.post('/login', [
  body('username').notEmpty().withMessage('ç”¨æˆ·åä¸èƒ½ä¸ºç©º'),
  body('password').notEmpty().withMessage('å¯†ç ä¸èƒ½ä¸ºç©º')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { username, password } = req.body;

    // æŸ¥æ‰¾ç”¨æˆ·
    const [users] = await pool.execute(
      `SELECT id, username, password, email, phone, role, real_name, 
              student_id, building_id, room_id, avatar_url, status
       FROM users WHERE username = ? OR email = ?`,
      [username, username]
    );

    if (users.length === 0) {
      return res.status(401).json({
        code: 401,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
    }

    const user = users[0];

    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (user.status !== 'active') {
      return res.status(403).json({
        code: 403,
        message: 'è´¦æˆ·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
      });
    }

    // éªŒè¯å¯†ç 
    const isValidPassword = await bcrypt.compare(password, user.password);
    if (!isValidPassword) {
      return res.status(401).json({
        code: 401,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
    }

    // ç”ŸæˆToken
    const token = JWTUtil.generateToken(user);

    // ç§»é™¤å¯†ç å­—æ®µ
    delete user.password;

    res.json({
      code: 200,
      message: 'ç™»å½•æˆåŠŸ',
      data: {
        user,
        token
      }
    });

  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
router.get('/me', authMiddleware(), async (req, res) => {
  try {
    const userId = req.user.id;

    const [users] = await pool.execute(
      `SELECT id, username, email, phone, role, real_name, 
              student_id, building_id, room_id, avatar_url, status,
              created_at, updated_at
       FROM users WHERE id = ?`,
      [userId]
    );

    if (users.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    const user = users[0];

    // å¦‚æœç”¨æˆ·æœ‰å®¿èˆä¿¡æ¯ï¼Œè·å–è¯¦ç»†å®¿èˆä¿¡æ¯
    if (user.building_id && user.room_id) {
      const [buildingInfo] = await pool.execute(
        `SELECT b.building_name, b.building_code, 
                r.room_number, r.floor, r.capacity, r.current_occupancy
         FROM buildings b
         JOIN rooms r ON b.id = r.building_id
         WHERE b.id = ? AND r.id = ?`,
        [user.building_id, user.room_id]
      );

      if (buildingInfo.length > 0) {
        user.building_info = buildingInfo[0];
      }
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: user
    });

  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// ä¿®æ”¹å¯†ç 
router.put('/change-password', authMiddleware(), [
  body('oldPassword').notEmpty().withMessage('æ—§å¯†ç ä¸èƒ½ä¸ºç©º'),
  body('newPassword').isLength({ min: 6 }).withMessage('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const userId = req.user.id;
    const { oldPassword, newPassword } = req.body;

    // è·å–å½“å‰å¯†ç 
    const [users] = await pool.execute(
      'SELECT password FROM users WHERE id = ?',
      [userId]
    );

    if (users.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    // éªŒè¯æ—§å¯†ç 
    const isValidPassword = await bcrypt.compare(oldPassword, users[0].password);
    if (!isValidPassword) {
      return res.status(400).json({
        code: 400,
        message: 'æ—§å¯†ç é”™è¯¯'
      });
    }

    // åŠ å¯†æ–°å¯†ç 
    const hashedPassword = await bcrypt.hash(newPassword, 10);

    // æ›´æ–°å¯†ç 
    await pool.execute(
      'UPDATE users SET password = ?, updated_at = NOW() WHERE id = ?',
      [hashedPassword, userId]
    );

    res.json({
      code: 200,
      message: 'å¯†ç ä¿®æ”¹æˆåŠŸ'
    });

  } catch (error) {
    console.error('ä¿®æ”¹å¯†ç é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ·æ–°Token
router.post('/refresh-token', async (req, res) => {
  try {
    const token = JWTUtil.getTokenFromHeader(req);
    
    if (!token) {
      return res.status(401).json({
        code: 401,
        message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ'
      });
    }

    const newToken = JWTUtil.refreshToken(token);
    
    if (!newToken) {
      return res.status(401).json({
        code: 401,
        message: 'åˆ·æ–°ä»¤ç‰Œå¤±è´¥'
      });
    }

    res.json({
      code: 200,
      message: 'ä»¤ç‰Œåˆ·æ–°æˆåŠŸ',
      data: {
        token: newToken
      }
    });

  } catch (error) {
    console.error('åˆ·æ–°ä»¤ç‰Œé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–æ¥¼æ ‹åˆ—è¡¨
router.get('/buildings', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('status').optional().isIn(['active', 'maintenance', 'closed']),
  query('keyword').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      status,
      keyword
    } = req.query;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    if (status) {
      whereConditions.push('status = ?');
      params.push(status);
    }

    if (keyword) {
      whereConditions.push('(building_name LIKE ? OR building_code LIKE ?)');
      params.push(`%${keyword}%`, `%${keyword}%`);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total FROM buildings WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢æ¥¼æ ‹åˆ—è¡¨
    const [buildings] = await pool.execute(
      `SELECT id, building_name, building_code, floors, 
              rooms_per_floor, total_rooms, occupied_rooms, 
              available_rooms, manager_id, description, status,
              created_at, updated_at
       FROM buildings WHERE ${whereClause}
       ORDER BY building_code ASC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    // è·å–æ¥¼æ ‹ç®¡ç†å‘˜ä¿¡æ¯
    const managerIds = buildings
      .filter(b => b.manager_id)
      .map(b => b.manager_id);
    
    if (managerIds.length > 0) {
      const [managers] = await pool.execute(
        `SELECT id, username, real_name, phone 
         FROM users WHERE id IN (?)`,
        [managerIds]
      );

      const managerMap = new Map();
      managers.forEach(manager => {
        managerMap.set(manager.id, {
          username: manager.username,
          real_name: manager.real_name,
          phone: manager.phone
        });
      });

      buildings.forEach(building => {
        building.manager_info = building.manager_id ? managerMap.get(building.manager_id) : null;
      });
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: buildings,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–æ¥¼æ ‹åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æ¥¼æ ‹è¯¦æƒ…
router.get('/buildings/:id', authMiddleware(), async (req, res) => {
  try {
    const buildingId = req.params.id;

    const [buildings] = await pool.execute(
      `SELECT id, building_name, building_code, floors, 
              rooms_per_floor, total_rooms, occupied_rooms, 
              available_rooms, manager_id, description, status,
              created_at, updated_at
       FROM buildings WHERE id = ?`,
      [buildingId]
    );

    if (buildings.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    const building = buildings[0];

    // è·å–æ¥¼æ ‹ç®¡ç†å‘˜ä¿¡æ¯
    if (building.manager_id) {
      const [managers] = await pool.execute(
        `SELECT id, username, real_name, phone, email 
         FROM users WHERE id = ?`,
        [building.manager_id]
      );

      if (managers.length > 0) {
        building.manager_info = managers[0];
      }
    }

    // è·å–æ¥¼å±‚ç»Ÿè®¡
    const [floorStats] = await pool.execute(
      `SELECT floor, 
              COUNT(*) as total_rooms,
              SUM(CASE WHEN status = 'available' THEN 1 ELSE 0 END) as available_rooms,
              SUM(CASE WHEN status = 'occupied' THEN 1 ELSE 0 END) as occupied_rooms
       FROM rooms 
       WHERE building_id = ? 
       GROUP BY floor 
       ORDER BY floor ASC`,
      [buildingId]
    );

    building.floor_stats = floorStats;

    // è·å–æˆ¿é—´ç±»å‹ç»Ÿè®¡
    const [typeStats] = await pool.execute(
      `SELECT room_type, COUNT(*) as count 
       FROM rooms 
       WHERE building_id = ? 
       GROUP BY room_type`,
      [buildingId]
    );

    building.type_stats = typeStats;

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: building
    });

  } catch (error) {
    console.error('è·å–æ¥¼æ ‹è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ›å»ºæ¥¼æ ‹ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.post('/buildings', authMiddleware(['admin']), [
  body('building_name').notEmpty().withMessage('æ¥¼æ ‹åç§°ä¸èƒ½ä¸ºç©º'),
  body('building_code').notEmpty().withMessage('æ¥¼æ ‹ç¼–å·ä¸èƒ½ä¸ºç©º'),
  body('floors').optional().isInt({ min: 1, max: 50 }).toInt(),
  body('rooms_per_floor').optional().isInt({ min: 1, max: 100 }).toInt(),
  body('description').optional().isString(),
  body('status').optional().isIn(['active', 'maintenance', 'closed']),
  body('manager_id').optional().isInt({ min: 1 }).toInt()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      building_name,
      building_code,
      floors = 6,
      rooms_per_floor = 20,
      description,
      status = 'active',
      manager_id
    } = req.body;

    // æ£€æŸ¥æ¥¼æ ‹ç¼–å·æ˜¯å¦å·²å­˜åœ¨
    const [existingBuilding] = await pool.execute(
      'SELECT id FROM buildings WHERE building_code = ?',
      [building_code]
    );

    if (existingBuilding.length > 0) {
      return res.status(400).json({
        code: 400,
        message: 'æ¥¼æ ‹ç¼–å·å·²å­˜åœ¨'
      });
    }

    // æ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦å­˜åœ¨
    if (manager_id) {
      const [managerExists] = await pool.execute(
        'SELECT id FROM users WHERE id = ? AND role IN ("admin", "staff")',
        [manager_id]
      );

      if (managerExists.length === 0) {
        return res.status(400).json({
          code: 400,
          message: 'ç®¡ç†å‘˜ä¸å­˜åœ¨æˆ–æ— æƒé™'
        });
      }
    }

    const total_rooms = floors * rooms_per_floor;

    // åˆ›å»ºæ¥¼æ ‹
    const [result] = await pool.execute(
      `INSERT INTO buildings 
       (building_name, building_code, floors, rooms_per_floor, 
        total_rooms, available_rooms, description, status, manager_id)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        building_name,
        building_code,
        floors,
        rooms_per_floor,
        total_rooms,
        total_rooms, // åˆå§‹å¯ç”¨æˆ¿é—´æ•°ç­‰äºæ€»æˆ¿é—´æ•°
        description,
        status,
        manager_id
      ]
    );

    // è‡ªåŠ¨åˆ›å»ºæˆ¿é—´
    const roomPromises = [];
    for (let floor = 1; floor <= floors; floor++) {
      for (let roomNum = 1; roomNum <= rooms_per_floor; roomNum++) {
        const room_number = `${floor}${roomNum.toString().padStart(2, '0')}`;
        
        roomPromises.push(
          pool.execute(
            `INSERT INTO rooms 
             (building_id, room_number, floor, capacity, room_type, monthly_fee)
             VALUES (?, ?, ?, 4, 'standard', 1200.00)`,
            [result.insertId, room_number, floor]
          )
        );
      }
    }

    await Promise.all(roomPromises);

    res.status(201).json({
      code: 200,
      message: 'æ¥¼æ ‹åˆ›å»ºæˆåŠŸ',
      data: {
        id: result.insertId,
        building_name,
        building_code,
        total_rooms
      }
    });

  } catch (error) {
    console.error('åˆ›å»ºæ¥¼æ ‹é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°æ¥¼æ ‹ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.put('/buildings/:id', authMiddleware(['admin']), [
  body('building_name').optional().notEmpty().withMessage('æ¥¼æ ‹åç§°ä¸èƒ½ä¸ºç©º'),
  body('building_code').optional().notEmpty().withMessage('æ¥¼æ ‹ç¼–å·ä¸èƒ½ä¸ºç©º'),
  body('floors').optional().isInt({ min: 1, max: 50 }).toInt(),
  body('rooms_per_floor').optional().isInt({ min: 1, max: 100 }).toInt(),
  body('description').optional().isString(),
  body('status').optional().isIn(['active', 'maintenance', 'closed']),
  body('manager_id').optional().isInt({ min: 1 }).toInt()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const buildingId = req.params.id;
    const {
      building_name,
      building_code,
      floors,
      rooms_per_floor,
      description,
      status,
      manager_id
    } = req.body;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [existingBuildings] = await pool.execute(
      'SELECT id FROM buildings WHERE id = ?',
      [buildingId]
    );

    if (existingBuildings.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    // æ£€æŸ¥æ¥¼æ ‹ç¼–å·æ˜¯å¦å·²å­˜åœ¨
    if (building_code) {
      const [existingBuilding] = await pool.execute(
        'SELECT id FROM buildings WHERE building_code = ? AND id != ?',
        [building_code, buildingId]
      );

      if (existingBuilding.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'æ¥¼æ ‹ç¼–å·å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦å­˜åœ¨
    if (manager_id) {
      const [managerExists] = await pool.execute(
        'SELECT id FROM users WHERE id = ? AND role IN ("admin", "staff")',
        [manager_id]
      );

      if (managerExists.length === 0) {
        return res.status(400).json({
          code: 400,
          message: 'ç®¡ç†å‘˜ä¸å­˜åœ¨æˆ–æ— æƒé™'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = [];
    const updateValues = [];

    if (building_name !== undefined) {
      updateFields.push('building_name = ?');
      updateValues.push(building_name);
    }

    if (building_code !== undefined) {
      updateFields.push('building_code = ?');
      updateValues.push(building_code);
    }

    if (floors !== undefined) {
      updateFields.push('floors = ?');
      updateValues.push(floors);
    }

    if (rooms_per_floor !== undefined) {
      updateFields.push('rooms_per_floor = ?');
      updateValues.push(rooms_per_floor);
    }

    if (description !== undefined) {
      updateFields.push('description = ?');
      updateValues.push(description);
    }

    if (status !== undefined) {
      updateFields.push('status = ?');
      updateValues.push(status);
    }

    if (manager_id !== undefined) {
      updateFields.push('manager_id = ?');
      updateValues.push(manager_id);
    }

    // é‡æ–°è®¡ç®—æ€»æˆ¿é—´æ•°
    if (floors !== undefined || rooms_per_floor !== undefined) {
      // è·å–å½“å‰çš„æ¥¼å±‚å’Œæ¯å±‚æˆ¿é—´æ•°
      const [currentBuilding] = await pool.execute(
        'SELECT floors, rooms_per_floor FROM buildings WHERE id = ?',
        [buildingId]
      );

      const currentFloors = floors !== undefined ? floors : currentBuilding[0].floors;
      const currentRoomsPerFloor = rooms_per_floor !== undefined ? rooms_per_floor : currentBuilding[0].rooms_per_floor;
      
      updateFields.push('total_rooms = ?');
      updateValues.push(currentFloors * currentRoomsPerFloor);
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(buildingId);
    await pool.execute(
      `UPDATE buildings SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    res.json({
      code: 200,
      message: 'æ¥¼æ ‹æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°æ¥¼æ ‹é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤æ¥¼æ ‹ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/buildings/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const buildingId = req.params.id;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [existingBuildings] = await pool.execute(
      'SELECT id FROM buildings WHERE id = ?',
      [buildingId]
    );

    if (existingBuildings.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    // æ£€æŸ¥æ¥¼æ ‹ä¸­æ˜¯å¦æœ‰æˆ¿é—´è¢«å ç”¨
    const [occupiedRooms] = await pool.execute(
      `SELECT COUNT(*) as occupied_count 
       FROM rooms 
       WHERE building_id = ? AND status = 'occupied'`,
      [buildingId]
    );

    if (occupiedRooms[0].occupied_count > 0) {
      return res.status(400).json({
        code: 400,
        message: 'æ¥¼æ ‹ä¸­ä»æœ‰æˆ¿é—´è¢«å ç”¨ï¼Œæ— æ³•åˆ é™¤'
      });
    }

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // åˆ é™¤æ¥¼æ ‹çš„æ‰€æœ‰æˆ¿é—´
      await connection.execute(
        'DELETE FROM rooms WHERE building_id = ?',
        [buildingId]
      );

      // åˆ é™¤æ¥¼æ ‹
      await connection.execute(
        'DELETE FROM buildings WHERE id = ?',
        [buildingId]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'æ¥¼æ ‹åˆ é™¤æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('åˆ é™¤æ¥¼æ ‹é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æˆ¿é—´åˆ—è¡¨
router.get('/rooms', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('floor').optional().isInt({ min: 1 }).toInt(),
  query('room_type').optional().isIn(['standard', 'premium', 'suite']),
  query('status').optional().isIn(['available', 'occupied', 'maintenance', 'reserved']),
  query('keyword').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      building_id,
      floor,
      room_type,
      status,
      keyword
    } = req.query;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    if (building_id) {
      whereConditions.push('building_id = ?');
      params.push(building_id);
    }

    if (floor) {
      whereConditions.push('floor = ?');
      params.push(floor);
    }

    if (room_type) {
      whereConditions.push('room_type = ?');
      params.push(room_type);
    }

    if (status) {
      whereConditions.push('status = ?');
      params.push(status);
    }

    if (keyword) {
      whereConditions.push('room_number LIKE ?');
      params.push(`%${keyword}%`);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total FROM rooms WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢æˆ¿é—´åˆ—è¡¨
    const [rooms] = await pool.execute(
      `SELECT r.id, r.building_id, r.room_number, r.floor, 
              r.capacity, r.current_occupancy, r.room_type,
              r.facilities, r.monthly_fee, r.status,
              r.created_at, r.updated_at,
              b.building_name, b.building_code
       FROM rooms r
       JOIN buildings b ON r.building_id = b.id
       WHERE ${whereClause}
       ORDER BY r.building_id, r.floor, r.room_number
       LIMIT ? OFFSET ?`,
      queryParams
    );

    // è·å–æˆ¿é—´çš„ä½æˆ·ä¿¡æ¯
    const roomIds = rooms.map(room => room.id);
    if (roomIds.length > 0) {
      const [occupants] = await pool.execute(
        `SELECT room_id, 
                GROUP_CONCAT(CONCAT(real_name, '(', student_id, ')') SEPARATOR ', ') as occupants
         FROM users 
         WHERE room_id IN (?) 
         GROUP BY room_id`,
        [roomIds]
      );

      const occupantMap = new Map();
      occupants.forEach(occ => {
        occupantMap.set(occ.room_id, occ.occupants);
      });

      rooms.forEach(room => {
        room.occupants = occupantMap.get(room.id) || '';
      });
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: rooms,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–æˆ¿é—´åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æˆ¿é—´è¯¦æƒ…
router.get('/rooms/:id', authMiddleware(), async (req, res) => {
  try {
    const roomId = req.params.id;

    const [rooms] = await pool.execute(
      `SELECT r.id, r.building_id, r.room_number, r.floor, 
              r.capacity, r.current_occupancy, r.room_type,
              r.facilities, r.monthly_fee, r.status,
              r.created_at, r.updated_at,
              b.building_name, b.building_code, b.floors
       FROM rooms r
       JOIN buildings b ON r.building_id = b.id
       WHERE r.id = ?`,
      [roomId]
    );

    if (rooms.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æˆ¿é—´ä¸å­˜åœ¨'
      });
    }

    const room = rooms[0];

    // è§£æè®¾æ–½ä¿¡æ¯
    if (room.facilities) {
      try {
        room.facilities = JSON.parse(room.facilities);
      } catch (e) {
        room.facilities = [];
      }
    } else {
      room.facilities = [];
    }

    // è·å–æˆ¿é—´çš„ä½æˆ·ä¿¡æ¯
    const [occupants] = await pool.execute(
      `SELECT id, username, real_name, student_id, phone, email, avatar_url
       FROM users 
       WHERE room_id = ? AND status = 'active'`,
      [roomId]
    );

    room.occupants = occupants;

    // è·å–åŒæ¥¼æ ‹åŒæ¥¼å±‚çš„å…¶ä»–æˆ¿é—´
    const [sameFloorRooms] = await pool.execute(
      `SELECT id, room_number, status, current_occupancy
       FROM rooms 
       WHERE building_id = ? AND floor = ? AND id != ?
       ORDER BY room_number`,
      [room.building_id, room.floor, roomId]
    );

    room.same_floor_rooms = sameFloorRooms;

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: room
    });

  } catch (error) {
    console.error('è·å–æˆ¿é—´è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ›å»ºæˆ¿é—´ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.post('/rooms', authMiddleware(['admin']), [
  body('building_id').isInt({ min: 1 }).withMessage('æ¥¼æ ‹IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('room_number').notEmpty().withMessage('æˆ¿é—´å·ä¸èƒ½ä¸ºç©º'),
  body('floor').isInt({ min: 1, max: 50 }).withMessage('æ¥¼å±‚å¿…é¡»åœ¨1-50ä¹‹é—´'),
  body('capacity').optional().isInt({ min: 1, max: 10 }).toInt(),
  body('room_type').optional().isIn(['standard', 'premium', 'suite']),
  body('monthly_fee').optional().isFloat({ min: 0 }).toFloat(),
  body('status').optional().isIn(['available', 'occupied', 'maintenance', 'reserved']),
  body('facilities').optional().isJSON()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      building_id,
      room_number,
      floor,
      capacity = 4,
      room_type = 'standard',
      monthly_fee = 1200.00,
      status = 'available',
      facilities = '[]'
    } = req.body;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [buildingExists] = await pool.execute(
      'SELECT id, floors FROM buildings WHERE id = ? AND status = "active"',
      [building_id]
    );

    if (buildingExists.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨æˆ–å·²å…³é—­'
      });
    }

    // æ£€æŸ¥æ¥¼å±‚æ˜¯å¦æœ‰æ•ˆ
    if (floor > buildingExists[0].floors) {
      return res.status(400).json({
        code: 400,
        message: `æ¥¼å±‚ä¸èƒ½è¶…è¿‡æ¥¼æ ‹æ€»å±‚æ•°${buildingExists[0].floors}`
      });
    }

    // æ£€æŸ¥æˆ¿é—´å·æ˜¯å¦å·²å­˜åœ¨
    const [existingRoom] = await pool.execute(
      'SELECT id FROM rooms WHERE building_id = ? AND room_number = ?',
      [building_id, room_number]
    );

    if (existingRoom.length > 0) {
      return res.status(400).json({
        code: 400,
        message: 'æˆ¿é—´å·å·²å­˜åœ¨'
      });
    }

    // åˆ›å»ºæˆ¿é—´
    const [result] = await pool.execute(
      `INSERT INTO rooms 
       (building_id, room_number, floor, capacity, room_type, 
        monthly_fee, status, facilities)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        building_id,
        room_number,
        floor,
        capacity,
        room_type,
        monthly_fee,
        status,
        facilities
      ]
    );

    // æ›´æ–°æ¥¼æ ‹ç»Ÿè®¡
    await pool.execute(
      `UPDATE buildings 
       SET total_rooms = total_rooms + 1,
           available_rooms = available_rooms + 1
       WHERE id = ?`,
      [building_id]
    );

    res.status(201).json({
      code: 200,
      message: 'æˆ¿é—´åˆ›å»ºæˆåŠŸ',
      data: {
        id: result.insertId,
        building_id,
        room_number,
        floor
      }
    });

  } catch (error) {
    console.error('åˆ›å»ºæˆ¿é—´é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°æˆ¿é—´ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.put('/rooms/:id', authMiddleware(['admin']), [
  body('room_number').optional().notEmpty().withMessage('æˆ¿é—´å·ä¸èƒ½ä¸ºç©º'),
  body('floor').optional().isInt({ min: 1, max: 50 }).withMessage('æ¥¼å±‚å¿…é¡»åœ¨1-50ä¹‹é—´'),
  body('capacity').optional().isInt({ min: 1, max: 10 }).toInt(),
  body('room_type').optional().isIn(['standard', 'premium', 'suite']),
  body('monthly_fee').optional().isFloat({ min: 0 }).toFloat(),
  body('status').optional().isIn(['available', 'occupied', 'maintenance', 'reserved']),
  body('facilities').optional().isJSON()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const roomId = req.params.id;
    const {
      room_number,
      floor,
      capacity,
      room_type,
      monthly_fee,
      status,
      facilities
    } = req.body;

    // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
    const [existingRooms] = await pool.execute(
      `SELECT id, building_id, floor as old_floor, status as old_status 
       FROM rooms WHERE id = ?`,
      [roomId]
    );

    if (existingRooms.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æˆ¿é—´ä¸å­˜åœ¨'
      });
    }

    const existingRoom = existingRooms[0];
    const buildingId = existingRoom.building_id;
    const oldFloor = existingRoom.old_floor;
    const oldStatus = existingRoom.old_status;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [buildingExists] = await pool.execute(
      'SELECT id, floors FROM buildings WHERE id = ?',
      [buildingId]
    );

    if (buildingExists.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    // æ£€æŸ¥æ¥¼å±‚æ˜¯å¦æœ‰æ•ˆ
    if (floor && floor > buildingExists[0].floors) {
      return res.status(400).json({
        code: 400,
        message: `æ¥¼å±‚ä¸èƒ½è¶…è¿‡æ¥¼æ ‹æ€»å±‚æ•°${buildingExists[0].floors}`
      });
    }

    // æ£€æŸ¥æˆ¿é—´å·æ˜¯å¦å·²å­˜åœ¨
    if (room_number) {
      const [existingRoomNumber] = await pool.execute(
        'SELECT id FROM rooms WHERE building_id = ? AND room_number = ? AND id != ?',
        [buildingId, room_number, roomId]
      );

      if (existingRoomNumber.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'æˆ¿é—´å·å·²å­˜åœ¨'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = [];
    const updateValues = [];

    if (room_number !== undefined) {
      updateFields.push('room_number = ?');
      updateValues.push(room_number);
    }

    if (floor !== undefined) {
      updateFields.push('floor = ?');
      updateValues.push(floor);
    }

    if (capacity !== undefined) {
      updateFields.push('capacity = ?');
      updateValues.push(capacity);
    }

    if (room_type !== undefined) {
      updateFields.push('room_type = ?');
      updateValues.push(room_type);
    }

    if (monthly_fee !== undefined) {
      updateFields.push('monthly_fee = ?');
      updateValues.push(monthly_fee);
    }

    if (status !== undefined) {
      updateFields.push('status = ?');
      updateValues.push(status);
    }

    if (facilities !== undefined) {
      updateFields.push('facilities = ?');
      updateValues.push(facilities);
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(roomId);
    await pool.execute(
      `UPDATE rooms SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    // æ›´æ–°æ¥¼æ ‹ç»Ÿè®¡ï¼ˆå¦‚æœçŠ¶æ€å˜åŒ–ï¼‰
    if (status && status !== oldStatus) {
      if (oldStatus === 'available' && status !== 'available') {
        // ä»å¯ç”¨å˜ä¸ºä¸å¯ç”¨
        await pool.execute(
          'UPDATE buildings SET available_rooms = available_rooms - 1 WHERE id = ?',
          [buildingId]
        );
      } else if (oldStatus !== 'available' && status === 'available') {
        // ä»ä¸å¯ç”¨å˜ä¸ºå¯ç”¨
        await pool.execute(
          'UPDATE buildings SET available_rooms = available_rooms + 1 WHERE id = ?',
          [buildingId]
        );
      }
    }

    res.json({
      code: 200,
      message: 'æˆ¿é—´æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°æˆ¿é—´é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤æˆ¿é—´ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/rooms/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const roomId = req.params.id;

    // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
    const [existingRooms] = await pool.execute(
      `SELECT id, building_id, status, current_occupancy 
       FROM rooms WHERE id = ?`,
      [roomId]
    );

    if (existingRooms.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æˆ¿é—´ä¸å­˜åœ¨'
      });
    }

    const existingRoom = existingRooms[0];

    // æ£€æŸ¥æˆ¿é—´æ˜¯å¦è¢«å ç”¨
    if (existingRoom.current_occupancy > 0) {
      return res.status(400).json({
        code: 400,
        message: 'æˆ¿é—´ä»æœ‰ä½æˆ·ï¼Œæ— æ³•åˆ é™¤'
      });
    }

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // åˆ é™¤æˆ¿é—´
      await connection.execute(
        'DELETE FROM rooms WHERE id = ?',
        [roomId]
      );

      // æ›´æ–°æ¥¼æ ‹ç»Ÿè®¡
      await connection.execute(
        `UPDATE buildings 
         SET total_rooms = total_rooms - 1,
             available_rooms = available_rooms - 1
         WHERE id = ?`,
        [existingRoom.building_id]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'æˆ¿é—´åˆ é™¤æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('åˆ é™¤æˆ¿é—´é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ†é…æˆ¿é—´ç»™ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.post('/rooms/:id/assign', authMiddleware(['admin']), [
  body('user_id').isInt({ min: 1 }).withMessage('ç”¨æˆ·IDå¿…é¡»ä¸ºæ­£æ•´æ•°')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const roomId = req.params.id;
    const { user_id } = req.body;

    // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
    const [rooms] = await pool.execute(
      `SELECT id, building_id, capacity, current_occupancy, status 
       FROM rooms WHERE id = ?`,
      [roomId]
    );

    if (rooms.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æˆ¿é—´ä¸å­˜åœ¨'
      });
    }

    const room = rooms[0];

    if (room.status !== 'available') {
      return res.status(400).json({
        code: 400,
        message: `æˆ¿é—´å½“å‰çŠ¶æ€ä¸º${room.status}ï¼Œæ— æ³•åˆ†é…`
      });
    }

    if (room.current_occupancy >= room.capacity) {
      return res.status(400).json({
        code: 400,
        message: 'æˆ¿é—´å·²æ»¡'
      });
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ä¸”æœªåˆ†é…æˆ¿é—´
    const [users] = await pool.execute(
      `SELECT id, building_id, room_id, status 
       FROM users WHERE id = ? AND role = 'student'`,
      [user_id]
    );

    if (users.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä¸æ˜¯å­¦ç”Ÿ'
      });
    }

    const user = users[0];

    if (user.status !== 'active') {
      return res.status(400).json({
        code: 400,
        message: 'ç”¨æˆ·è´¦æˆ·çŠ¶æ€å¼‚å¸¸'
      });
    }

    if (user.room_id) {
      return res.status(400).json({
        code: 400,
        message: 'ç”¨æˆ·å·²åˆ†é…æˆ¿é—´'
      });
    }

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // æ›´æ–°ç”¨æˆ·æˆ¿é—´ä¿¡æ¯
      await connection.execute(
        `UPDATE users 
         SET building_id = ?, room_id = ?, updated_at = NOW()
         WHERE id = ?`,
        [room.building_id, roomId, user_id]
      );

      // æ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
      await connection.execute(
        `UPDATE rooms 
         SET current_occupancy = current_occupancy + 1,
             status = CASE 
               WHEN current_occupancy + 1 = capacity THEN 'occupied'
               ELSE 'available'
             END,
             updated_at = NOW()
         WHERE id = ?`,
        [roomId]
      );

      // æ›´æ–°æ¥¼æ ‹ç»Ÿè®¡
      await connection.execute(
        `UPDATE buildings 
         SET occupied_rooms = occupied_rooms + 1,
             available_rooms = available_rooms - 1
         WHERE id = ?`,
        [room.building_id]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'æˆ¿é—´åˆ†é…æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('åˆ†é…æˆ¿é—´é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// ç§»é™¤æˆ¿é—´ä½æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.post('/rooms/:id/remove-occupant', authMiddleware(['admin']), [
  body('user_id').isInt({ min: 1 }).withMessage('ç”¨æˆ·IDå¿…é¡»ä¸ºæ­£æ•´æ•°')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const roomId = req.params.id;
    const { user_id } = req.body;

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¡®å®åœ¨è¯¥æˆ¿é—´
    const [users] = await pool.execute(
      `SELECT id, building_id, room_id 
       FROM users WHERE id = ? AND room_id = ?`,
      [user_id, roomId]
    );

    if (users.length === 0) {
      return res.status(400).json({
        code: 400,
        message: 'ç”¨æˆ·ä¸åœ¨æ­¤æˆ¿é—´æˆ–ä¸å­˜åœ¨'
      });
    }

    const user = users[0];

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // ç§»é™¤ç”¨æˆ·çš„æˆ¿é—´ä¿¡æ¯
      await connection.execute(
        `UPDATE users 
         SET building_id = NULL, room_id = NULL, updated_at = NOW()
         WHERE id = ?`,
        [user_id]
      );

      // æ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
      await connection.execute(
        `UPDATE rooms 
         SET current_occupancy = current_occupancy - 1,
             status = CASE 
               WHEN current_occupancy - 1 = 0 THEN 'available'
               ELSE 'occupied'
             END,
             updated_at = NOW()
         WHERE id = ?`,
        [roomId]
      );

      // æ›´æ–°æ¥¼æ ‹ç»Ÿè®¡
      await connection.execute(
        `UPDATE buildings 
         SET occupied_rooms = occupied_rooms - 1,
             available_rooms = available_rooms + 1
         WHERE id = ?`,
        [user.building_id]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'ç§»é™¤ä½æˆ·æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('ç§»é™¤ä½æˆ·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æ¥¼æ ‹ç»Ÿè®¡ä¿¡æ¯
router.get('/buildings/:id/stats', authMiddleware(), async (req, res) => {
  try {
    const buildingId = req.params.id;

    // è·å–æ¥¼æ ‹åŸºæœ¬ä¿¡æ¯
    const [buildings] = await pool.execute(
      `SELECT id, building_name, building_code, 
              total_rooms, occupied_rooms, available_rooms
       FROM buildings WHERE id = ?`,
      [buildingId]
    );

    if (buildings.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    const building = buildings[0];

    // è·å–æ¥¼å±‚æˆ¿é—´ç»Ÿè®¡
    const [floorStats] = await pool.execute(
      `SELECT floor, 
              COUNT(*) as total_rooms,
              SUM(CASE WHEN status = 'available' THEN 1 ELSE 0 END) as available_rooms,
              SUM(CASE WHEN status = 'occupied' THEN 1 ELSE 0 END) as occupied_rooms,
              SUM(CASE WHEN status = 'maintenance' THEN 1 ELSE 0 END) as maintenance_rooms,
              SUM(CASE WHEN status = 'reserved' THEN 1 ELSE 0 END) as reserved_rooms
       FROM rooms 
       WHERE building_id = ? 
       GROUP BY floor 
       ORDER BY floor ASC`,
      [buildingId]
    );

    // è·å–æˆ¿é—´ç±»å‹ç»Ÿè®¡
    const [typeStats] = await pool.execute(
      `SELECT room_type, COUNT(*) as count 
       FROM rooms 
       WHERE building_id = ? 
       GROUP BY room_type`,
      [buildingId]
    );

    // è·å–ä½æˆ·æ€§åˆ«ç»Ÿè®¡ï¼ˆå¦‚æœç”¨æˆ·è¡¨æœ‰genderå­—æ®µï¼‰
    const [genderStats] = await pool.execute(
      `SELECT 
         COUNT(CASE WHEN gender = 'male' THEN 1 END) as male_count,
         COUNT(CASE WHEN gender = 'female' THEN 1 END) as female_count,
         COUNT(CASE WHEN gender IS NULL OR gender = '' THEN 1 END) as unknown_count
       FROM users 
       WHERE building_id = ? AND role = 'student' AND status = 'active'`,
      [buildingId]
    );

    // è·å–å…¥ä½ç‡è¶‹åŠ¿ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
    const [occupancyTrend] = await pool.execute(
      `SELECT 
         DATE_FORMAT(created_at, '%Y-%m') as month,
         COUNT(*) as new_occupants
       FROM users 
       WHERE building_id = ? 
         AND room_id IS NOT NULL
         AND created_at >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
       GROUP BY DATE_FORMAT(created_at, '%Y-%m')
       ORDER BY month ASC`,
      [buildingId]
    );

    const stats = {
      building_info: building,
      floor_stats: floorStats,
      type_stats: typeStats,
      gender_stats: genderStats[0] || { male_count: 0, female_count: 0, unknown_count: 0 },
      occupancy_trend: occupancyTrend,
      summary: {
        total_floors: Math.max(...floorStats.map(f => f.floor), 0),
        occupancy_rate: building.total_rooms > 0 ? (building.occupied_rooms / building.total_rooms * 100).toFixed(2) : 0,
        available_rate: building.total_rooms > 0 ? (building.available_rooms / building.total_rooms * 100).toFixed(2) : 0
      }
    };

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: stats
    });

  } catch (error) {
    console.error('è·å–æ¥¼æ ‹ç»Ÿè®¡é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–å«ç”Ÿæ£€æŸ¥åˆ—è¡¨
router.get('/', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('floor').optional().isInt({ min: 1 }).toInt(),
  query('checker_id').optional().isInt({ min: 1 }).toInt(),
  query('status').optional().isIn(['draft', 'completed', 'published']),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      building_id,
      floor,
      checker_id,
      status,
      start_date,
      end_date
    } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å­¦ç”Ÿåªèƒ½çœ‹åˆ°å·²å‘å¸ƒçš„æ£€æŸ¥
    if (req.user.role === 'student') {
      whereConditions.push('h.status = "published"');
      // å­¦ç”Ÿåªèƒ½çœ‹åˆ°è‡ªå·±æ‰€åœ¨æ¥¼æ ‹çš„æ£€æŸ¥
      const [studentInfo] = await pool.execute(
        'SELECT building_id FROM users WHERE id = ?',
        [req.user.id]
      );
      if (studentInfo.length > 0 && studentInfo[0].building_id) {
        whereConditions.push('h.building_id = ?');
        params.push(studentInfo[0].building_id);
      } else {
        // å¦‚æœå­¦ç”Ÿæ²¡æœ‰åˆ†é…æ¥¼æ ‹ï¼Œåˆ™è¿”å›ç©º
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
    }
    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„æ£€æŸ¥
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`h.building_id IN (${buildingIds.join(',')})`);
      } else {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('h.building_id = ?');
      params.push(building_id);
    }

    if (floor) {
      whereConditions.push('h.floor = ?');
      params.push(floor);
    }

    if (checker_id) {
      whereConditions.push('h.checker_id = ?');
      params.push(checker_id);
    }

    if (status) {
      whereConditions.push('h.status = ?');
      params.push(status);
    }

    if (start_date) {
      whereConditions.push('DATE(h.check_date) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(h.check_date) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM hygiene_checks h
       WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢å«ç”Ÿæ£€æŸ¥åˆ—è¡¨
    const [checks] = await pool.execute(
      `SELECT h.id, h.check_number, h.building_id, h.floor, 
              h.checker_id, h.check_date, h.total_score, h.average_score,
              h.passed_rooms, h.failed_rooms, h.status, h.created_at,
              b.building_name, b.building_code,
              u.real_name as checker_name
       FROM hygiene_checks h
       JOIN buildings b ON h.building_id = b.id
       JOIN users u ON h.checker_id = u.id
       WHERE ${whereClause}
       ORDER BY h.check_date DESC, h.created_at DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: checks,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–å«ç”Ÿæ£€æŸ¥åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å«ç”Ÿæ£€æŸ¥è¯¦æƒ…
router.get('/:id', authMiddleware(), async (req, res) => {
  try {
    const checkId = req.params.id;

    // è·å–æ£€æŸ¥åŸºæœ¬ä¿¡æ¯
    const [checks] = await pool.execute(
      `SELECT h.id, h.check_number, h.building_id, h.floor, 
              h.checker_id, h.check_date, h.room_scores, h.total_score, h.average_score,
              h.comments, h.passed_rooms, h.failed_rooms, h.status, h.created_at,
              b.building_name, b.building_code,
              u.real_name as checker_name
       FROM hygiene_checks h
       JOIN buildings b ON h.building_id = b.id
       JOIN users u ON h.checker_id = u.id
       WHERE h.id = ?`,
      [checkId]
    );

    if (checks.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å«ç”Ÿæ£€æŸ¥è®°å½•ä¸å­˜åœ¨'
      });
    }

    const check = checks[0];

    // æƒé™æ£€æŸ¥
    // å­¦ç”Ÿåªèƒ½æŸ¥çœ‹å·²å‘å¸ƒçš„æ£€æŸ¥ï¼Œå¹¶ä¸”åªèƒ½æ˜¯è‡ªå·±æ¥¼æ ‹çš„
    if (req.user.role === 'student') {
      if (check.status !== 'published') {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥æ£€æŸ¥è®°å½•'
        });
      }
      // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨è¯¥æ¥¼æ ‹
      const [studentInfo] = await pool.execute(
        'SELECT building_id FROM users WHERE id = ?',
        [req.user.id]
      );
      if (studentInfo.length === 0 || studentInfo[0].building_id !== check.building_id) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥æ£€æŸ¥è®°å½•'
        });
      }
    }
    // å®¿ç®¡åªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„æ£€æŸ¥
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(check.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥æ£€æŸ¥è®°å½•'
        });
      }
    }

    // è§£ææˆ¿é—´åˆ†æ•°
    if (check.room_scores) {
      try {
        check.room_scores = JSON.parse(check.room_scores);
      } catch (e) {
        check.room_scores = {};
      }
    } else {
      check.room_scores = {};
    }

    // è·å–æˆ¿é—´è¯¦æƒ…ï¼ˆæˆ¿é—´å·ç­‰ï¼‰
    const roomNumbers = Object.keys(check.room_scores);
    if (roomNumbers.length > 0) {
      const [rooms] = await pool.execute(
        `SELECT id, room_number, floor 
         FROM rooms 
         WHERE building_id = ? AND room_number IN (?)`,
        [check.building_id, roomNumbers]
      );
      // å°†æˆ¿é—´ä¿¡æ¯åˆå¹¶åˆ°åˆ†æ•°ä¸­
      const roomMap = {};
      rooms.forEach(room => {
        roomMap[room.room_number] = room;
      });
      // é‡æ„room_scoresï¼ŒåŒ…å«æˆ¿é—´ä¿¡æ¯
      const detailedScores = [];
      for (const roomNumber in check.room_scores) {
        detailedScores.push({
          room_number: roomNumber,
          score: check.room_scores[roomNumber],
          floor: roomMap[roomNumber] ? roomMap[roomNumber].floor : null,
          room_id: roomMap[roomNumber] ? roomMap[roomNumber].id : null
        });
      }
      check.room_scores = detailedScores;
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: check
    });

  } catch (error) {
    console.error('è·å–å«ç”Ÿæ£€æŸ¥è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ›å»ºå«ç”Ÿæ£€æŸ¥ï¼ˆç®¡ç†å‘˜ã€å®¿ç®¡ï¼‰
router.post('/', authMiddleware(['admin', 'staff']), [
  body('building_id').isInt({ min: 1 }).withMessage('æ¥¼æ ‹IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('floor').isInt({ min: 1 }).withMessage('æ¥¼å±‚å¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('check_date').isDate().withMessage('æ£€æŸ¥æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®'),
  body('room_scores').isJSON().withMessage('æˆ¿é—´åˆ†æ•°å¿…é¡»æ˜¯JSONæ ¼å¼'),
  body('comments').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      building_id,
      floor,
      check_date,
      room_scores,
      comments = ''
    } = req.body;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [buildingExists] = await pool.execute(
      'SELECT id FROM buildings WHERE id = ?',
      [building_id]
    );

    if (buildingExists.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    // æƒé™æ£€æŸ¥ï¼šå®¿ç®¡åªèƒ½ç®¡ç†è‡ªå·±è´Ÿè´£çš„æ¥¼æ ‹
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒå¯¹è¯¥æ¥¼æ ‹è¿›è¡Œå«ç”Ÿæ£€æŸ¥'
        });
      }
    }

    // è§£ææˆ¿é—´åˆ†æ•°
    let scores;
    try {
      scores = JSON.parse(room_scores);
    } catch (e) {
      return res.status(400).json({
        code: 400,
        message: 'æˆ¿é—´åˆ†æ•°JSONæ ¼å¼é”™è¯¯'
      });
    }

    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    const roomNumbers = Object.keys(scores);
    const totalScore = Object.values(scores).reduce((sum, score) => sum + score, 0);
    const averageScore = totalScore / roomNumbers.length;
    const passedRooms = Object.values(scores).filter(score => score >= 60).length;
    const failedRooms = roomNumbers.length - passedRooms;

    // ç”Ÿæˆæ£€æŸ¥ç¼–å·
    const checkNumber = `HC${Date.now()}${Math.floor(Math.random() * 1000)}`;

    // åˆ›å»ºå«ç”Ÿæ£€æŸ¥è®°å½•
    const [result] = await pool.execute(
      `INSERT INTO hygiene_checks 
       (check_number, building_id, floor, checker_id, check_date,
        room_scores, total_score, average_score, comments,
        passed_rooms, failed_rooms, status)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'completed')`,
      [
        checkNumber,
        building_id,
        floor,
        req.user.id,
        check_date,
        room_scores,
        totalScore,
        averageScore,
        comments,
        passedRooms,
        failedRooms
      ]
    );

    res.status(201).json({
      code: 200,
      message: 'å«ç”Ÿæ£€æŸ¥è®°å½•åˆ›å»ºæˆåŠŸ',
      data: {
        id: result.insertId,
        check_number: checkNumber
      }
    });

  } catch (error) {
    console.error('åˆ›å»ºå«ç”Ÿæ£€æŸ¥é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°å«ç”Ÿæ£€æŸ¥çŠ¶æ€ï¼ˆå‘å¸ƒã€å–æ¶ˆå‘å¸ƒç­‰ï¼‰
router.put('/:id/status', authMiddleware(['admin', 'staff']), [
  body('status').isIn(['draft', 'completed', 'published']).withMessage('çŠ¶æ€ä¸æ­£ç¡®')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const checkId = req.params.id;
    const { status } = req.body;

    // æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingChecks] = await pool.execute(
      'SELECT id, building_id FROM hygiene_checks WHERE id = ?',
      [checkId]
    );

    if (existingChecks.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å«ç”Ÿæ£€æŸ¥è®°å½•ä¸å­˜åœ¨'
      });
    }

    const existingCheck = existingChecks[0];

    // æƒé™æ£€æŸ¥ï¼šå®¿ç®¡åªèƒ½ç®¡ç†è‡ªå·±è´Ÿè´£çš„æ¥¼æ ‹
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(existingCheck.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæ›´æ–°è¯¥å«ç”Ÿæ£€æŸ¥è®°å½•'
        });
      }
    }

    // æ›´æ–°çŠ¶æ€
    await pool.execute(
      'UPDATE hygiene_checks SET status = ?, updated_at = NOW() WHERE id = ?',
      [status, checkId]
    );

    res.json({
      code: 200,
      message: 'å«ç”Ÿæ£€æŸ¥çŠ¶æ€æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°å«ç”Ÿæ£€æŸ¥çŠ¶æ€é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤å«ç”Ÿæ£€æŸ¥è®°å½•ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const checkId = req.params.id;

    // æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingChecks] = await pool.execute(
      'SELECT id FROM hygiene_checks WHERE id = ?',
      [checkId]
    );

    if (existingChecks.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å«ç”Ÿæ£€æŸ¥è®°å½•ä¸å­˜åœ¨'
      });
    }

    // åˆ é™¤è®°å½•
    await pool.execute(
      'DELETE FROM hygiene_checks WHERE id = ?',
      [checkId]
    );

    res.json({
      code: 200,
      message: 'å«ç”Ÿæ£€æŸ¥è®°å½•åˆ é™¤æˆåŠŸ'
    });

  } catch (error) {
    console.error('åˆ é™¤å«ç”Ÿæ£€æŸ¥è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å«ç”Ÿæ£€æŸ¥ç»Ÿè®¡
router.get('/stats/overview', authMiddleware(['admin', 'staff']), [
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { building_id, start_date, end_date } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„ç»Ÿè®¡
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`building_id IN (${buildingIds.join(',')})`);
      } else {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            overview: {
              total_checks: 0,
              average_score: 0,
              total_passed_rooms: 0,
              total_failed_rooms: 0
            },
            by_building: [],
            by_month: []
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('building_id = ?');
      params.push(building_id);
    }

    if (start_date) {
      whereConditions.push('DATE(check_date) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(check_date) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è·å–æ€»ä½“ç»Ÿè®¡
    const [overviewStats] = await pool.execute(
      `SELECT 
         COUNT(*) as total_checks,
         AVG(average_score) as average_score,
         SUM(passed_rooms) as total_passed_rooms,
         SUM(failed_rooms) as total_failed_rooms
       FROM hygiene_checks
       WHERE ${whereClause} AND status = 'completed'`,
      params
    );

    // æŒ‰æ¥¼æ ‹ç»Ÿè®¡
    const [buildingStats] = await pool.execute(
      `SELECT b.id, b.building_name, b.building_code,
              COUNT(h.id) as check_count,
              AVG(h.average_score) as avg_score,
              SUM(h.passed_rooms) as total_passed,
              SUM(h.failed_rooms) as total_failed
       FROM buildings b
       LEFT JOIN hygiene_checks h ON b.id = h.building_id AND h.status = 'completed' AND ${whereClause.replace('building_id', 'h.building_id')}
       GROUP BY b.id, b.building_name, b.building_code
       ORDER BY avg_score DESC`,
      params.filter(p => !building_id || p === building_id)
    );

    // æŒ‰æœˆç»Ÿè®¡ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
    const monthlyParams = [...params];
    const monthlyWhereClause = whereClause;
    
    const [monthlyStats] = await pool.execute(
      `SELECT 
         DATE_FORMAT(check_date, '%Y-%m') as month,
         COUNT(*) as check_count,
         AVG(average_score) as avg_score
       FROM hygiene_checks
       WHERE ${monthlyWhereClause}
         AND status = 'completed'
         AND check_date >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
       GROUP BY DATE_FORMAT(check_date, '%Y-%m')
       ORDER BY month ASC`,
      monthlyParams
    );

    const stats = {
      overview: overviewStats[0] || {
        total_checks: 0,
        average_score: 0,
        total_passed_rooms: 0,
        total_failed_rooms: 0
      },
      by_building: buildingStats,
      by_month: monthlyStats
    };

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: stats
    });

  } catch (error) {
    console.error('è·å–å«ç”Ÿæ£€æŸ¥ç»Ÿè®¡é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



// server/routes/notices.js
const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–å…¬å‘Šåˆ—è¡¨
router.get('/', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('notice_type').optional().isIn(['system', 'maintenance', 'activity', 'emergency', 'other']),
  query('status').optional().isIn(['draft', 'published', 'expired']),
  query('keyword').optional().isString(),
  query('is_top').optional().isBoolean().toBoolean()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      notice_type,
      status,
      keyword,
      is_top
    } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²ç¡®å®šå¯è§çš„å…¬å‘ŠçŠ¶æ€
    let allowedStatuses = [];
    if (req.user.role === 'admin' || req.user.role === 'staff') {
      allowedStatuses = ['draft', 'published', 'expired'];
    } else {
      // å­¦ç”Ÿåªèƒ½çœ‹åˆ°å·²å‘å¸ƒçš„å…¬å‘Š
      allowedStatuses = ['published'];
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // çŠ¶æ€ç­›é€‰
    if (status) {
      // æ£€æŸ¥è¯·æ±‚çš„çŠ¶æ€æ˜¯å¦åœ¨å…è®¸çš„èŒƒå›´å†…
      if (allowedStatuses.includes(status)) {
        whereConditions.push('n.status = ?');
        params.push(status);
      } else {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥çŠ¶æ€çš„å…¬å‘Š'
        });
      }
    } else {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šçŠ¶æ€ï¼Œæ ¹æ®è§’è‰²æ˜¾ç¤ºç›¸åº”çŠ¶æ€çš„å…¬å‘Š
      whereConditions.push(`n.status IN (${allowedStatuses.map(() => '?').join(',')})`);
      params.push(...allowedStatuses);
    }

    // ç±»å‹ç­›é€‰
    if (notice_type) {
      whereConditions.push('n.notice_type = ?');
      params.push(notice_type);
    }

    // ç½®é¡¶ç­›é€‰
    if (is_top !== undefined) {
      whereConditions.push('n.is_top = ?');
      params.push(is_top ? 1 : 0);
    }

    // å…³é”®è¯æœç´¢
    if (keyword) {
      whereConditions.push('(n.title LIKE ? OR n.content LIKE ?)');
      const likeKeyword = `%${keyword}%`;
      params.push(likeKeyword, likeKeyword);
    }

    // å­¦ç”Ÿç”¨æˆ·ï¼šåªæ˜¾ç¤ºæœªè¿‡æœŸä¸”å·²å‘å¸ƒçš„å…¬å‘Š
    if (req.user.role === 'student') {
      whereConditions.push('(n.end_time IS NULL OR n.end_time >= NOW())');
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM notices n
       WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ - å…³é”®ä¿®å¤ï¼šç¡®ä¿å‚æ•°æ˜¯æ•°å­—ç±»å‹
    const pageNum = parseInt(page, 10) || 1;
    const pageSizeNum = parseInt(pageSize, 10) || 20;
    const offset = (pageNum - 1) * pageSizeNum;

    // åˆ›å»ºæ–°çš„å‚æ•°æ•°ç»„ï¼ˆé¿å…æ±¡æŸ“åŸparamsæ•°ç»„ï¼‰
    const queryParams = [...params, pageSizeNum, offset];

    // æŸ¥è¯¢å…¬å‘Šåˆ—è¡¨
    const [notices] = await pool.execute(
      `SELECT n.id, n.title, n.content, n.notice_type, n.target_roles,
              n.target_buildings, n.is_top, n.start_time, n.end_time,
              n.status, n.view_count, n.created_at, n.updated_at,
              u.real_name as publisher_name
       FROM notices n
       JOIN users u ON n.publisher_id = u.id
       WHERE ${whereClause}
       ORDER BY n.is_top DESC, n.created_at DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    // å¤„ç†JSONå­—æ®µ
    notices.forEach(notice => {
      if (notice.target_roles) {
        try {
          notice.target_roles = JSON.parse(notice.target_roles);
        } catch (e) {
          notice.target_roles = [];
        }
      } else {
        notice.target_roles = [];
      }

      if (notice.target_buildings) {
        try {
          notice.target_buildings = JSON.parse(notice.target_buildings);
        } catch (e) {
          notice.target_buildings = [];
        }
      } else {
        notice.target_buildings = [];
      }
    });

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: notices,
        pagination: {
          page: pageNum,
          pageSize: pageSizeNum,
          total,
          totalPages: Math.ceil(total / pageSizeNum)
        }
      }
    });

  } catch (error) {
    console.error('è·å–å…¬å‘Šåˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

// è·å–å…¬å‘Šè¯¦æƒ…
router.get('/:id', authMiddleware(), async (req, res) => {
  try {
    const noticeId = req.params.id;

    // æŸ¥è¯¢å…¬å‘Šè¯¦æƒ…
    const [notices] = await pool.execute(
      `SELECT n.id, n.title, n.content, n.notice_type, n.target_roles,
              n.target_buildings, n.is_top, n.start_time, n.end_time,
              n.status, n.view_count, n.created_at, n.updated_at,
              u.real_name as publisher_name, u.id as publisher_id
       FROM notices n
       JOIN users u ON n.publisher_id = u.id
       WHERE n.id = ?`,
      [noticeId]
    );

    if (notices.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å…¬å‘Šä¸å­˜åœ¨'
      });
    }

    const notice = notices[0];

    // æƒé™æ£€æŸ¥
    if (notice.status === 'draft' && req.user.role !== 'admin' && req.user.role !== 'staff') {
      return res.status(403).json({
        code: 403,
        message: 'æ— æƒæŸ¥çœ‹è‰ç¨¿å…¬å‘Š'
      });
    }

    if (notice.status === 'published' && req.user.role === 'student') {
      // æ£€æŸ¥å…¬å‘Šæ˜¯å¦å·²è¿‡æœŸ
      if (notice.end_time && new Date(notice.end_time) < new Date()) {
        return res.status(403).json({
          code: 403,
          message: 'å…¬å‘Šå·²è¿‡æœŸ'
        });
      }
    }

    // å¤„ç†JSONå­—æ®µ
    if (notice.target_roles) {
      try {
        notice.target_roles = JSON.parse(notice.target_roles);
      } catch (e) {
        notice.target_roles = [];
      }
    } else {
      notice.target_roles = [];
    }

    if (notice.target_buildings) {
      try {
        notice.target_buildings = JSON.parse(notice.target_buildings);
      } catch (e) {
        notice.target_buildings = [];
      }
    } else {
      notice.target_buildings = [];
    }

    // å¢åŠ æµè§ˆé‡ï¼ˆä»…å¯¹å·²å‘å¸ƒçš„å…¬å‘Šï¼‰
    if (notice.status === 'published' && (req.user.role === 'student' || req.user.role === 'staff')) {
      await pool.execute(
        'UPDATE notices SET view_count = view_count + 1 WHERE id = ?',
        [noticeId]
      );
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: notice
    });

  } catch (error) {
    console.error('è·å–å…¬å‘Šè¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ›å»ºå…¬å‘Šï¼ˆä»…ç®¡ç†å‘˜å’Œå®¿ç®¡ï¼‰
router.post('/', authMiddleware(['admin', 'staff']), [
  body('title').notEmpty().withMessage('æ ‡é¢˜ä¸èƒ½ä¸ºç©º').isLength({ max: 200 }).withMessage('æ ‡é¢˜æœ€é•¿200å­—ç¬¦'),
  body('content').notEmpty().withMessage('å†…å®¹ä¸èƒ½ä¸ºç©º'),
  body('notice_type').isIn(['system', 'maintenance', 'activity', 'emergency', 'other']).withMessage('å…¬å‘Šç±»å‹ä¸æ­£ç¡®'),
  body('target_roles').optional().isArray().withMessage('ç›®æ ‡è§’è‰²å¿…é¡»æ˜¯æ•°ç»„'),
  body('target_roles.*').optional().isIn(['admin', 'staff', 'student']).withMessage('è§’è‰²ç±»å‹ä¸æ­£ç¡®'),
  body('target_buildings').optional().isArray().withMessage('ç›®æ ‡æ¥¼æ ‹å¿…é¡»æ˜¯æ•°ç»„'),
  body('is_top').optional().isBoolean().toBoolean(),
  body('start_time').notEmpty().withMessage('å¼€å§‹æ—¶é—´ä¸èƒ½ä¸ºç©º').isISO8601().withMessage('å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('end_time').optional().isISO8601().withMessage('ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('status').optional().isIn(['draft', 'published']).withMessage('çŠ¶æ€ä¸æ­£ç¡®')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      title,
      content,
      notice_type,
      target_roles = [],
      target_buildings = [],
      is_top = false,
      start_time,
      end_time,
      status = 'draft'
    } = req.body;

    const publisherId = req.user.id;

    // æ£€æŸ¥æ—¶é—´æœ‰æ•ˆæ€§
    const startTime = new Date(start_time);
    const currentTime = new Date();

    if (startTime < currentTime && status === 'published') {
      return res.status(400).json({
        code: 400,
        message: 'å·²å‘å¸ƒçš„å…¬å‘Šå¼€å§‹æ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´'
      });
    }

    if (end_time) {
      const endTime = new Date(end_time);
      if (endTime <= startTime) {
        return res.status(400).json({
          code: 400,
          message: 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'
        });
      }
    }

    // å¤„ç†JSONå­—æ®µ
    const targetRolesJson = JSON.stringify(target_roles);
    const targetBuildingsJson = JSON.stringify(target_buildings);

    // åˆ›å»ºå…¬å‘Š
    const [result] = await pool.execute(
      `INSERT INTO notices 
       (title, content, publisher_id, notice_type, target_roles, 
        target_buildings, is_top, start_time, end_time, status)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        title,
        content,
        publisherId,
        notice_type,
        targetRolesJson,
        targetBuildingsJson,
        is_top,
        start_time,
        end_time || null,
        status
      ]
    );

    res.status(201).json({
      code: 200,
      message: 'å…¬å‘Šåˆ›å»ºæˆåŠŸ',
      data: {
        id: result.insertId,
        title,
        status
      }
    });

  } catch (error) {
    console.error('åˆ›å»ºå…¬å‘Šé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°å…¬å‘Šï¼ˆä»…ç®¡ç†å‘˜å’Œå®¿ç®¡ï¼Œä¸”åªèƒ½æ›´æ–°è‡ªå·±åˆ›å»ºçš„å…¬å‘Šï¼‰
router.put('/:id', authMiddleware(['admin', 'staff']), [
  body('title').optional().notEmpty().withMessage('æ ‡é¢˜ä¸èƒ½ä¸ºç©º').isLength({ max: 200 }).withMessage('æ ‡é¢˜æœ€é•¿200å­—ç¬¦'),
  body('content').optional().notEmpty().withMessage('å†…å®¹ä¸èƒ½ä¸ºç©º'),
  body('notice_type').optional().isIn(['system', 'maintenance', 'activity', 'emergency', 'other']).withMessage('å…¬å‘Šç±»å‹ä¸æ­£ç¡®'),
  body('target_roles').optional().isArray().withMessage('ç›®æ ‡è§’è‰²å¿…é¡»æ˜¯æ•°ç»„'),
  body('target_roles.*').optional().isIn(['admin', 'staff', 'student']).withMessage('è§’è‰²ç±»å‹ä¸æ­£ç¡®'),
  body('target_buildings').optional().isArray().withMessage('ç›®æ ‡æ¥¼æ ‹å¿…é¡»æ˜¯æ•°ç»„'),
  body('is_top').optional().isBoolean().toBoolean(),
  body('start_time').optional().isISO8601().withMessage('å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('end_time').optional().isISO8601().withMessage('ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('status').optional().isIn(['draft', 'published', 'expired']).withMessage('çŠ¶æ€ä¸æ­£ç¡®')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const noticeId = req.params.id;
    const userId = req.user.id;

    // æ£€æŸ¥å…¬å‘Šæ˜¯å¦å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
    const [existingNotices] = await pool.execute(
      `SELECT id, publisher_id, status 
       FROM notices WHERE id = ?`,
      [noticeId]
    );

    if (existingNotices.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å…¬å‘Šä¸å­˜åœ¨'
      });
    }

    const existingNotice = existingNotices[0];

    // æ£€æŸ¥æƒé™ï¼ˆç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ä»»ä½•å…¬å‘Šï¼Œå®¿ç®¡åªèƒ½ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„ï¼‰
    if (req.user.role === 'staff' && existingNotice.publisher_id !== userId) {
      return res.status(403).json({
        code: 403,
        message: 'åªèƒ½ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„å…¬å‘Š'
      });
    }

    // å·²å‘å¸ƒçš„å…¬å‘Šä¸èƒ½ç›´æ¥ä¿®æ”¹ä¸ºè‰ç¨¿
    const {
      title,
      content,
      notice_type,
      target_roles,
      target_buildings,
      is_top,
      start_time,
      end_time,
      status
    } = req.body;

    if (existingNotice.status === 'published' && status === 'draft') {
      return res.status(400).json({
        code: 400,
        message: 'å·²å‘å¸ƒçš„å…¬å‘Šä¸èƒ½æ”¹ä¸ºè‰ç¨¿çŠ¶æ€'
      });
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = [];
    const updateValues = [];

    if (title !== undefined) {
      updateFields.push('title = ?');
      updateValues.push(title);
    }

    if (content !== undefined) {
      updateFields.push('content = ?');
      updateValues.push(content);
    }

    if (notice_type !== undefined) {
      updateFields.push('notice_type = ?');
      updateValues.push(notice_type);
    }

    if (target_roles !== undefined) {
      const targetRolesJson = JSON.stringify(target_roles);
      updateFields.push('target_roles = ?');
      updateValues.push(targetRolesJson);
    }

    if (target_buildings !== undefined) {
      const targetBuildingsJson = JSON.stringify(target_buildings);
      updateFields.push('target_buildings = ?');
      updateValues.push(targetBuildingsJson);
    }

    if (is_top !== undefined) {
      updateFields.push('is_top = ?');
      updateValues.push(is_top ? 1 : 0);
    }

    if (start_time !== undefined) {
      updateFields.push('start_time = ?');
      updateValues.push(start_time);
    }

    if (end_time !== undefined) {
      updateFields.push('end_time = ?');
      updateValues.push(end_time || null);
    }

    if (status !== undefined) {
      updateFields.push('status = ?');
      updateValues.push(status);
    }

    if (updateFields.length === 0) {
      return res.status(400).json({
        code: 400,
        message: 'æ²¡æœ‰å¯æ›´æ–°çš„å­—æ®µ'
      });
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(noticeId);
    await pool.execute(
      `UPDATE notices SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    res.json({
      code: 200,
      message: 'å…¬å‘Šæ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°å…¬å‘Šé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤å…¬å‘Šï¼ˆä»…ç®¡ç†å‘˜å’Œå®¿ç®¡ï¼Œä¸”åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„è‰ç¨¿å…¬å‘Šï¼‰
router.delete('/:id', authMiddleware(['admin', 'staff']), async (req, res) => {
  try {
    const noticeId = req.params.id;
    const userId = req.user.id;

    // æ£€æŸ¥å…¬å‘Šæ˜¯å¦å­˜åœ¨
    const [existingNotices] = await pool.execute(
      `SELECT id, publisher_id, status 
       FROM notices WHERE id = ?`,
      [noticeId]
    );

    if (existingNotices.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å…¬å‘Šä¸å­˜åœ¨'
      });
    }

    const existingNotice = existingNotices[0];

    // æ£€æŸ¥æƒé™
    if (req.user.role === 'staff' && existingNotice.publisher_id !== userId) {
      return res.status(403).json({
        code: 403,
        message: 'åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„å…¬å‘Š'
      });
    }

    // åªèƒ½åˆ é™¤è‰ç¨¿çŠ¶æ€çš„å…¬å‘Š
    if (existingNotice.status !== 'draft' && req.user.role === 'staff') {
      return res.status(400).json({
        code: 400,
        message: 'åªèƒ½åˆ é™¤è‰ç¨¿çŠ¶æ€çš„å…¬å‘Š'
      });
    }

    // ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•çŠ¶æ€çš„å…¬å‘Š
    if (existingNotice.status === 'published' && req.user.role === 'admin') {
      wx.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: 'ç¡®å®šè¦åˆ é™¤å·²å‘å¸ƒçš„å…¬å‘Šå—ï¼Ÿå­¦ç”Ÿå°†æ— æ³•å†æŸ¥çœ‹æ­¤å…¬å‘Šã€‚',
        success: async (res) => {
          if (!res.confirm) {
            return res.status(400).json({
              code: 400,
              message: 'å–æ¶ˆåˆ é™¤'
            });
          }
        }
      });
    }

    // åˆ é™¤å…¬å‘Š
    await pool.execute(
      'DELETE FROM notices WHERE id = ?',
      [noticeId]
    );

    res.json({
      code: 200,
      message: 'å…¬å‘Šåˆ é™¤æˆåŠŸ'
    });

  } catch (error) {
    console.error('åˆ é™¤å…¬å‘Šé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// ç½®é¡¶/å–æ¶ˆç½®é¡¶å…¬å‘Šï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.put('/:id/top', authMiddleware(['admin']), [
  body('is_top').isBoolean().withMessage('ç½®é¡¶çŠ¶æ€å¿…é¡»æ˜¯å¸ƒå°”å€¼')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const noticeId = req.params.id;
    const { is_top } = req.body;

    // æ£€æŸ¥å…¬å‘Šæ˜¯å¦å­˜åœ¨
    const [existingNotices] = await pool.execute(
      'SELECT id FROM notices WHERE id = ?',
      [noticeId]
    );

    if (existingNotices.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å…¬å‘Šä¸å­˜åœ¨'
      });
    }

    // æ›´æ–°ç½®é¡¶çŠ¶æ€
    await pool.execute(
      'UPDATE notices SET is_top = ?, updated_at = NOW() WHERE id = ?',
      [is_top ? 1 : 0, noticeId]
    );

    res.json({
      code: 200,
      message: is_top ? 'å…¬å‘Šå·²ç½®é¡¶' : 'å…¬å‘Šå·²å–æ¶ˆç½®é¡¶'
    });

  } catch (error) {
    console.error('æ›´æ–°ç½®é¡¶çŠ¶æ€é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// å‘å¸ƒå…¬å‘Šï¼ˆå°†è‰ç¨¿çŠ¶æ€æ”¹ä¸ºå‘å¸ƒçŠ¶æ€ï¼‰
router.put('/:id/publish', authMiddleware(['admin', 'staff']), async (req, res) => {
  try {
    const noticeId = req.params.id;
    const userId = req.user.id;

    // æ£€æŸ¥å…¬å‘Šæ˜¯å¦å­˜åœ¨
    const [existingNotices] = await pool.execute(
      `SELECT id, publisher_id, status, start_time 
       FROM notices WHERE id = ?`,
      [noticeId]
    );

    if (existingNotices.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å…¬å‘Šä¸å­˜åœ¨'
      });
    }

    const existingNotice = existingNotices[0];

    // æ£€æŸ¥æƒé™
    if (req.user.role === 'staff' && existingNotice.publisher_id !== userId) {
      return res.status(403).json({
        code: 403,
        message: 'åªèƒ½å‘å¸ƒè‡ªå·±åˆ›å»ºçš„å…¬å‘Š'
      });
    }

    // åªèƒ½å‘å¸ƒè‰ç¨¿çŠ¶æ€çš„å…¬å‘Š
    if (existingNotice.status !== 'draft') {
      return res.status(400).json({
        code: 400,
        message: 'åªèƒ½å‘å¸ƒè‰ç¨¿çŠ¶æ€çš„å…¬å‘Š'
      });
    }

    // æ£€æŸ¥å¼€å§‹æ—¶é—´æ˜¯å¦åˆç†
    const startTime = new Date(existingNotice.start_time);
    const currentTime = new Date();

    if (startTime < currentTime) {
      // å¦‚æœå¼€å§‹æ—¶é—´å·²è¿‡ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºå½“å‰æ—¶é—´
      await pool.execute(
        `UPDATE notices 
         SET status = 'published', start_time = NOW(), updated_at = NOW()
         WHERE id = ?`,
        [noticeId]
      );
    } else {
      // ä¿æŒåŸå¼€å§‹æ—¶é—´
      await pool.execute(
        `UPDATE notices 
         SET status = 'published', updated_at = NOW()
         WHERE id = ?`,
        [noticeId]
      );
    }

    res.json({
      code: 200,
      message: 'å…¬å‘Šå‘å¸ƒæˆåŠŸ'
    });

  } catch (error) {
    console.error('å‘å¸ƒå…¬å‘Šé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å½“å‰ç”¨æˆ·çš„å…¬å‘Šè‰ç¨¿
router.get('/my/drafts', authMiddleware(['admin', 'staff']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 50 }).toInt()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const userId = req.user.id;
    const {
      page = 1,
      pageSize = 20
    } = req.query;

    // è®¡ç®—åˆ†é¡µ - ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
    const pageNum = parseInt(page, 10) || 1;
    const pageSizeNum = parseInt(pageSize, 10) || 20;
    const offset = (pageNum - 1) * pageSizeNum;

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM notices 
       WHERE publisher_id = ? AND status = 'draft'`,
      [userId]
    );
    const total = countResult[0].total;

    // æŸ¥è¯¢è‰ç¨¿åˆ—è¡¨
    const [drafts] = await pool.execute(
      `SELECT id, title, notice_type, created_at, updated_at
       FROM notices 
       WHERE publisher_id = ? AND status = 'draft'
       ORDER BY updated_at DESC
       LIMIT ? OFFSET ?`,
      [userId, pageSizeNum, offset]
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: drafts,
        pagination: {
          page: pageNum,
          pageSize: pageSizeNum,
          total,
          totalPages: Math.ceil(total / pageSizeNum)
        }
      }
    });

  } catch (error) {
    console.error('è·å–è‰ç¨¿åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–æŠ¥ä¿®åˆ—è¡¨ï¼ˆç®¡ç†å‘˜å’Œå®¿ç®¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰ï¼Œå­¦ç”Ÿåªèƒ½çœ‹åˆ°è‡ªå·±çš„ï¼‰
router.get('/', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('room_id').optional().isInt({ min: 1 }).toInt(),
  query('repair_type').optional().isIn(['electricity', 'plumbing', 'furniture', 'air_conditioner', 'other']),
  query('status').optional().isIn(['pending', 'processing', 'completed', 'cancelled']),
  query('priority').optional().isIn(['low', 'medium', 'high', 'urgent']),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      building_id,
      room_id,
      repair_type,
      status,
      priority,
      start_date,
      end_date
    } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å­¦ç”Ÿåªèƒ½çœ‹åˆ°è‡ªå·±çš„æŠ¥ä¿®
    if (req.user.role === 'student') {
      whereConditions.push('r.student_id = ?');
      params.push(req.user.id);
    }
    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„æŠ¥ä¿®
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`r.building_id IN (${buildingIds.join(',')})`);
      } else {
        // å¦‚æœæ²¡æœ‰ç®¡ç†çš„æ¥¼æ ‹ï¼Œè¿”å›ç©ºåˆ—è¡¨
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('r.building_id = ?');
      params.push(building_id);
    }

    if (room_id) {
      whereConditions.push('r.room_id = ?');
      params.push(room_id);
    }

    if (repair_type) {
      whereConditions.push('r.repair_type = ?');
      params.push(repair_type);
    }

    if (status) {
      whereConditions.push('r.status = ?');
      params.push(status);
    }

    if (priority) {
      whereConditions.push('r.priority = ?');
      params.push(priority);
    }

    if (start_date) {
      whereConditions.push('DATE(r.created_at) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(r.created_at) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM repairs r
       WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢æŠ¥ä¿®åˆ—è¡¨
    const [repairs] = await pool.execute(
      `SELECT r.id, r.repair_number, r.repair_type, r.description, 
              r.images, r.status, r.priority, r.created_at, r.updated_at,
              r.completed_at, r.feedback, r.rating,
              b.building_name, b.building_code,
              rm.room_number, rm.floor,
              s.real_name as student_name, s.student_id, s.phone as student_phone,
              st.real_name as staff_name
       FROM repairs r
       JOIN buildings b ON r.building_id = b.id
       JOIN rooms rm ON r.room_id = rm.id
       JOIN users s ON r.student_id = s.id
       LEFT JOIN users st ON r.assigned_staff_id = st.id
       WHERE ${whereClause}
       ORDER BY 
         CASE r.priority
           WHEN 'urgent' THEN 1
           WHEN 'high' THEN 2
           WHEN 'medium' THEN 3
           WHEN 'low' THEN 4
         END,
         r.created_at DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    // è§£æå›¾ç‰‡JSON
    repairs.forEach(repair => {
      if (repair.images) {
        try {
          repair.images = JSON.parse(repair.images);
        } catch (e) {
          repair.images = [];
        }
      } else {
        repair.images = [];
      }
    });

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: repairs,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–æŠ¥ä¿®åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æŠ¥ä¿®è¯¦æƒ…
router.get('/:id', authMiddleware(), async (req, res) => {
  try {
    const repairId = req.params.id;

    // æ£€æŸ¥æƒé™
    const [repairs] = await pool.execute(
      `SELECT r.*, s.id as student_user_id
       FROM repairs r
       JOIN users s ON r.student_id = s.id
       WHERE r.id = ?`,
      [repairId]
    );

    if (repairs.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æŠ¥ä¿®è®°å½•ä¸å­˜åœ¨'
      });
    }

    const repair = repairs[0];

    // æ£€æŸ¥æƒé™ï¼šå­¦ç”Ÿåªèƒ½æŸ¥çœ‹è‡ªå·±çš„æŠ¥ä¿®ï¼Œå®¿ç®¡åªèƒ½æŸ¥çœ‹è‡ªå·±æ¥¼æ ‹çš„æŠ¥ä¿®
    if (req.user.role === 'student' && repair.student_user_id !== req.user.id) {
      return res.status(403).json({
        code: 403,
        message: 'æ— æƒæŸ¥çœ‹è¯¥æŠ¥ä¿®è®°å½•'
      });
    } else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(repair.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥æŠ¥ä¿®è®°å½•'
        });
      }
    }

    // è·å–å®Œæ•´ä¿¡æ¯
    const [repairDetails] = await pool.execute(
      `SELECT r.id, r.repair_number, r.repair_type, r.description, 
              r.images, r.status, r.priority, r.created_at, r.updated_at,
              r.completed_at, r.feedback, r.rating,
              b.building_name, b.building_code,
              rm.room_number, rm.floor,
              s.real_name as student_name, s.student_id, s.phone as student_phone, s.email as student_email,
              st.real_name as staff_name, st.phone as staff_phone
       FROM repairs r
       JOIN buildings b ON r.building_id = b.id
       JOIN rooms rm ON r.room_id = rm.id
       JOIN users s ON r.student_id = s.id
       LEFT JOIN users st ON r.assigned_staff_id = st.id
       WHERE r.id = ?`,
      [repairId]
    );

    if (repairDetails.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æŠ¥ä¿®è®°å½•ä¸å­˜åœ¨'
      });
    }

    const repairDetail = repairDetails[0];

    // è§£æå›¾ç‰‡JSON
    if (repairDetail.images) {
      try {
        repairDetail.images = JSON.parse(repairDetail.images);
      } catch (e) {
        repairDetail.images = [];
      }
    } else {
      repairDetail.images = [];
    }

    // è·å–å¤„ç†è¿›åº¦è®°å½•ï¼ˆå¦‚æœæœ‰è¿›åº¦è¡¨ï¼‰
    try {
      const [progressRecords] = await pool.execute(
        `SELECT id, step, description, created_at 
         FROM repair_progress 
         WHERE repair_id = ? 
         ORDER BY created_at ASC`,
        [repairId]
      );
      repairDetail.progress = progressRecords;
    } catch (error) {
      repairDetail.progress = [];
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: repairDetail
    });

  } catch (error) {
    console.error('è·å–æŠ¥ä¿®è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æäº¤æŠ¥ä¿®ï¼ˆå­¦ç”Ÿï¼‰
router.post('/', authMiddleware(['student']), [
  body('repair_type').isIn(['electricity', 'plumbing', 'furniture', 'air_conditioner', 'other']).withMessage('æŠ¥ä¿®ç±»å‹ä¸æ­£ç¡®'),
  body('description').notEmpty().withMessage('é—®é¢˜æè¿°ä¸èƒ½ä¸ºç©º'),
  body('images').optional().isJSON(),
  body('priority').optional().isIn(['low', 'medium', 'high', 'urgent'])
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const {
      repair_type,
      description,
      images = '[]',
      priority = 'medium'
    } = req.body;

    // è·å–å­¦ç”Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬å®¿èˆä¿¡æ¯
    const [students] = await pool.execute(
      'SELECT building_id, room_id FROM users WHERE id = ? AND role = "student"',
      [studentId]
    );

    if (students.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å­¦ç”Ÿä¸å­˜åœ¨'
      });
    }

    const student = students[0];

    if (!student.building_id || !student.room_id) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·å…ˆåˆ†é…å®¿èˆ'
      });
    }

    // ç”ŸæˆæŠ¥ä¿®ç¼–å·
    const repairNumber = `R${Date.now()}${Math.floor(Math.random() * 1000)}`;

    // åˆ›å»ºæŠ¥ä¿®è®°å½•
    const [result] = await pool.execute(
      `INSERT INTO repairs 
       (repair_number, student_id, building_id, room_id, 
        repair_type, description, images, priority)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        repairNumber,
        studentId,
        student.building_id,
        student.room_id,
        repair_type,
        description,
        images,
        priority
      ]
    );

    res.status(201).json({
      code: 200,
      message: 'æŠ¥ä¿®æäº¤æˆåŠŸ',
      data: {
        id: result.insertId,
        repair_number: repairNumber
      }
    });

  } catch (error) {
    console.error('æäº¤æŠ¥ä¿®é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°æŠ¥ä¿®çŠ¶æ€ï¼ˆç®¡ç†å‘˜ã€å®¿ç®¡ï¼‰
router.put('/:id/status', authMiddleware(['admin', 'staff']), [
  body('status').isIn(['pending', 'processing', 'completed', 'cancelled']).withMessage('çŠ¶æ€ä¸æ­£ç¡®'),
  body('assigned_staff_id').optional().isInt({ min: 1 }).toInt(),
  body('feedback').optional().isString(),
  body('rating').optional().isInt({ min: 1, max: 5 }).toInt()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const repairId = req.params.id;
    const {
      status,
      assigned_staff_id,
      feedback,
      rating
    } = req.body;

    // æ£€æŸ¥æŠ¥ä¿®è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingRepairs] = await pool.execute(
      'SELECT id, building_id, status as old_status FROM repairs WHERE id = ?',
      [repairId]
    );

    if (existingRepairs.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æŠ¥ä¿®è®°å½•ä¸å­˜åœ¨'
      });
    }

    const existingRepair = existingRepairs[0];

    // æ£€æŸ¥æƒé™ï¼šå®¿ç®¡åªèƒ½å¤„ç†è‡ªå·±æ¥¼æ ‹çš„æŠ¥ä¿®
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(existingRepair.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒå¤„ç†è¯¥æŠ¥ä¿®è®°å½•'
        });
      }
    }

    // æ£€æŸ¥ç»´ä¿®äººå‘˜æ˜¯å¦å­˜åœ¨ä¸”æ˜¯å‘˜å·¥
    if (assigned_staff_id) {
      const [staffExists] = await pool.execute(
        'SELECT id FROM users WHERE id = ? AND role IN ("admin", "staff")',
        [assigned_staff_id]
      );

      if (staffExists.length === 0) {
        return res.status(400).json({
          code: 400,
          message: 'æŒ‡å®šçš„ç»´ä¿®äººå‘˜ä¸å­˜åœ¨æˆ–æ— æƒé™'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = ['status = ?'];
    const updateValues = [status];

    if (assigned_staff_id !== undefined) {
      updateFields.push('assigned_staff_id = ?');
      updateValues.push(assigned_staff_id);
    }

    if (feedback !== undefined) {
      updateFields.push('feedback = ?');
      updateValues.push(feedback);
    }

    if (rating !== undefined) {
      updateFields.push('rating = ?');
      updateValues.push(rating);
    }

    // å¦‚æœçŠ¶æ€å˜ä¸ºå®Œæˆï¼Œè®°å½•å®Œæˆæ—¶é—´
    if (status === 'completed' && existingRepair.old_status !== 'completed') {
      updateFields.push('completed_at = NOW()');
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(repairId);
    await pool.execute(
      `UPDATE repairs SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    res.json({
      code: 200,
      message: 'æŠ¥ä¿®çŠ¶æ€æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°æŠ¥ä¿®çŠ¶æ€é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ·»åŠ æŠ¥ä¿®å¤„ç†è¿›åº¦ï¼ˆç®¡ç†å‘˜ã€å®¿ç®¡ã€ç»´ä¿®äººå‘˜ï¼‰
router.post('/:id/progress', authMiddleware(['admin', 'staff']), [
  body('step').notEmpty().withMessage('è¿›åº¦æ­¥éª¤ä¸èƒ½ä¸ºç©º'),
  body('description').notEmpty().withMessage('è¿›åº¦æè¿°ä¸èƒ½ä¸ºç©º')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const repairId = req.params.id;
    const { step, description } = req.body;

    // æ£€æŸ¥æŠ¥ä¿®è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingRepairs] = await pool.execute(
      'SELECT id, building_id FROM repairs WHERE id = ?',
      [repairId]
    );

    if (existingRepairs.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æŠ¥ä¿®è®°å½•ä¸å­˜åœ¨'
      });
    }

    const existingRepair = existingRepairs[0];

    // æ£€æŸ¥æƒé™ï¼šå®¿ç®¡åªèƒ½å¤„ç†è‡ªå·±æ¥¼æ ‹çš„æŠ¥ä¿®
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(existingRepair.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒå¤„ç†è¯¥æŠ¥ä¿®è®°å½•'
        });
      }
    }

    // åˆ›å»ºè¿›åº¦è®°å½•è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    await pool.execute(`
      CREATE TABLE IF NOT EXISTS repair_progress (
        id INT PRIMARY KEY AUTO_INCREMENT,
        repair_id INT NOT NULL,
        step VARCHAR(100) NOT NULL,
        description TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (repair_id) REFERENCES repairs(id) ON DELETE CASCADE,
        INDEX idx_repair (repair_id)
      )
    `);

    // æ·»åŠ è¿›åº¦è®°å½•
    const [result] = await pool.execute(
      `INSERT INTO repair_progress (repair_id, step, description)
       VALUES (?, ?, ?)`,
      [repairId, step, description]
    );

    res.status(201).json({
      code: 200,
      message: 'è¿›åº¦è®°å½•æ·»åŠ æˆåŠŸ',
      data: {
        id: result.insertId
      }
    });

  } catch (error) {
    console.error('æ·»åŠ æŠ¥ä¿®è¿›åº¦é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–æŠ¥ä¿®ç»Ÿè®¡
router.get('/stats/overview', authMiddleware(['admin', 'staff']), [
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { building_id, start_date, end_date } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„ç»Ÿè®¡
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`r.building_id IN (${buildingIds.join(',')})`);
      } else {
        // è¿”å›ç©ºç»Ÿè®¡
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            overview: {
              total: 0,
              pending: 0,
              processing: 0,
              completed: 0,
              cancelled: 0
            },
            by_type: [],
            by_building: [],
            by_month: []
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('r.building_id = ?');
      params.push(building_id);
    }

    if (start_date) {
      whereConditions.push('DATE(r.created_at) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(r.created_at) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è·å–æ€»ä½“ç»Ÿè®¡
    const [overviewStats] = await pool.execute(
      `SELECT 
         COUNT(*) as total,
         SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
         SUM(CASE WHEN status = 'processing' THEN 1 ELSE 0 END) as processing,
         SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
         SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) as cancelled,
         AVG(CASE WHEN status = 'completed' AND completed_at IS NOT NULL 
                  THEN TIMESTAMPDIFF(HOUR, created_at, completed_at) 
                  ELSE NULL END) as avg_completion_hours
       FROM repairs r
       WHERE ${whereClause}`,
      params
    );

    // æŒ‰ç±»å‹ç»Ÿè®¡
    const [typeStats] = await pool.execute(
      `SELECT repair_type, COUNT(*) as count,
              SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
              SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed
       FROM repairs r
       WHERE ${whereClause}
       GROUP BY repair_type
       ORDER BY count DESC`,
      params
    );

    // æŒ‰æ¥¼æ ‹ç»Ÿè®¡
    const [buildingStats] = await pool.execute(
      `SELECT b.id, b.building_name, b.building_code,
              COUNT(r.id) as total_repairs,
              SUM(CASE WHEN r.status = 'pending' THEN 1 ELSE 0 END) as pending,
              SUM(CASE WHEN r.status = 'completed' THEN 1 ELSE 0 END) as completed
       FROM buildings b
       LEFT JOIN repairs r ON b.id = r.building_id AND ${whereClause.replace('r.', '')}
       GROUP BY b.id, b.building_name, b.building_code
       ORDER BY total_repairs DESC`,
      params.filter(p => !building_id || p === building_id)
    );

    // æŒ‰æœˆç»Ÿè®¡ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
    const monthlyParams = [...params];
    const monthlyWhereClause = whereClause;
    
    const [monthlyStats] = await pool.execute(
      `SELECT 
         DATE_FORMAT(created_at, '%Y-%m') as month,
         COUNT(*) as count,
         SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed
       FROM repairs
       WHERE ${monthlyWhereClause}
         AND created_at >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
       GROUP BY DATE_FORMAT(created_at, '%Y-%m')
       ORDER BY month ASC`,
      monthlyParams
    );

    const stats = {
      overview: overviewStats[0] || {
        total: 0,
        pending: 0,
        processing: 0,
        completed: 0,
        cancelled: 0,
        avg_completion_hours: 0
      },
      by_type: typeStats,
      by_building: buildingStats,
      by_month: monthlyStats
    };

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: stats
    });

  } catch (error) {
    console.error('è·å–æŠ¥ä¿®ç»Ÿè®¡é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤æŠ¥ä¿®è®°å½•ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const repairId = req.params.id;

    // æ£€æŸ¥æŠ¥ä¿®è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingRepairs] = await pool.execute(
      'SELECT id FROM repairs WHERE id = ?',
      [repairId]
    );

    if (existingRepairs.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æŠ¥ä¿®è®°å½•ä¸å­˜åœ¨'
      });
    }

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // åˆ é™¤è¿›åº¦è®°å½•
      try {
        await connection.execute(
          'DELETE FROM repair_progress WHERE repair_id = ?',
          [repairId]
        );
      } catch (error) {
        // è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
      }

      // åˆ é™¤æŠ¥ä¿®è®°å½•
      await connection.execute(
        'DELETE FROM repairs WHERE id = ?',
        [repairId]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'æŠ¥ä¿®è®°å½•åˆ é™¤æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('åˆ é™¤æŠ¥ä¿®è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–å­¦ç”Ÿåˆ—è¡¨ï¼ˆç®¡ç†å‘˜å’Œå®¿ç®¡ï¼‰
router.get('/', authMiddleware(['admin', 'staff']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('room_id').optional().isInt({ min: 1 }).toInt(),
  query('status').optional().isIn(['active', 'inactive', 'suspended']),
  query('keyword').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      building_id,
      room_id,
      status,
      keyword
    } = req.query;

    // å¦‚æœæ˜¯å®¿ç®¡ï¼Œåªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†çš„æ¥¼æ ‹çš„å­¦ç”Ÿ
    let buildingCondition = '';
    if (req.user.role === 'staff') {
      // è·å–å®¿ç®¡ç®¡ç†çš„æ¥¼æ ‹
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      if (managedBuildings.length === 0) {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
      
      const buildingIds = managedBuildings.map(b => b.id);
      buildingCondition = `AND u.building_id IN (${buildingIds.join(',')})`;
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['u.role = "student"'];
    const params = [];

    if (building_id) {
      whereConditions.push('u.building_id = ?');
      params.push(building_id);
    }

    if (room_id) {
      whereConditions.push('u.room_id = ?');
      params.push(room_id);
    }

    if (status) {
      whereConditions.push('u.status = ?');
      params.push(status);
    } else {
      whereConditions.push('u.status = "active"');
    }

    if (keyword) {
      whereConditions.push('(u.username LIKE ? OR u.real_name LIKE ? OR u.student_id LIKE ?)');
      params.push(`%${keyword}%`, `%${keyword}%`, `%${keyword}%`);
    }

    if (buildingCondition) {
      whereConditions.push(buildingCondition.replace('AND ', ''));
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM users u 
       WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢å­¦ç”Ÿåˆ—è¡¨
    const [students] = await pool.execute(
      `SELECT u.id, u.username, u.email, u.phone, u.real_name, 
              u.student_id, u.building_id, u.room_id, u.avatar_url, u.status,
              u.created_at, u.updated_at,
              b.building_name, b.building_code,
              r.room_number, r.floor
       FROM users u
       LEFT JOIN buildings b ON u.building_id = b.id
       LEFT JOIN rooms r ON u.room_id = r.id
       WHERE ${whereClause}
       ORDER BY u.id DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: students,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–å­¦ç”Ÿåˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å­¦ç”Ÿè¯¦æƒ…
router.get('/:id', authMiddleware(['admin', 'staff']), async (req, res) => {
  try {
    const studentId = req.params.id;

    // å¦‚æœæ˜¯å®¿ç®¡ï¼Œæ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨è‡ªå·±ç®¡ç†çš„æ¥¼æ ‹
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        const [isAuthorized] = await pool.execute(
          `SELECT u.id 
           FROM users u
           WHERE u.id = ? AND u.role = 'student' AND u.building_id IN (?)`,
          [studentId, buildingIds]
        );
        
        if (isAuthorized.length === 0) {
          return res.status(403).json({
            code: 403,
            message: 'æ— æƒæŸ¥çœ‹è¯¥å­¦ç”Ÿä¿¡æ¯'
          });
        }
      } else {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹å­¦ç”Ÿä¿¡æ¯'
        });
      }
    }

    const [students] = await pool.execute(
      `SELECT u.id, u.username, u.email, u.phone, u.real_name, 
              u.student_id, u.building_id, u.room_id, u.avatar_url, u.status,
              u.created_at, u.updated_at,
              b.building_name, b.building_code,
              r.room_number, r.floor, r.capacity, r.room_type, r.monthly_fee
       FROM users u
       LEFT JOIN buildings b ON u.building_id = b.id
       LEFT JOIN rooms r ON u.room_id = r.id
       WHERE u.id = ? AND u.role = 'student'`,
      [studentId]
    );

    if (students.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å­¦ç”Ÿä¸å­˜åœ¨'
      });
    }

    const student = students[0];

    // è·å–å®¤å‹ä¿¡æ¯
    if (student.room_id) {
      const [roommates] = await pool.execute(
        `SELECT id, real_name, student_id, phone, avatar_url
         FROM users 
         WHERE room_id = ? AND id != ? AND status = 'active'
         ORDER BY id`,
        [student.room_id, studentId]
      );
      student.roommates = roommates;
    }

    // è·å–æŠ¥ä¿®ç»Ÿè®¡
    const [repairStats] = await pool.execute(
      `SELECT 
         COUNT(*) as total,
         SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
         SUM(CASE WHEN status = 'processing' THEN 1 ELSE 0 END) as processing,
         SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed
       FROM repairs 
       WHERE student_id = ?`,
      [studentId]
    );
    student.repair_stats = repairStats[0];

    // è·å–è®¿å®¢ç»Ÿè®¡
    const [visitorStats] = await pool.execute(
      `SELECT 
         COUNT(*) as total,
         SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
         SUM(CASE WHEN status = 'arrived' THEN 1 ELSE 0 END) as arrived,
         SUM(CASE WHEN status = 'left' THEN 1 ELSE 0 END) as left_count
       FROM visitors 
       WHERE student_id = ?`,
      [studentId]
    );
    student.visitor_stats = visitorStats[0];

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: student
    });

  } catch (error) {
    console.error('è·å–å­¦ç”Ÿè¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// å­¦ç”Ÿæ›´æ–°ä¸ªäººä¿¡æ¯
router.put('/profile', authMiddleware(['student']), [
  body('email').optional().isEmail().withMessage('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  body('phone').optional().matches(/^1[3-9]\d{9}$/).withMessage('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®'),
  body('avatar_url').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const { email, phone, avatar_url } = req.body;

    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if (email) {
      const [existingEmail] = await pool.execute(
        'SELECT id FROM users WHERE email = ? AND id != ?',
        [email, studentId]
      );

      if (existingEmail.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'é‚®ç®±å·²å­˜åœ¨'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = [];
    const updateValues = [];

    if (email !== undefined) {
      updateFields.push('email = ?');
      updateValues.push(email);
    }

    if (phone !== undefined) {
      updateFields.push('phone = ?');
      updateValues.push(phone);
    }

    if (avatar_url !== undefined) {
      updateFields.push('avatar_url = ?');
      updateValues.push(avatar_url);
    }

    if (updateFields.length === 0) {
      return res.status(400).json({
        code: 400,
        message: 'æ²¡æœ‰å¯æ›´æ–°çš„å­—æ®µ'
      });
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(studentId);
    await pool.execute(
      `UPDATE users SET ${updateFields.join(', ')} WHERE id = ? AND role = 'student'`,
      updateValues
    );

    res.json({
      code: 200,
      message: 'ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('å­¦ç”Ÿæ›´æ–°ä¸ªäººä¿¡æ¯é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å½“å‰å­¦ç”Ÿçš„æŠ¥ä¿®è®°å½•
router.get('/my/repairs', authMiddleware(['student']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 50 }).toInt(),
  query('status').optional().isIn(['pending', 'processing', 'completed', 'cancelled'])
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const {
      page = 1,
      pageSize = 20,
      status
    } = req.query;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['student_id = ?'];
    const params = [studentId];

    if (status) {
      whereConditions.push('status = ?');
      params.push(status);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total FROM repairs WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢æŠ¥ä¿®è®°å½•
    const [repairs] = await pool.execute(
      `SELECT r.id, r.repair_number, r.repair_type, r.description, 
              r.status, r.priority, r.created_at, r.updated_at,
              b.building_name, rm.room_number,
              s.real_name as student_name, s.student_id
       FROM repairs r
       JOIN buildings b ON r.building_id = b.id
       JOIN rooms rm ON r.room_id = rm.id
       JOIN users s ON r.student_id = s.id
       WHERE ${whereClause}
       ORDER BY r.created_at DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: repairs,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–å­¦ç”ŸæŠ¥ä¿®è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–å½“å‰å­¦ç”Ÿçš„è®¿å®¢è®°å½•
router.get('/my/visitors', authMiddleware(['student']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 50 }).toInt(),
  query('status').optional().isIn(['pending', 'arrived', 'left', 'cancelled'])
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const {
      page = 1,
      pageSize = 20,
      status
    } = req.query;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['student_id = ?'];
    const params = [studentId];

    if (status) {
      whereConditions.push('status = ?');
      params.push(status);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total FROM visitors WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢è®¿å®¢è®°å½•
    const [visitors] = await pool.execute(
      `SELECT v.id, v.visitor_name, v.visitor_phone, v.visitor_id_card,
              v.relationship, v.visit_reason, v.status,
              v.expected_arrival, v.expected_leave,
              v.actual_arrival, v.actual_leave,
              v.created_at, v.updated_at,
              b.building_name, rm.room_number
       FROM visitors v
       JOIN buildings b ON v.building_id = b.id
       JOIN rooms rm ON v.room_id = rm.id
       WHERE ${whereClause}
       ORDER BY v.expected_arrival DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: visitors,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–å­¦ç”Ÿè®¿å®¢è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// å­¦ç”Ÿç”³è¯·æ¢å®¿èˆ
router.post('/apply-room-change', authMiddleware(['student']), [
  body('target_building_id').isInt({ min: 1 }).withMessage('ç›®æ ‡æ¥¼æ ‹IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('target_room_id').isInt({ min: 1 }).withMessage('ç›®æ ‡æˆ¿é—´IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('reason').notEmpty().withMessage('æ¢å®¿èˆåŸå› ä¸èƒ½ä¸ºç©º')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const { target_building_id, target_room_id, reason } = req.body;

    // è·å–å­¦ç”Ÿå½“å‰å®¿èˆä¿¡æ¯
    const [students] = await pool.execute(
      'SELECT building_id, room_id FROM users WHERE id = ?',
      [studentId]
    );

    if (students.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å­¦ç”Ÿä¸å­˜åœ¨'
      });
    }

    const student = students[0];
    const currentBuildingId = student.building_id;
    const currentRoomId = student.room_id;

    // æ£€æŸ¥æ˜¯å¦å·²ç»ç”³è¯·è¿‡æ¢å®¿èˆï¼ˆæœªå¤„ç†çš„ï¼‰
    const [existingApplication] = await pool.execute(
      `SELECT id FROM room_change_applications 
       WHERE student_id = ? AND status = 'pending'`,
      [studentId]
    );

    if (existingApplication.length > 0) {
      return res.status(400).json({
        code: 400,
        message: 'å·²æœ‰ä¸€ä¸ªå¾…å¤„ç†çš„æ¢å®¿èˆç”³è¯·'
      });
    }

    // æ£€æŸ¥ç›®æ ‡æˆ¿é—´æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
    const [targetRoom] = await pool.execute(
      `SELECT id, capacity, current_occupancy, status 
       FROM rooms WHERE id = ? AND building_id = ?`,
      [target_room_id, target_building_id]
    );

    if (targetRoom.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç›®æ ‡æˆ¿é—´ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥æ¥¼æ ‹'
      });
    }

    const room = targetRoom[0];

    if (room.status !== 'available') {
      return res.status(400).json({
        code: 400,
        message: `ç›®æ ‡æˆ¿é—´å½“å‰çŠ¶æ€ä¸º${room.status}ï¼Œä¸å¯ç”³è¯·`
      });
    }

    if (room.current_occupancy >= room.capacity) {
      return res.status(400).json({
        code: 400,
        message: 'ç›®æ ‡æˆ¿é—´å·²æ»¡'
      });
    }

    // åˆ›å»ºæ¢å®¿èˆç”³è¯·è¡¨ï¼ˆéœ€è¦å…ˆåœ¨MySQLä¸­åˆ›å»ºè¿™ä¸ªè¡¨ï¼‰
    // å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±è·³è¿‡ï¼ˆä½œä¸ºç¤ºä¾‹ï¼‰
    try {
      // åˆ›å»ºæ¢å®¿èˆç”³è¯·è¡¨
      await pool.execute(`
        CREATE TABLE IF NOT EXISTS room_change_applications (
          id INT PRIMARY KEY AUTO_INCREMENT,
          application_number VARCHAR(50) UNIQUE NOT NULL,
          student_id INT NOT NULL,
          current_building_id INT NOT NULL,
          current_room_id INT NOT NULL,
          target_building_id INT NOT NULL,
          target_room_id INT NOT NULL,
          reason TEXT NOT NULL,
          status ENUM('pending', 'approved', 'rejected', 'cancelled') DEFAULT 'pending',
          handled_by INT,
          handled_at TIMESTAMP NULL,
          reply_reason TEXT,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          INDEX idx_student (student_id),
          INDEX idx_status (status),
          FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
          FOREIGN KEY (current_building_id) REFERENCES buildings(id) ON DELETE CASCADE,
          FOREIGN KEY (current_room_id) REFERENCES rooms(id) ON DELETE CASCADE,
          FOREIGN KEY (target_building_id) REFERENCES buildings(id) ON DELETE CASCADE,
          FOREIGN KEY (target_room_id) REFERENCES rooms(id) ON DELETE CASCADE
        )
      `);

      // ç”Ÿæˆç”³è¯·ç¼–å·
      const applicationNumber = `RC${Date.now()}${Math.floor(Math.random() * 1000)}`;

      // æ’å…¥ç”³è¯·è®°å½•
      const [result] = await pool.execute(
        `INSERT INTO room_change_applications 
         (application_number, student_id, current_building_id, current_room_id,
          target_building_id, target_room_id, reason)
         VALUES (?, ?, ?, ?, ?, ?, ?)`,
        [
          applicationNumber,
          studentId,
          currentBuildingId,
          currentRoomId,
          target_building_id,
          target_room_id,
          reason
        ]
      );

      res.status(201).json({
        code: 200,
        message: 'æ¢å®¿èˆç”³è¯·æäº¤æˆåŠŸ',
        data: {
          application_id: result.insertId,
          application_number: applicationNumber
        }
      });

    } catch (error) {
      console.error('æäº¤æ¢å®¿èˆç”³è¯·é”™è¯¯:', error);
      res.status(500).json({
        code: 500,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
      });
    }

  } catch (error) {
    console.error('æäº¤æ¢å®¿èˆç”³è¯·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// å­¦ç”Ÿè·å–è‡ªå·±çš„æ¢å®¿èˆç”³è¯·è®°å½•
router.get('/my/room-change-applications', authMiddleware(['student']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 50 }).toInt(),
  query('status').optional().isIn(['pending', 'approved', 'rejected', 'cancelled'])
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const {
      page = 1,
      pageSize = 20,
      status
    } = req.query;

    // å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    try {
      // æ„å»ºæŸ¥è¯¢æ¡ä»¶
      let whereConditions = ['student_id = ?'];
      const params = [studentId];

      if (status) {
        whereConditions.push('status = ?');
        params.push(status);
      }

      const whereClause = whereConditions.join(' AND ');

      // è®¡ç®—æ€»æ•°
      const [countResult] = await pool.execute(
        `SELECT COUNT(*) as total FROM room_change_applications WHERE ${whereClause}`,
        params
      );
      const total = countResult[0]?.total || 0;

      // è®¡ç®—åˆ†é¡µ
      const offset = (page - 1) * pageSize;
      const queryParams = [...params, pageSize, offset];

      // æŸ¥è¯¢æ¢å®¿èˆç”³è¯·è®°å½•
      const [applications] = await pool.execute(
        `SELECT rca.id, rca.application_number, rca.reason, rca.status,
                rca.created_at, rca.updated_at,
                rca.handled_at, rca.reply_reason,
                cb.building_name as current_building_name,
                cr.room_number as current_room_number,
                tb.building_name as target_building_name,
                tr.room_number as target_room_number
         FROM room_change_applications rca
         JOIN buildings cb ON rca.current_building_id = cb.id
         JOIN rooms cr ON rca.current_room_id = cr.id
         JOIN buildings tb ON rca.target_building_id = tb.id
         JOIN rooms tr ON rca.target_room_id = tr.id
         WHERE ${whereClause}
         ORDER BY rca.created_at DESC
         LIMIT ? OFFSET ?`,
        queryParams
      );

      res.json({
        code: 200,
        message: 'è·å–æˆåŠŸ',
        data: {
          list: applications || [],
          pagination: {
            page,
            pageSize,
            total,
            totalPages: Math.ceil(total / pageSize)
          }
        }
      });

    } catch (error) {
      // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºåˆ—è¡¨
      if (error.code === 'ER_NO_SUCH_TABLE') {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
      throw error;
    }

  } catch (error) {
    console.error('è·å–æ¢å®¿èˆç”³è¯·è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// å­¦ç”Ÿå–æ¶ˆæ¢å®¿èˆç”³è¯·
router.put('/room-change-applications/:id/cancel', authMiddleware(['student']), async (req, res) => {
  try {
    const applicationId = req.params.id;
    const studentId = req.user.id;

    // æ£€æŸ¥ç”³è¯·æ˜¯å¦å­˜åœ¨ä¸”å±äºè¯¥å­¦ç”Ÿ
    const [applications] = await pool.execute(
      `SELECT id, status FROM room_change_applications 
       WHERE id = ? AND student_id = ?`,
      [applicationId, studentId]
    );

    if (applications.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”³è¯·ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ'
      });
    }

    const application = applications[0];

    if (application.status !== 'pending') {
      return res.status(400).json({
        code: 400,
        message: 'åªèƒ½å–æ¶ˆå¾…å¤„ç†çš„ç”³è¯·'
      });
    }

    // æ›´æ–°ç”³è¯·çŠ¶æ€
    await pool.execute(
      `UPDATE room_change_applications 
       SET status = 'cancelled', updated_at = NOW()
       WHERE id = ?`,
      [applicationId]
    );

    res.json({
      code: 200,
      message: 'ç”³è¯·å–æ¶ˆæˆåŠŸ'
    });

  } catch (error) {
    console.error('å–æ¶ˆæ¢å®¿èˆç”³è¯·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const bcrypt = require('bcryptjs');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.get('/', authMiddleware(['admin']), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('role').optional().isIn(['admin', 'student', 'staff']),
  query('status').optional().isIn(['active', 'inactive', 'suspended']),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('room_id').optional().isInt({ min: 1 }).toInt()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      role,
      status,
      building_id,
      room_id,
      keyword
    } = req.query;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    if (role) {
      whereConditions.push('role = ?');
      params.push(role);
    }

    if (status) {
      whereConditions.push('status = ?');
      params.push(status);
    }

    if (building_id) {
      whereConditions.push('building_id = ?');
      params.push(building_id);
    }

    if (room_id) {
      whereConditions.push('room_id = ?');
      params.push(room_id);
    }

    if (keyword) {
      whereConditions.push('(username LIKE ? OR real_name LIKE ? OR student_id LIKE ?)');
      params.push(`%${keyword}%`, `%${keyword}%`, `%${keyword}%`);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total FROM users WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    params.push(pageSize, offset);

    // æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
    const [users] = await pool.execute(
      `SELECT id, username, email, phone, role, real_name, 
              student_id, building_id, room_id, avatar_url, status,
              created_at, updated_at
       FROM users WHERE ${whereClause}
       ORDER BY id DESC
       LIMIT ? OFFSET ?`,
      params
    );

    // è·å–å®¿èˆä¿¡æ¯
    const userIds = users.map(user => user.id);
    if (userIds.length > 0) {
      const [buildingInfos] = await pool.execute(
        `SELECT u.id, b.building_name, b.building_code, 
                r.room_number, r.floor
         FROM users u
         LEFT JOIN buildings b ON u.building_id = b.id
         LEFT JOIN rooms r ON u.room_id = r.id
         WHERE u.id IN (${userIds.join(',')})`
      );

      // å°†å®¿èˆä¿¡æ¯åˆå¹¶åˆ°ç”¨æˆ·æ•°æ®ä¸­
      const buildingMap = new Map();
      buildingInfos.forEach(info => {
        buildingMap.set(info.id, {
          building_name: info.building_name,
          building_code: info.building_code,
          room_number: info.room_number,
          floor: info.floor
        });
      });

      users.forEach(user => {
        user.building_info = buildingMap.get(user.id) || null;
      });
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: users,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–ç”¨æˆ·è¯¦æƒ…
router.get('/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const userId = req.params.id;

    const [users] = await pool.execute(
      `SELECT id, username, email, phone, role, real_name, 
              student_id, building_id, room_id, avatar_url, status,
              created_at, updated_at
       FROM users WHERE id = ?`,
      [userId]
    );

    if (users.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    const user = users[0];

    // è·å–å®¿èˆä¿¡æ¯
    if (user.building_id && user.room_id) {
      const [buildingInfo] = await pool.execute(
        `SELECT b.building_name, b.building_code, 
                r.room_number, r.floor, r.capacity, r.current_occupancy,
                r.room_type, r.monthly_fee
         FROM buildings b
         JOIN rooms r ON b.id = r.building_id
         WHERE b.id = ? AND r.id = ?`,
        [user.building_id, user.room_id]
      );

      if (buildingInfo.length > 0) {
        user.building_info = buildingInfo[0];
      }
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: user
    });

  } catch (error) {
    console.error('è·å–ç”¨æˆ·è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ›å»ºç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.post('/', authMiddleware(['admin']), [
  body('username').isLength({ min: 3, max: 50 }).withMessage('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50å­—ç¬¦ä¹‹é—´'),
  body('password').isLength({ min: 6 }).withMessage('å¯†ç é•¿åº¦è‡³å°‘6ä½'),
  body('email').optional().isEmail().withMessage('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  body('role').isIn(['admin', 'student', 'staff']).withMessage('è§’è‰²ä¸æ­£ç¡®'),
  body('real_name').optional().isLength({ min: 2 }).withMessage('çœŸå®å§“åè‡³å°‘2ä¸ªå­—ç¬¦'),
  body('student_id').optional().isLength({ min: 5 }).withMessage('å­¦å·æ ¼å¼ä¸æ­£ç¡®'),
  body('building_id').optional().isInt({ min: 1 }).toInt(),
  body('room_id').optional().isInt({ min: 1 }).toInt(),
  body('status').optional().isIn(['active', 'inactive', 'suspended'])
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      username,
      password,
      email,
      role,
      real_name,
      student_id,
      phone,
      building_id,
      room_id,
      status = 'active'
    } = req.body;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const [existingUser] = await pool.execute(
      'SELECT id FROM users WHERE username = ?',
      [username]
    );

    if (existingUser.length > 0) {
      return res.status(400).json({
        code: 400,
        message: 'ç”¨æˆ·åå·²å­˜åœ¨'
      });
    }

    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if (email) {
      const [existingEmail] = await pool.execute(
        'SELECT id FROM users WHERE email = ?',
        [email]
      );

      if (existingEmail.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'é‚®ç®±å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨
    if (student_id) {
      const [existingStudentId] = await pool.execute(
        'SELECT id FROM users WHERE student_id = ?',
        [student_id]
      );

      if (existingStudentId.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'å­¦å·å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥å®¿èˆå’Œæˆ¿é—´æ˜¯å¦åŒ¹é…
    if (building_id && room_id) {
      const [roomExists] = await pool.execute(
        'SELECT id FROM rooms WHERE id = ? AND building_id = ?',
        [room_id, building_id]
      );

      if (roomExists.length === 0) {
        return res.status(400).json({
          code: 400,
          message: 'æˆ¿é—´ä¸å­˜åœ¨æˆ–ä¸å±äºæŒ‡å®šæ¥¼æ ‹'
        });
      }
    }

    // åŠ å¯†å¯†ç 
    const hashedPassword = await bcrypt.hash(password, 10);

    // åˆ›å»ºç”¨æˆ·
    const [result] = await pool.execute(
      `INSERT INTO users (username, password, email, role, real_name, 
                         student_id, phone, building_id, room_id, status)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [username, hashedPassword, email, role, real_name, 
       student_id, phone, building_id, room_id, status]
    );

    // å¦‚æœåˆ†é…äº†æˆ¿é—´ï¼Œæ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
    if (room_id) {
      await pool.execute(
        'UPDATE rooms SET current_occupancy = current_occupancy + 1 WHERE id = ?',
        [room_id]
      );
    }

    res.status(201).json({
      code: 200,
      message: 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ',
      data: {
        id: result.insertId
      }
    });

  } catch (error) {
    console.error('åˆ›å»ºç”¨æˆ·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
router.put('/:id', authMiddleware(['admin']), [
  body('email').optional().isEmail().withMessage('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  body('role').optional().isIn(['admin', 'student', 'staff']).withMessage('è§’è‰²ä¸æ­£ç¡®'),
  body('real_name').optional().isLength({ min: 2 }).withMessage('çœŸå®å§“åè‡³å°‘2ä¸ªå­—ç¬¦'),
  body('student_id').optional().isLength({ min: 5 }).withMessage('å­¦å·æ ¼å¼ä¸æ­£ç¡®'),
  body('building_id').optional().isInt({ min: 1 }).toInt(),
  body('room_id').optional().isInt({ min: 1 }).toInt(),
  body('status').optional().isIn(['active', 'inactive', 'suspended'])
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const userId = req.params.id;
    const {
      email,
      role,
      real_name,
      student_id,
      phone,
      building_id,
      room_id,
      status,
      avatar_url
    } = req.body;

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const [existingUsers] = await pool.execute(
      'SELECT id, building_id as old_building_id, room_id as old_room_id FROM users WHERE id = ?',
      [userId]
    );

    if (existingUsers.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    const existingUser = existingUsers[0];
    const oldBuildingId = existingUser.old_building_id;
    const oldRoomId = existingUser.old_room_id;

    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if (email) {
      const [existingEmail] = await pool.execute(
        'SELECT id FROM users WHERE email = ? AND id != ?',
        [email, userId]
      );

      if (existingEmail.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'é‚®ç®±å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨
    if (student_id) {
      const [existingStudentId] = await pool.execute(
        'SELECT id FROM users WHERE student_id = ? AND id != ?',
        [student_id, userId]
      );

      if (existingStudentId.length > 0) {
        return res.status(400).json({
          code: 400,
          message: 'å­¦å·å·²å­˜åœ¨'
        });
      }
    }

    // æ£€æŸ¥å®¿èˆå’Œæˆ¿é—´æ˜¯å¦åŒ¹é…
    if (building_id && room_id) {
      const [roomExists] = await pool.execute(
        'SELECT id FROM rooms WHERE id = ? AND building_id = ?',
        [room_id, building_id]
      );

      if (roomExists.length === 0) {
        return res.status(400).json({
          code: 400,
          message: 'æˆ¿é—´ä¸å­˜åœ¨æˆ–ä¸å±äºæŒ‡å®šæ¥¼æ ‹'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = [];
    const updateValues = [];

    if (email !== undefined) {
      updateFields.push('email = ?');
      updateValues.push(email);
    }

    if (role !== undefined) {
      updateFields.push('role = ?');
      updateValues.push(role);
    }

    if (real_name !== undefined) {
      updateFields.push('real_name = ?');
      updateValues.push(real_name);
    }

    if (student_id !== undefined) {
      updateFields.push('student_id = ?');
      updateValues.push(student_id);
    }

    if (phone !== undefined) {
      updateFields.push('phone = ?');
      updateValues.push(phone);
    }

    if (building_id !== undefined) {
      updateFields.push('building_id = ?');
      updateValues.push(building_id);
    }

    if (room_id !== undefined) {
      updateFields.push('room_id = ?');
      updateValues.push(room_id);
    }

    if (status !== undefined) {
      updateFields.push('status = ?');
      updateValues.push(status);
    }

    if (avatar_url !== undefined) {
      updateFields.push('avatar_url = ?');
      updateValues.push(avatar_url);
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(userId);
    await pool.execute(
      `UPDATE users SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    // å¤„ç†æˆ¿é—´å ç”¨å˜åŒ–
    if (room_id !== undefined || building_id !== undefined) {
      // å¦‚æœæ›´æ¢äº†æˆ¿é—´ï¼Œæ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
      if (oldRoomId && oldRoomId !== room_id) {
        await pool.execute(
          'UPDATE rooms SET current_occupancy = current_occupancy - 1 WHERE id = ?',
          [oldRoomId]
        );
      }

      if (room_id && (oldRoomId !== room_id || !oldRoomId)) {
        await pool.execute(
          'UPDATE rooms SET current_occupancy = current_occupancy + 1 WHERE id = ?',
          [room_id]
        );
      }
    }

    res.json({
      code: 200,
      message: 'ç”¨æˆ·æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°ç”¨æˆ·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const userId = req.params.id;

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const [existingUsers] = await pool.execute(
      'SELECT id, room_id FROM users WHERE id = ?',
      [userId]
    );

    if (existingUsers.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    const existingUser = existingUsers[0];

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // å¦‚æœç”¨æˆ·æœ‰æˆ¿é—´ï¼Œæ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
      if (existingUser.room_id) {
        await connection.execute(
          'UPDATE rooms SET current_occupancy = current_occupancy - 1 WHERE id = ?',
          [existingUser.room_id]
        );
      }

      // åˆ é™¤ç”¨æˆ·
      await connection.execute(
        'DELETE FROM users WHERE id = ?',
        [userId]
      );

      await connection.commit();

      res.json({
        code: 200,
        message: 'ç”¨æˆ·åˆ é™¤æˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('åˆ é™¤ç”¨æˆ·é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// é‡ç½®ç”¨æˆ·å¯†ç ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.put('/:id/reset-password', authMiddleware(['admin']), [
  body('newPassword').isLength({ min: 6 }).withMessage('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const userId = req.params.id;
    const { newPassword } = req.body;

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const [existingUsers] = await pool.execute(
      'SELECT id FROM users WHERE id = ?',
      [userId]
    );

    if (existingUsers.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    // åŠ å¯†æ–°å¯†ç 
    const hashedPassword = await bcrypt.hash(newPassword, 10);

    // æ›´æ–°å¯†ç 
    await pool.execute(
      'UPDATE users SET password = ?, updated_at = NOW() WHERE id = ?',
      [hashedPassword, userId]
    );

    res.json({
      code: 200,
      message: 'å¯†ç é‡ç½®æˆåŠŸ'
    });

  } catch (error) {
    console.error('é‡ç½®å¯†ç é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ‰¹é‡åˆ†é…å®¿èˆ
router.post('/batch-assign-dorm', authMiddleware(['admin']), [
  body('user_ids').isArray().withMessage('ç”¨æˆ·IDåˆ—è¡¨å¿…é¡»æ˜¯æ•°ç»„'),
  body('user_ids.*').isInt({ min: 1 }).withMessage('ç”¨æˆ·IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('building_id').isInt({ min: 1 }).withMessage('æ¥¼æ ‹IDå¿…é¡»ä¸ºæ­£æ•´æ•°'),
  body('room_ids').isObject().withMessage('æˆ¿é—´åˆ†é…å¿…é¡»æ˜¯å¯¹è±¡')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { user_ids, building_id, room_ids } = req.body;

    // æ£€æŸ¥æ¥¼æ ‹æ˜¯å¦å­˜åœ¨
    const [buildingExists] = await pool.execute(
      'SELECT id FROM buildings WHERE id = ?',
      [building_id]
    );

    if (buildingExists.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'æ¥¼æ ‹ä¸å­˜åœ¨'
      });
    }

    // æ£€æŸ¥æ‰€æœ‰æˆ¿é—´æ˜¯å¦å±äºè¯¥æ¥¼æ ‹ä¸”æœ‰è¶³å¤Ÿå®¹é‡
    const roomAssignments = [];
    const userIdRoomMap = new Map();

    for (const [userId, roomId] of Object.entries(room_ids)) {
      const [roomInfo] = await pool.execute(
        `SELECT id, capacity, current_occupancy 
         FROM rooms WHERE id = ? AND building_id = ?`,
        [roomId, building_id]
      );

      if (roomInfo.length === 0) {
        return res.status(400).json({
          code: 400,
          message: `æˆ¿é—´ ${roomId} ä¸å­˜åœ¨æˆ–ä¸å±äºæ¥¼æ ‹ ${building_id}`
        });
      }

      if (roomInfo[0].current_occupancy >= roomInfo[0].capacity) {
        return res.status(400).json({
          code: 400,
          message: `æˆ¿é—´ ${roomId} å·²æ»¡`
        });
      }

      roomAssignments.push({ userId: parseInt(userId), roomId });
      userIdRoomMap.set(parseInt(userId), roomId);
    }

    // å¼€å§‹äº‹åŠ¡
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // å¤„ç†æ¯ä¸ªç”¨æˆ·çš„å®¿èˆåˆ†é…
      for (const userId of user_ids) {
        const roomId = userIdRoomMap.get(userId);
        
        if (!roomId) {
          throw new Error(`ç”¨æˆ· ${userId} æœªåˆ†é…æˆ¿é—´`);
        }

        // è·å–ç”¨æˆ·åŸæ¥çš„æˆ¿é—´
        const [userInfo] = await connection.execute(
          'SELECT room_id FROM users WHERE id = ?',
          [userId]
        );

        const oldRoomId = userInfo[0]?.room_id;

        // æ›´æ–°ç”¨æˆ·å®¿èˆä¿¡æ¯
        await connection.execute(
          'UPDATE users SET building_id = ?, room_id = ?, updated_at = NOW() WHERE id = ?',
          [building_id, roomId, userId]
        );

        // æ›´æ–°æˆ¿é—´å ç”¨æƒ…å†µ
        if (oldRoomId) {
          await connection.execute(
            'UPDATE rooms SET current_occupancy = current_occupancy - 1 WHERE id = ?',
            [oldRoomId]
          );
        }

        await connection.execute(
          'UPDATE rooms SET current_occupancy = current_occupancy + 1 WHERE id = ?',
          [roomId]
        );
      }

      await connection.commit();

      res.json({
        code: 200,
        message: 'æ‰¹é‡åˆ†é…å®¿èˆæˆåŠŸ'
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }

  } catch (error) {
    console.error('æ‰¹é‡åˆ†é…å®¿èˆé”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: error.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const express = require('express');
const { body, validationResult, query } = require('express-validator');
const pool = require('../config/database');
const { authMiddleware } = require('../middleware/auth');

const router = express.Router();

// è·å–è®¿å®¢è®°å½•åˆ—è¡¨
router.get('/', authMiddleware(), [
  query('page').optional().isInt({ min: 1 }).toInt(),
  query('pageSize').optional().isInt({ min: 1, max: 100 }).toInt(),
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('room_id').optional().isInt({ min: 1 }).toInt(),
  query('student_id').optional().isInt({ min: 1 }).toInt(),
  query('status').optional().isIn(['pending', 'arrived', 'left', 'cancelled']),
  query('relationship').optional().isIn(['family', 'friend', 'relative', 'other']),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const {
      page = 1,
      pageSize = 20,
      building_id,
      room_id,
      student_id,
      status,
      relationship,
      start_date,
      end_date
    } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å­¦ç”Ÿåªèƒ½çœ‹åˆ°è‡ªå·±çš„è®¿å®¢è®°å½•
    if (req.user.role === 'student') {
      whereConditions.push('v.student_id = ?');
      params.push(req.user.id);
    }
    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„è®¿å®¢è®°å½•
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`v.building_id IN (${buildingIds.join(',')})`);
      } else {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            list: [],
            pagination: {
              page: 1,
              pageSize,
              total: 0,
              totalPages: 0
            }
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('v.building_id = ?');
      params.push(building_id);
    }

    if (room_id) {
      whereConditions.push('v.room_id = ?');
      params.push(room_id);
    }

    if (student_id) {
      whereConditions.push('v.student_id = ?');
      params.push(student_id);
    }

    if (status) {
      whereConditions.push('v.status = ?');
      params.push(status);
    }

    if (relationship) {
      whereConditions.push('v.relationship = ?');
      params.push(relationship);
    }

    if (start_date) {
      whereConditions.push('DATE(v.expected_arrival) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(v.expected_arrival) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è®¡ç®—æ€»æ•°
    const [countResult] = await pool.execute(
      `SELECT COUNT(*) as total 
       FROM visitors v
       WHERE ${whereClause}`,
      params
    );
    const total = countResult[0].total;

    // è®¡ç®—åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    const queryParams = [...params, pageSize, offset];

    // æŸ¥è¯¢è®¿å®¢è®°å½•åˆ—è¡¨
    const [visitors] = await pool.execute(
      `SELECT v.id, v.visitor_name, v.visitor_phone, v.visitor_id_card,
              v.relationship, v.visit_reason, v.status,
              v.expected_arrival, v.expected_leave,
              v.actual_arrival, v.actual_leave,
              v.created_at, v.updated_at,
              b.building_name, b.building_code,
              r.room_number,
              s.real_name as student_name, s.student_id
       FROM visitors v
       JOIN buildings b ON v.building_id = b.id
       JOIN rooms r ON v.room_id = r.id
       JOIN users s ON v.student_id = s.id
       WHERE ${whereClause}
       ORDER BY v.expected_arrival DESC
       LIMIT ? OFFSET ?`,
      queryParams
    );

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: {
        list: visitors,
        pagination: {
          page,
          pageSize,
          total,
          totalPages: Math.ceil(total / pageSize)
        }
      }
    });

  } catch (error) {
    console.error('è·å–è®¿å®¢è®°å½•åˆ—è¡¨é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–è®¿å®¢è®°å½•è¯¦æƒ…
router.get('/:id', authMiddleware(), async (req, res) => {
  try {
    const visitorId = req.params.id;

    // è·å–è®¿å®¢è®°å½•
    const [visitors] = await pool.execute(
      `SELECT v.*, s.id as student_user_id
       FROM visitors v
       JOIN users s ON v.student_id = s.id
       WHERE v.id = ?`,
      [visitorId]
    );

    if (visitors.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'è®¿å®¢è®°å½•ä¸å­˜åœ¨'
      });
    }

    const visitor = visitors[0];

    // æƒé™æ£€æŸ¥
    // å­¦ç”Ÿåªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¿å®¢è®°å½•
    if (req.user.role === 'student' && visitor.student_user_id !== req.user.id) {
      return res.status(403).json({
        code: 403,
        message: 'æ— æƒæŸ¥çœ‹è¯¥è®¿å®¢è®°å½•'
      });
    }
    // å®¿ç®¡åªèƒ½æŸ¥çœ‹è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„è®¿å®¢è®°å½•
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(visitor.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹è¯¥è®¿å®¢è®°å½•'
        });
      }
    }

    // è·å–å®Œæ•´ä¿¡æ¯
    const [visitorDetails] = await pool.execute(
      `SELECT v.id, v.visitor_name, v.visitor_phone, v.visitor_id_card,
              v.relationship, v.visit_reason, v.status,
              v.expected_arrival, v.expected_leave,
              v.actual_arrival, v.actual_leave, v.notes,
              v.created_at, v.updated_at,
              b.building_name, b.building_code,
              r.room_number, r.floor,
              s.real_name as student_name, s.student_id, s.phone as student_phone
       FROM visitors v
       JOIN buildings b ON v.building_id = b.id
       JOIN rooms r ON v.room_id = r.id
       JOIN users s ON v.student_id = s.id
       WHERE v.id = ?`,
      [visitorId]
    );

    if (visitorDetails.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'è®¿å®¢è®°å½•ä¸å­˜åœ¨'
      });
    }

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: visitorDetails[0]
    });

  } catch (error) {
    console.error('è·å–è®¿å®¢è®°å½•è¯¦æƒ…é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// ç™»è®°è®¿å®¢ï¼ˆå­¦ç”Ÿï¼‰
router.post('/', authMiddleware(['student']), [
  body('visitor_name').notEmpty().withMessage('è®¿å®¢å§“åä¸èƒ½ä¸ºç©º'),
  body('visitor_phone').notEmpty().withMessage('è®¿å®¢ç”µè¯ä¸èƒ½ä¸ºç©º'),
  body('visitor_id_card').optional().isString(),
  body('relationship').isIn(['family', 'friend', 'relative', 'other']).withMessage('å…³ç³»ç±»å‹ä¸æ­£ç¡®'),
  body('visit_reason').notEmpty().withMessage('è®¿é—®åŸå› ä¸èƒ½ä¸ºç©º'),
  body('expected_arrival').isISO8601().withMessage('é¢„è®¡åˆ°è¾¾æ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('expected_leave').optional().isISO8601().withMessage('é¢„è®¡ç¦»å¼€æ—¶é—´æ ¼å¼ä¸æ­£ç¡®'),
  body('notes').optional().isString()
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const studentId = req.user.id;
    const {
      visitor_name,
      visitor_phone,
      visitor_id_card,
      relationship,
      visit_reason,
      expected_arrival,
      expected_leave,
      notes = ''
    } = req.body;

    // è·å–å­¦ç”Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬å®¿èˆä¿¡æ¯
    const [students] = await pool.execute(
      'SELECT building_id, room_id FROM users WHERE id = ? AND role = "student"',
      [studentId]
    );

    if (students.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'å­¦ç”Ÿä¸å­˜åœ¨'
      });
    }

    const student = students[0];

    if (!student.building_id || !student.room_id) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·å…ˆåˆ†é…å®¿èˆ'
      });
    }

    // åˆ›å»ºè®¿å®¢è®°å½•
    const [result] = await pool.execute(
      `INSERT INTO visitors 
       (student_id, visitor_name, visitor_phone, visitor_id_card,
        relationship, visit_reason, building_id, room_id,
        expected_arrival, expected_leave, notes)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        studentId,
        visitor_name,
        visitor_phone,
        visitor_id_card,
        relationship,
        visit_reason,
        student.building_id,
        student.room_id,
        expected_arrival,
        expected_leave,
        notes
      ]
    );

    res.status(201).json({
      code: 200,
      message: 'è®¿å®¢ç™»è®°æˆåŠŸ',
      data: {
        id: result.insertId
      }
    });

  } catch (error) {
    console.error('ç™»è®°è®¿å®¢é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// æ›´æ–°è®¿å®¢çŠ¶æ€ï¼ˆç®¡ç†å‘˜ã€å®¿ç®¡ã€å­¦ç”Ÿï¼‰
router.put('/:id/status', authMiddleware(), [
  body('status').isIn(['pending', 'arrived', 'left', 'cancelled']).withMessage('çŠ¶æ€ä¸æ­£ç¡®')
], async (req, res) => {
  try {
    // éªŒè¯è¯·æ±‚æ•°æ®
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const visitorId = req.params.id;
    const { status } = req.body;

    // æ£€æŸ¥è®¿å®¢è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingVisitors] = await pool.execute(
      'SELECT id, student_id, building_id, status as old_status FROM visitors WHERE id = ?',
      [visitorId]
    );

    if (existingVisitors.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'è®¿å®¢è®°å½•ä¸å­˜åœ¨'
      });
    }

    const existingVisitor = existingVisitors[0];

    // æƒé™æ£€æŸ¥
    // å­¦ç”Ÿåªèƒ½æ›´æ–°è‡ªå·±çš„è®¿å®¢è®°å½•ï¼Œä¸”åªèƒ½å–æ¶ˆ
    if (req.user.role === 'student') {
      if (existingVisitor.student_id !== req.user.id) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæ›´æ–°è¯¥è®¿å®¢è®°å½•'
        });
      }
      if (status !== 'cancelled') {
        return res.status(403).json({
          code: 403,
          message: 'å­¦ç”Ÿåªèƒ½å–æ¶ˆè®¿å®¢è®°å½•'
        });
      }
    }
    // å®¿ç®¡åªèƒ½æ›´æ–°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„è®¿å®¢è®°å½•
    else if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      const buildingIds = managedBuildings.map(b => b.id);
      if (!buildingIds.includes(existingVisitor.building_id)) {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæ›´æ–°è¯¥è®¿å®¢è®°å½•'
        });
      }
    }

    // æ„å»ºæ›´æ–°å­—æ®µ
    const updateFields = ['status = ?'];
    const updateValues = [status];

    // å¦‚æœçŠ¶æ€å˜ä¸ºå·²åˆ°è¾¾ï¼Œè®°å½•å®é™…åˆ°è¾¾æ—¶é—´
    if (status === 'arrived' && existingVisitor.old_status !== 'arrived') {
      updateFields.push('actual_arrival = NOW()');
    }

    // å¦‚æœçŠ¶æ€å˜ä¸ºå·²ç¦»å¼€ï¼Œè®°å½•å®é™…ç¦»å¼€æ—¶é—´
    if (status === 'left' && existingVisitor.old_status !== 'left') {
      updateFields.push('actual_leave = NOW()');
    }

    // æ·»åŠ æ›´æ–°æ—¶é—´
    updateFields.push('updated_at = NOW()');

    // æ‰§è¡Œæ›´æ–°
    updateValues.push(visitorId);
    await pool.execute(
      `UPDATE visitors SET ${updateFields.join(', ')} WHERE id = ?`,
      updateValues
    );

    res.json({
      code: 200,
      message: 'è®¿å®¢çŠ¶æ€æ›´æ–°æˆåŠŸ'
    });

  } catch (error) {
    console.error('æ›´æ–°è®¿å®¢çŠ¶æ€é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// åˆ é™¤è®¿å®¢è®°å½•ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
router.delete('/:id', authMiddleware(['admin']), async (req, res) => {
  try {
    const visitorId = req.params.id;

    // æ£€æŸ¥è®¿å®¢è®°å½•æ˜¯å¦å­˜åœ¨
    const [existingVisitors] = await pool.execute(
      'SELECT id FROM visitors WHERE id = ?',
      [visitorId]
    );

    if (existingVisitors.length === 0) {
      return res.status(404).json({
        code: 404,
        message: 'è®¿å®¢è®°å½•ä¸å­˜åœ¨'
      });
    }

    // åˆ é™¤è®°å½•
    await pool.execute(
      'DELETE FROM visitors WHERE id = ?',
      [visitorId]
    );

    res.json({
      code: 200,
      message: 'è®¿å®¢è®°å½•åˆ é™¤æˆåŠŸ'
    });

  } catch (error) {
    console.error('åˆ é™¤è®¿å®¢è®°å½•é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

// è·å–è®¿å®¢ç»Ÿè®¡
router.get('/stats/overview', authMiddleware(['admin', 'staff']), [
  query('building_id').optional().isInt({ min: 1 }).toInt(),
  query('start_date').optional().isDate(),
  query('end_date').optional().isDate()
], async (req, res) => {
  try {
    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        code: 400,
        message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
        errors: errors.array()
      });
    }

    const { building_id, start_date, end_date } = req.query;

    // æ ¹æ®ç”¨æˆ·è§’è‰²æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereConditions = ['1 = 1'];
    const params = [];

    // å®¿ç®¡åªèƒ½çœ‹åˆ°è‡ªå·±ç®¡ç†æ¥¼æ ‹çš„ç»Ÿè®¡
    if (req.user.role === 'staff') {
      const [managedBuildings] = await pool.execute(
        'SELECT id FROM buildings WHERE manager_id = ?',
        [req.user.id]
      );
      if (managedBuildings.length > 0) {
        const buildingIds = managedBuildings.map(b => b.id);
        whereConditions.push(`building_id IN (${buildingIds.join(',')})`);
      } else {
        return res.json({
          code: 200,
          message: 'è·å–æˆåŠŸ',
          data: {
            overview: {
              total_visitors: 0,
              pending: 0,
              arrived: 0,
              left: 0,
              cancelled: 0
            },
            by_building: [],
            by_relationship: [],
            by_month: []
          }
        });
      }
    }

    if (building_id) {
      whereConditions.push('building_id = ?');
      params.push(building_id);
    }

    if (start_date) {
      whereConditions.push('DATE(expected_arrival) >= ?');
      params.push(start_date);
    }

    if (end_date) {
      whereConditions.push('DATE(expected_arrival) <= ?');
      params.push(end_date);
    }

    const whereClause = whereConditions.join(' AND ');

    // è·å–æ€»ä½“ç»Ÿè®¡
    const [overviewStats] = await pool.execute(
      `SELECT 
         COUNT(*) as total_visitors,
         SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
         SUM(CASE WHEN status = 'arrived' THEN 1 ELSE 0 END) as arrived,
         SUM(CASE WHEN status = 'left' THEN 1 ELSE 0 END) as left_count,
         SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) as cancelled
       FROM visitors
       WHERE ${whereClause}`,
      params
    );

    // æŒ‰æ¥¼æ ‹ç»Ÿè®¡
    const [buildingStats] = await pool.execute(
      `SELECT b.id, b.building_name, b.building_code,
              COUNT(v.id) as visitor_count,
              SUM(CASE WHEN v.status = 'arrived' THEN 1 ELSE 0 END) as arrived_count
       FROM buildings b
       LEFT JOIN visitors v ON b.id = v.building_id AND ${whereClause.replace('building_id', 'v.building_id')}
       GROUP BY b.id, b.building_name, b.building_code
       ORDER BY visitor_count DESC`,
      params.filter(p => !building_id || p === building_id)
    );

    // æŒ‰å…³ç³»ç»Ÿè®¡
    const [relationshipStats] = await pool.execute(
      `SELECT relationship, COUNT(*) as count
       FROM visitors
       WHERE ${whereClause}
       GROUP BY relationship
       ORDER BY count DESC`,
      params
    );

    // æŒ‰æœˆç»Ÿè®¡ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
    const monthlyParams = [...params];
    const monthlyWhereClause = whereClause;
    
    const [monthlyStats] = await pool.execute(
      `SELECT 
         DATE_FORMAT(expected_arrival, '%Y-%m') as month,
         COUNT(*) as visitor_count
       FROM visitors
       WHERE ${monthlyWhereClause}
         AND expected_arrival >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
       GROUP BY DATE_FORMAT(expected_arrival, '%Y-%m')
       ORDER BY month ASC`,
      monthlyParams
    );

    const stats = {
      overview: overviewStats[0] || {
        total_visitors: 0,
        pending: 0,
        arrived: 0,
        left_count: 0,
        cancelled: 0
      },
      by_building: buildingStats,
      by_relationship: relationshipStats,
      by_month: monthlyStats
    };

    res.json({
      code: 200,
      message: 'è·å–æˆåŠŸ',
      data: stats
    });

  } catch (error) {
    console.error('è·å–è®¿å®¢ç»Ÿè®¡é”™è¯¯:', error);
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  }
});

module.exports = router;



const jwt = require('jsonwebtoken');
require('dotenv').config();

const JWT_SECRET = process.env.JWT_SECRET || 'your_fallback_secret_key';
const JWT_EXPIRE = process.env.JWT_EXPIRE || '7d';

class JWTUtil {
  // ç”ŸæˆToken
  static generateToken(user) {
    const payload = {
      id: user.id,
      username: user.username,
      role: user.role,
      real_name: user.real_name
    };

    return jwt.sign(payload, JWT_SECRET, {
      expiresIn: JWT_EXPIRE
    });
  }

  // éªŒè¯Token
  static verifyToken(token) {
    try {
      return jwt.verify(token, JWT_SECRET);
    } catch (error) {
      return null;
    }
  }

  // è§£ç Tokenï¼ˆä¸éªŒè¯ï¼‰
  static decodeToken(token) {
    try {
      return jwt.decode(token);
    } catch (error) {
      return null;
    }
  }

  // åˆ·æ–°Token
  static refreshToken(token) {
    const decoded = this.decodeToken(token);
    if (!decoded) {
      return null;
    }

    // ç§»é™¤è¿‡æœŸæ—¶é—´
    delete decoded.exp;
    delete decoded.iat;

    // ç”Ÿæˆæ–°Token
    return jwt.sign(decoded, JWT_SECRET, {
      expiresIn: JWT_EXPIRE
    });
  }

  // ä»è¯·æ±‚å¤´è·å–Token
  static getTokenFromHeader(req) {
    const authHeader = req.headers.authorization;
    if (authHeader && authHeader.startsWith('Bearer ')) {
      return authHeader.substring(7);
    }
    return null;
  }

  // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆ7å¤©å†…è¿‡æœŸï¼‰
  static isTokenExpiringSoon(token) {
    try {
      const decoded = jwt.decode(token);
      if (!decoded || !decoded.exp) {
        return false;
      }

      const currentTime = Math.floor(Date.now() / 1000);
      const timeUntilExpiry = decoded.exp - currentTime;
      
      // å¦‚æœ7å¤©å†…è¿‡æœŸ
      return timeUntilExpiry < 7 * 24 * 60 * 60;
    } catch (error) {
      return false;
    }
  }
}

module.exports = JWTUtil;



# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=WxyLxy532504@
DB_NAME=dormitory_system

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key_for_dormitory_system_2023
JWT_EXPIRE=7d

# å°ç¨‹åºé…ç½®
WX_APPID=your_wechat_appid
WX_SECRET=your_wechat_secret

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=5242880



const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');
require('dotenv').config();

// å¯¼å…¥è·¯ç”±
const authRoutes = require('./routes/auth');
const userRoutes = require('./routes/users');
const dormitoryRoutes = require('./routes/dormitory');
const studentRoutes = require('./routes/students');
const repairRoutes = require('./routes/repairs');
const hygieneRoutes = require('./routes/hygiene');
const visitorRoutes = require('./routes/visitors');
const noticeRoutes = require('./routes/notices');

const app = express();

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet());

// CORSé…ç½®
app.use(cors({
  origin: '*', // ç”Ÿäº§ç¯å¢ƒåº”è¯¥è®¾ç½®ä¸ºå…·ä½“åŸŸå
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

// è§£æè¯·æ±‚ä½“
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// é™æ€æ–‡ä»¶æœåŠ¡
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} ${req.method} ${req.url}`);
  next();
});

// æ³¨å†Œè·¯ç”±
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/dormitory', dormitoryRoutes);
app.use('/api/students', studentRoutes);
app.use('/api/repairs', repairRoutes);
app.use('/api/hygiene', hygieneRoutes);
app.use('/api/visitors', visitorRoutes);
app.use('/api/notices', noticeRoutes);

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    service: 'dormitory-management-system'
  });
});

// 404å¤„ç†
app.use((req, res) => {
  res.status(404).json({
    code: 404,
    message: 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨'
  });
});

// å…¨å±€é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error('å…¨å±€é”™è¯¯:', err.stack);
  
  // å¦‚æœæ˜¯éªŒè¯é”™è¯¯
  if (err.name === 'ValidationError') {
    return res.status(400).json({
      code: 400,
      message: 'è¯·æ±‚å‚æ•°é”™è¯¯',
      errors: err.errors
    });
  }
  
  // JWTè®¤è¯é”™è¯¯
  if (err.name === 'JsonWebTokenError') {
    return res.status(401).json({
      code: 401,
      message: 'è®¤è¯å¤±è´¥'
    });
  }
  
  // é»˜è®¤é”™è¯¯å“åº”
  res.status(err.status || 500).json({
    code: err.status || 500,
    message: err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  });
});

module.exports = app;



{
  "name": "dormitory-management-server",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "dormitory-management-server",
      "version": "1.0.0",
      "dependencies": {
        "bcryptjs": "^2.4.3",
        "cors": "^2.8.5",
        "dotenv": "^16.3.1",
        "express": "^4.18.2",
        "express-validator": "^7.0.1",
        "helmet": "^7.0.0",
        "jsonwebtoken": "^9.0.2",
        "moment": "^2.29.4",
        "multer": "^1.4.5-lts.1",
        "mysql2": "^3.6.0",
        "winston": "^3.10.0"
      },
      "devDependencies": {
        "nodemon": "^3.0.1"
      }
    },
    "node_modules/@colors/colors": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/@colors/colors/-/colors-1.6.0.tgz",
      "integrity": "sha512-Ir+AOibqzrIsL6ajt3Rz3LskB7OiMVHqltZmspbW/TJuTVuyOMirVqAkjfY6JISiLHgyNqicAC8AyHHGzNd/dA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.1.90"
      }
    },
    "node_modules/@dabh/diagnostics": {
      "version": "2.0.8",
      "resolved": "https://registry.npmjs.org/@dabh/diagnostics/-/diagnostics-2.0.8.tgz",
      "integrity": "sha512-R4MSXTVnuMzGD7bzHdW2ZhhdPC/igELENcq5IjEverBvq5hn1SXCWcsi6eSsdWP0/Ur+SItRRjAktmdoX/8R/Q==",
      "license": "MIT",
      "dependencies": {
        "@so-ric/colorspace": "^1.1.6",
        "enabled": "2.0.x",
        "kuler": "^2.0.0"
      }
    },
    "node_modules/@so-ric/colorspace": {
      "version": "1.1.6",
      "resolved": "https://registry.npmjs.org/@so-ric/colorspace/-/colorspace-1.1.6.tgz",
      "integrity": "sha512-/KiKkpHNOBgkFJwu9sh48LkHSMYGyuTcSFK/qMBdnOAlrRJzRSXAOFB5qwzaVQuDl8wAvHVMkaASQDReTahxuw==",
      "license": "MIT",
      "dependencies": {
        "color": "^5.0.2",
        "text-hex": "1.0.x"
      }
    },
    "node_modules/@types/triple-beam": {
      "version": "1.3.5",
      "resolved": "https://registry.npmjs.org/@types/triple-beam/-/triple-beam-1.3.5.tgz",
      "integrity": "sha512-6WaYesThRMCl19iryMYP7/x2OVgCtbIVflDGFpWnb9irXI3UjYE4AzmYuiUKY1AJstGijoY+MgUszMgRxIYTYw==",
      "license": "MIT"
    },
    "node_modules/accepts": {
      "version": "1.3.8",
      "resolved": "https://registry.npmjs.org/accepts/-/accepts-1.3.8.tgz",
      "integrity": "sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==",
      "license": "MIT",
      "dependencies": {
        "mime-types": "~2.1.34",
        "negotiator": "0.6.3"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/anymatch": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
      "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "normalize-path": "^3.0.0",
        "picomatch": "^2.0.4"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/append-field": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/append-field/-/append-field-1.0.0.tgz",
      "integrity": "sha512-klpgFSWLW1ZEs8svjfb7g4qWY0YS5imI82dTg+QahUvJ8YqAY0P10Uk8tTyh9ZGuYEZEMaeJYCF5BFuX552hsw==",
      "license": "MIT"
    },
    "node_modules/array-flatten": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/array-flatten/-/array-flatten-1.1.1.tgz",
      "integrity": "sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg==",
      "license": "MIT"
    },
    "node_modules/async": {
      "version": "3.2.6",
      "resolved": "https://registry.npmjs.org/async/-/async-3.2.6.tgz",
      "integrity": "sha512-htCUDlxyyCLMgaM3xXg0C0LW2xqfuQ6p05pCEIsXuyQ+a1koYKTuBMzRNwmybfLgvJDMd0r1LTn4+E0Ti6C2AA==",
      "license": "MIT"
    },
    "node_modules/aws-ssl-profiles": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/aws-ssl-profiles/-/aws-ssl-profiles-1.1.2.tgz",
      "integrity": "sha512-NZKeq9AfyQvEeNlN0zSYAaWrmBffJh3IELMZfRpJVWgrpEbtEpnjvzqBPf+mxoI287JohRDoa+/nsfqqiZmF6g==",
      "license": "MIT",
      "engines": {
        "node": ">= 6.0.0"
      }
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/bcryptjs": {
      "version": "2.4.3",
      "resolved": "https://registry.npmjs.org/bcryptjs/-/bcryptjs-2.4.3.tgz",
      "integrity": "sha512-V/Hy/X9Vt7f3BbPJEi8BdVFMByHi+jNXrYkW3huaybV/kQ0KJg0Y6PkEMbn+zeT+i+SiKZ/HMqJGIIt4LZDqNQ==",
      "license": "MIT"
    },
    "node_modules/binary-extensions": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
      "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/body-parser": {
      "version": "1.20.4",
      "resolved": "https://registry.npmjs.org/body-parser/-/body-parser-1.20.4.tgz",
      "integrity": "sha512-ZTgYYLMOXY9qKU/57FAo8F+HA2dGX7bqGc71txDRC1rS4frdFI5R7NhluHxH6M0YItAP0sHB4uqAOcYKxO6uGA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "content-type": "~1.0.5",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "~1.2.0",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "on-finished": "~2.4.1",
        "qs": "~6.14.0",
        "raw-body": "~2.5.3",
        "type-is": "~1.6.18",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/brace-expansion": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
      "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/braces": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fill-range": "^7.1.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/buffer-equal-constant-time": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/buffer-equal-constant-time/-/buffer-equal-constant-time-1.0.1.tgz",
      "integrity": "sha512-zRpUiDwd/xk6ADqPMATG8vc9VPrkck7T07OIx0gnjmJAnHnTVXNQG3vfvWNuiZIkwu9KrKdA1iJKfsfTVxE6NA==",
      "license": "BSD-3-Clause"
    },
    "node_modules/buffer-from": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/buffer-from/-/buffer-from-1.1.2.tgz",
      "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
      "license": "MIT"
    },
    "node_modules/busboy": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/busboy/-/busboy-1.6.0.tgz",
      "integrity": "sha512-8SFQbg/0hQ9xy3UNTB0YEnsNBbWfhf7RtnzpL7TkBiTBRfrQ9Fxcnz7VJsleJpyp6rVLvXiuORqjlHi5q+PYuA==",
      "dependencies": {
        "streamsearch": "^1.1.0"
      },
      "engines": {
        "node": ">=10.16.0"
      }
    },
    "node_modules/bytes": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/bytes/-/bytes-3.1.2.tgz",
      "integrity": "sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/call-bound": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/call-bound/-/call-bound-1.0.4.tgz",
      "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "get-intrinsic": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/chokidar": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/chokidar/-/chokidar-3.6.0.tgz",
      "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "anymatch": "~3.1.2",
        "braces": "~3.0.2",
        "glob-parent": "~5.1.2",
        "is-binary-path": "~2.1.0",
        "is-glob": "~4.0.1",
        "normalize-path": "~3.0.0",
        "readdirp": "~3.6.0"
      },
      "engines": {
        "node": ">= 8.10.0"
      },
      "funding": {
        "url": "https://paulmillr.com/funding/"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/color": {
      "version": "5.0.3",
      "resolved": "https://registry.npmjs.org/color/-/color-5.0.3.tgz",
      "integrity": "sha512-ezmVcLR3xAVp8kYOm4GS45ZLLgIE6SPAFoduLr6hTDajwb3KZ2F46gulK3XpcwRFb5KKGCSezCBAY4Dw4HsyXA==",
      "license": "MIT",
      "dependencies": {
        "color-convert": "^3.1.3",
        "color-string": "^2.1.3"
      },
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/color-convert": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-3.1.3.tgz",
      "integrity": "sha512-fasDH2ont2GqF5HpyO4w0+BcewlhHEZOFn9c1ckZdHpJ56Qb7MHhH/IcJZbBGgvdtwdwNbLvxiBEdg336iA9Sg==",
      "license": "MIT",
      "dependencies": {
        "color-name": "^2.0.0"
      },
      "engines": {
        "node": ">=14.6"
      }
    },
    "node_modules/color-name": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/color-name/-/color-name-2.1.0.tgz",
      "integrity": "sha512-1bPaDNFm0axzE4MEAzKPuqKWeRaT43U/hyxKPBdqTfmPF+d6n7FSoTFxLVULUJOmiLp01KjhIPPH+HrXZJN4Rg==",
      "license": "MIT",
      "engines": {
        "node": ">=12.20"
      }
    },
    "node_modules/color-string": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/color-string/-/color-string-2.1.4.tgz",
      "integrity": "sha512-Bb6Cq8oq0IjDOe8wJmi4JeNn763Xs9cfrBcaylK1tPypWzyoy2G3l90v9k64kjphl/ZJjPIShFztenRomi8WTg==",
      "license": "MIT",
      "dependencies": {
        "color-name": "^2.0.0"
      },
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/concat-map": {
      "version": "0.0.1",
      "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
      "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/concat-stream": {
      "version": "1.6.2",
      "resolved": "https://registry.npmjs.org/concat-stream/-/concat-stream-1.6.2.tgz",
      "integrity": "sha512-27HBghJxjiZtIk3Ycvn/4kbJk/1uZuJFfuPEns6LaEvpvG1f0hTea8lilrouyo9mVc2GWdcEZ8OLoGmSADlrCw==",
      "engines": [
        "node >= 0.8"
      ],
      "license": "MIT",
      "dependencies": {
        "buffer-from": "^1.0.0",
        "inherits": "^2.0.3",
        "readable-stream": "^2.2.2",
        "typedarray": "^0.0.6"
      }
    },
    "node_modules/content-disposition": {
      "version": "0.5.4",
      "resolved": "https://registry.npmjs.org/content-disposition/-/content-disposition-0.5.4.tgz",
      "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "5.2.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/content-type": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/content-type/-/content-type-1.0.5.tgz",
      "integrity": "sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie": {
      "version": "0.7.2",
      "resolved": "https://registry.npmjs.org/cookie/-/cookie-0.7.2.tgz",
      "integrity": "sha512-yki5XnKuf750l50uGTllt6kKILY4nQ1eNIQatoXEByZ5dWgnKqbnqmTrBE5B4N7lrMJKQ2ytWMiTO2o0v6Ew/w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie-signature": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.7.tgz",
      "integrity": "sha512-NXdYc3dLr47pBkpUCHtKSwIOQXLVn8dZEuywboCOJY/osA0wFSLlSawr3KN8qXJEyX66FcONTH8EIlVuK0yyFA==",
      "license": "MIT"
    },
    "node_modules/core-util-is": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.3.tgz",
      "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==",
      "license": "MIT"
    },
    "node_modules/cors": {
      "version": "2.8.5",
      "resolved": "https://registry.npmjs.org/cors/-/cors-2.8.5.tgz",
      "integrity": "sha512-KIHbLJqu73RGr/hnbrO9uBeixNGuvSQjul/jdFvS/KFSIH1hWVd1ng7zOHx+YrEfInLG7q4n6GHQ9cDtxv/P6g==",
      "license": "MIT",
      "dependencies": {
        "object-assign": "^4",
        "vary": "^1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/denque": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/denque/-/denque-2.1.0.tgz",
      "integrity": "sha512-HVQE3AAb/pxF8fQAoiqpvg9i3evqug3hoiwakOyZAwJm+6vZehbkYXZ0l4JxS+I3QxM97v5aaRNhj8v5oBhekw==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/destroy": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/destroy/-/destroy-1.2.0.tgz",
      "integrity": "sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/dotenv": {
      "version": "16.6.1",
      "resolved": "https://registry.npmjs.org/dotenv/-/dotenv-16.6.1.tgz",
      "integrity": "sha512-uBq4egWHTcTt33a72vpSG0z3HnPuIl6NqYcTrKEg2azoEyl2hpW0zqlxysq2pK9HlDIHyHyakeYaYnSAwd8bow==",
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://dotenvx.com"
      }
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/ecdsa-sig-formatter": {
      "version": "1.0.11",
      "resolved": "https://registry.npmjs.org/ecdsa-sig-formatter/-/ecdsa-sig-formatter-1.0.11.tgz",
      "integrity": "sha512-nagl3RYrbNv6kQkeJIpt6NJZy8twLB/2vtz6yN9Z4vRKHN4/QZJIEbqohALSgwKdnksuY3k5Addp5lg8sVoVcQ==",
      "license": "Apache-2.0",
      "dependencies": {
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/ee-first": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/ee-first/-/ee-first-1.1.1.tgz",
      "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
      "license": "MIT"
    },
    "node_modules/enabled": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/enabled/-/enabled-2.0.0.tgz",
      "integrity": "sha512-AKrN98kuwOzMIdAizXGI86UFBoo26CL21UM763y1h/GMSJ4/OHU9k2YlsmBpyScFo/wbLzWQJBMCW4+IO3/+OQ==",
      "license": "MIT"
    },
    "node_modules/encodeurl": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/escape-html": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/escape-html/-/escape-html-1.0.3.tgz",
      "integrity": "sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow==",
      "license": "MIT"
    },
    "node_modules/etag": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/etag/-/etag-1.8.1.tgz",
      "integrity": "sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/express": {
      "version": "4.22.1",
      "resolved": "https://registry.npmjs.org/express/-/express-4.22.1.tgz",
      "integrity": "sha512-F2X8g9P1X7uCPZMA3MVf9wcTqlyNp7IhH5qPCI0izhaOIYXaW9L535tGA3qmjRzpH+bZczqq7hVKxTR4NWnu+g==",
      "license": "MIT",
      "dependencies": {
        "accepts": "~1.3.8",
        "array-flatten": "1.1.1",
        "body-parser": "~1.20.3",
        "content-disposition": "~0.5.4",
        "content-type": "~1.0.4",
        "cookie": "~0.7.1",
        "cookie-signature": "~1.0.6",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "finalhandler": "~1.3.1",
        "fresh": "~0.5.2",
        "http-errors": "~2.0.0",
        "merge-descriptors": "1.0.3",
        "methods": "~1.1.2",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "path-to-regexp": "~0.1.12",
        "proxy-addr": "~2.0.7",
        "qs": "~6.14.0",
        "range-parser": "~1.2.1",
        "safe-buffer": "5.2.1",
        "send": "~0.19.0",
        "serve-static": "~1.16.2",
        "setprototypeof": "1.2.0",
        "statuses": "~2.0.1",
        "type-is": "~1.6.18",
        "utils-merge": "1.0.1",
        "vary": "~1.1.2"
      },
      "engines": {
        "node": ">= 0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/express-validator": {
      "version": "7.3.1",
      "resolved": "https://registry.npmjs.org/express-validator/-/express-validator-7.3.1.tgz",
      "integrity": "sha512-IGenaSf+DnWc69lKuqlRE9/i/2t5/16VpH5bXoqdxWz1aCpRvEdrBuu1y95i/iL5QP8ZYVATiwLFhwk3EDl5vg==",
      "license": "MIT",
      "dependencies": {
        "lodash": "^4.17.21",
        "validator": "~13.15.23"
      },
      "engines": {
        "node": ">= 8.0.0"
      }
    },
    "node_modules/fecha": {
      "version": "4.2.3",
      "resolved": "https://registry.npmjs.org/fecha/-/fecha-4.2.3.tgz",
      "integrity": "sha512-OP2IUU6HeYKJi3i0z4A19kHMQoLVs4Hc+DPqqxI2h/DPZHTm/vjsfC6P0b4jCMy14XizLBqvndQ+UilD7707Jw==",
      "license": "MIT"
    },
    "node_modules/fill-range": {
      "version": "7.1.1",
      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "to-regex-range": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/finalhandler": {
      "version": "1.3.2",
      "resolved": "https://registry.npmjs.org/finalhandler/-/finalhandler-1.3.2.tgz",
      "integrity": "sha512-aA4RyPcd3badbdABGDuTXCMTtOneUCAYH/gxoYRTZlIJdF0YPWuGqiAsIrhNnnqdXGswYk6dGujem4w80UJFhg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "statuses": "~2.0.2",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/fn.name": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/fn.name/-/fn.name-1.1.0.tgz",
      "integrity": "sha512-GRnmB5gPyJpAhTQdSZTSp9uaPSvl09KoYcMQtsB9rQoOmzs9dH6ffeccH+Z+cv6P68Hu5bC6JjRh4Ah/mHSNRw==",
      "license": "MIT"
    },
    "node_modules/forwarded": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/forwarded/-/forwarded-0.2.0.tgz",
      "integrity": "sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fresh": {
      "version": "0.5.2",
      "resolved": "https://registry.npmjs.org/fresh/-/fresh-0.5.2.tgz",
      "integrity": "sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/generate-function": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/generate-function/-/generate-function-2.3.1.tgz",
      "integrity": "sha512-eeB5GfMNeevm/GRYq20ShmsaGcmI81kIX2K9XQx5miC8KdHaC6Jm0qQ8ZNeGOi7wYB8OsdxKs+Y2oVuTFuVwKQ==",
      "license": "MIT",
      "dependencies": {
        "is-property": "^1.0.2"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-flag": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
      "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/helmet": {
      "version": "7.2.0",
      "resolved": "https://registry.npmjs.org/helmet/-/helmet-7.2.0.tgz",
      "integrity": "sha512-ZRiwvN089JfMXokizgqEPXsl2Guk094yExfoDXR0cBYWxtBbaSww/w+vT4WEJsBW2iTUi1GgZ6swmoug3Oy4Xw==",
      "license": "MIT",
      "engines": {
        "node": ">=16.0.0"
      }
    },
    "node_modules/http-errors": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.1.tgz",
      "integrity": "sha512-4FbRdAX+bSdmo4AUFuS0WNiPz8NgFt+r8ThgNWmlrjQjt1Q7ZR9+zTlce2859x4KSXrwIsaeTqDoKQmtP8pLmQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "~2.0.0",
        "inherits": "~2.0.4",
        "setprototypeof": "~1.2.0",
        "statuses": "~2.0.2",
        "toidentifier": "~1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.4.24",
      "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.4.24.tgz",
      "integrity": "sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/ignore-by-default": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/ignore-by-default/-/ignore-by-default-1.0.1.tgz",
      "integrity": "sha512-Ius2VYcGNk7T90CppJqcIkS5ooHUZyIQK+ClZfMfMNFEF9VSE73Fq+906u/CWu92x4gzZMWOwfFYckPObzdEbA==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "license": "ISC"
    },
    "node_modules/ipaddr.js": {
      "version": "1.9.1",
      "resolved": "https://registry.npmjs.org/ipaddr.js/-/ipaddr.js-1.9.1.tgz",
      "integrity": "sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/is-binary-path": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz",
      "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "binary-extensions": "^2.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-number": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
      "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.12.0"
      }
    },
    "node_modules/is-property": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/is-property/-/is-property-1.0.2.tgz",
      "integrity": "sha512-Ks/IoX00TtClbGQr4TWXemAnktAQvYB7HzcCxDGqEZU6oCmb2INHuOoKxbtR+HFkmYWBKv/dOZtGRiAjDhj92g==",
      "license": "MIT"
    },
    "node_modules/is-stream": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-2.0.1.tgz",
      "integrity": "sha512-hFoiJiTl63nn+kstHGBtewWSKnQLpyb155KHheA1l39uvtO9nWIop1p3udqPcUd/xbF1VLMO4n7OI6p7RbngDg==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/isarray": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-1.0.0.tgz",
      "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==",
      "license": "MIT"
    },
    "node_modules/jsonwebtoken": {
      "version": "9.0.3",
      "resolved": "https://registry.npmjs.org/jsonwebtoken/-/jsonwebtoken-9.0.3.tgz",
      "integrity": "sha512-MT/xP0CrubFRNLNKvxJ2BYfy53Zkm++5bX9dtuPbqAeQpTVe0MQTFhao8+Cp//EmJp244xt6Drw/GVEGCUj40g==",
      "license": "MIT",
      "dependencies": {
        "jws": "^4.0.1",
        "lodash.includes": "^4.3.0",
        "lodash.isboolean": "^3.0.3",
        "lodash.isinteger": "^4.0.4",
        "lodash.isnumber": "^3.0.3",
        "lodash.isplainobject": "^4.0.6",
        "lodash.isstring": "^4.0.1",
        "lodash.once": "^4.0.0",
        "ms": "^2.1.1",
        "semver": "^7.5.4"
      },
      "engines": {
        "node": ">=12",
        "npm": ">=6"
      }
    },
    "node_modules/jsonwebtoken/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/jwa": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/jwa/-/jwa-2.0.1.tgz",
      "integrity": "sha512-hRF04fqJIP8Abbkq5NKGN0Bbr3JxlQ+qhZufXVr0DvujKy93ZCbXZMHDL4EOtodSbCWxOqR8MS1tXA5hwqCXDg==",
      "license": "MIT",
      "dependencies": {
        "buffer-equal-constant-time": "^1.0.1",
        "ecdsa-sig-formatter": "1.0.11",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/jws": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/jws/-/jws-4.0.1.tgz",
      "integrity": "sha512-EKI/M/yqPncGUUh44xz0PxSidXFr/+r0pA70+gIYhjv+et7yxM+s29Y+VGDkovRofQem0fs7Uvf4+YmAdyRduA==",
      "license": "MIT",
      "dependencies": {
        "jwa": "^2.0.1",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/kuler": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/kuler/-/kuler-2.0.0.tgz",
      "integrity": "sha512-Xq9nH7KlWZmXAtodXDDRE7vs6DU1gTU8zYDHDiWLSip45Egwq3plLHzPn27NgvzL2r1LMPC1vdqh98sQxtqj4A==",
      "license": "MIT"
    },
    "node_modules/lodash": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
      "integrity": "sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==",
      "license": "MIT"
    },
    "node_modules/lodash.includes": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/lodash.includes/-/lodash.includes-4.3.0.tgz",
      "integrity": "sha512-W3Bx6mdkRTGtlJISOvVD/lbqjTlPPUDTMnlXZFnVwi9NKJ6tiAk6LVdlhZMm17VZisqhKcgzpO5Wz91PCt5b0w==",
      "license": "MIT"
    },
    "node_modules/lodash.isboolean": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/lodash.isboolean/-/lodash.isboolean-3.0.3.tgz",
      "integrity": "sha512-Bz5mupy2SVbPHURB98VAcw+aHh4vRV5IPNhILUCsOzRmsTmSQ17jIuqopAentWoehktxGd9e/hbIXq980/1QJg==",
      "license": "MIT"
    },
    "node_modules/lodash.isinteger": {
      "version": "4.0.4",
      "resolved": "https://registry.npmjs.org/lodash.isinteger/-/lodash.isinteger-4.0.4.tgz",
      "integrity": "sha512-DBwtEWN2caHQ9/imiNeEA5ys1JoRtRfY3d7V9wkqtbycnAmTvRRmbHKDV4a0EYc678/dia0jrte4tjYwVBaZUA==",
      "license": "MIT"
    },
    "node_modules/lodash.isnumber": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/lodash.isnumber/-/lodash.isnumber-3.0.3.tgz",
      "integrity": "sha512-QYqzpfwO3/CWf3XP+Z+tkQsfaLL/EnUlXWVkIk5FUPc4sBdTehEqZONuyRt2P67PXAk+NXmTBcc97zw9t1FQrw==",
      "license": "MIT"
    },
    "node_modules/lodash.isplainobject": {
      "version": "4.0.6",
      "resolved": "https://registry.npmjs.org/lodash.isplainobject/-/lodash.isplainobject-4.0.6.tgz",
      "integrity": "sha512-oSXzaWypCMHkPC3NvBEaPHf0KsA5mvPrOPgQWDsbg8n7orZ290M0BmC/jgRZ4vcJ6DTAhjrsSYgdsW/F+MFOBA==",
      "license": "MIT"
    },
    "node_modules/lodash.isstring": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/lodash.isstring/-/lodash.isstring-4.0.1.tgz",
      "integrity": "sha512-0wJxfxH1wgO3GrbuP+dTTk7op+6L41QCXbGINEmD+ny/G/eCqGzxyCsh7159S+mgDDcoarnBw6PC1PS5+wUGgw==",
      "license": "MIT"
    },
    "node_modules/lodash.once": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/lodash.once/-/lodash.once-4.1.1.tgz",
      "integrity": "sha512-Sb487aTOCr9drQVL8pIxOzVhafOjZN9UU54hiN8PU3uAiSV7lx1yYNpbNmex2PK6dSJoNTSJUUswT651yww3Mg==",
      "license": "MIT"
    },
    "node_modules/logform": {
      "version": "2.7.0",
      "resolved": "https://registry.npmjs.org/logform/-/logform-2.7.0.tgz",
      "integrity": "sha512-TFYA4jnP7PVbmlBIfhlSe+WKxs9dklXMTEGcBCIvLhE/Tn3H6Gk1norupVW7m5Cnd4bLcr08AytbyV/xj7f/kQ==",
      "license": "MIT",
      "dependencies": {
        "@colors/colors": "1.6.0",
        "@types/triple-beam": "^1.3.2",
        "fecha": "^4.2.0",
        "ms": "^2.1.1",
        "safe-stable-stringify": "^2.3.1",
        "triple-beam": "^1.3.0"
      },
      "engines": {
        "node": ">= 12.0.0"
      }
    },
    "node_modules/logform/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/long": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/long/-/long-5.3.2.tgz",
      "integrity": "sha512-mNAgZ1GmyNhD7AuqnTG3/VQ26o760+ZYBPKjPvugO8+nLbYfX6TVpJPseBvopbdY+qpZ/lKUnmEc1LeZYS3QAA==",
      "license": "Apache-2.0"
    },
    "node_modules/lru.min": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/lru.min/-/lru.min-1.1.3.tgz",
      "integrity": "sha512-Lkk/vx6ak3rYkRR0Nhu4lFUT2VDnQSxBe8Hbl7f36358p6ow8Bnvr8lrLt98H8J1aGxfhbX4Fs5tYg2+FTwr5Q==",
      "license": "MIT",
      "engines": {
        "bun": ">=1.0.0",
        "deno": ">=1.30.0",
        "node": ">=8.0.0"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/wellwelwel"
      }
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/media-typer": {
      "version": "0.3.0",
      "resolved": "https://registry.npmjs.org/media-typer/-/media-typer-0.3.0.tgz",
      "integrity": "sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/merge-descriptors": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/methods": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/methods/-/methods-1.1.2.tgz",
      "integrity": "sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/mime/-/mime-1.6.0.tgz",
      "integrity": "sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==",
      "license": "MIT",
      "bin": {
        "mime": "cli.js"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "license": "MIT",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/minimist": {
      "version": "1.2.8",
      "resolved": "https://registry.npmjs.org/minimist/-/minimist-1.2.8.tgz",
      "integrity": "sha512-2yyAR8qBkN3YuheJanUpWC5U3bb5osDywNB8RzDVlDwDHbocAJveqqj1u8+SVD7jkWT4yvsHCpWqqWqAxb0zCA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/mkdirp": {
      "version": "0.5.6",
      "resolved": "https://registry.npmjs.org/mkdirp/-/mkdirp-0.5.6.tgz",
      "integrity": "sha512-FP+p8RB8OWpF3YZBCrP5gtADmtXApB5AMLn+vdyA+PyxCjrCs00mjyUozssO33cwDeT3wNGdLxJ5M//YqtHAJw==",
      "license": "MIT",
      "dependencies": {
        "minimist": "^1.2.6"
      },
      "bin": {
        "mkdirp": "bin/cmd.js"
      }
    },
    "node_modules/moment": {
      "version": "2.30.1",
      "resolved": "https://registry.npmjs.org/moment/-/moment-2.30.1.tgz",
      "integrity": "sha512-uEmtNhbDOrWPFS+hdjFCBfy9f2YoyzRpwcl+DqpC6taX21FzsTLQVbMV/W7PzNSX6x/bhC1zA3c2UQ5NzH6how==",
      "license": "MIT",
      "engines": {
        "node": "*"
      }
    },
    "node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/multer": {
      "version": "1.4.5-lts.2",
      "resolved": "https://registry.npmjs.org/multer/-/multer-1.4.5-lts.2.tgz",
      "integrity": "sha512-VzGiVigcG9zUAoCNU+xShztrlr1auZOlurXynNvO9GiWD1/mTBbUljOKY+qMeazBqXgRnjzeEgJI/wyjJUHg9A==",
      "deprecated": "Multer 1.x is impacted by a number of vulnerabilities, which have been patched in 2.x. You should upgrade to the latest 2.x version.",
      "license": "MIT",
      "dependencies": {
        "append-field": "^1.0.0",
        "busboy": "^1.0.0",
        "concat-stream": "^1.5.2",
        "mkdirp": "^0.5.4",
        "object-assign": "^4.1.1",
        "type-is": "^1.6.4",
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">= 6.0.0"
      }
    },
    "node_modules/mysql2": {
      "version": "3.15.3",
      "resolved": "https://registry.npmjs.org/mysql2/-/mysql2-3.15.3.tgz",
      "integrity": "sha512-FBrGau0IXmuqg4haEZRBfHNWB5mUARw6hNwPDXXGg0XzVJ50mr/9hb267lvpVMnhZ1FON3qNd4Xfcez1rbFwSg==",
      "license": "MIT",
      "dependencies": {
        "aws-ssl-profiles": "^1.1.1",
        "denque": "^2.1.0",
        "generate-function": "^2.3.1",
        "iconv-lite": "^0.7.0",
        "long": "^5.2.1",
        "lru.min": "^1.0.0",
        "named-placeholders": "^1.1.3",
        "seq-queue": "^0.0.5",
        "sqlstring": "^2.3.2"
      },
      "engines": {
        "node": ">= 8.0"
      }
    },
    "node_modules/mysql2/node_modules/iconv-lite": {
      "version": "0.7.1",
      "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.7.1.tgz",
      "integrity": "sha512-2Tth85cXwGFHfvRgZWszZSvdo+0Xsqmw8k8ZwxScfcBneNUraK+dxRxRm24nszx80Y0TVio8kKLt5sLE7ZCLlw==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/named-placeholders": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/named-placeholders/-/named-placeholders-1.1.4.tgz",
      "integrity": "sha512-/qfG0Kk/bLJIvej4FcPQ2KYUJP8iQdU1CTxysNb/U2wUNb+/4K485yeio8iNoiwfqJnsTInXoRPTza0dZWHVJQ==",
      "license": "MIT",
      "dependencies": {
        "lru.min": "^1.1.0"
      },
      "engines": {
        "node": ">=8.0.0"
      }
    },
    "node_modules/negotiator": {
      "version": "0.6.3",
      "resolved": "https://registry.npmjs.org/negotiator/-/negotiator-0.6.3.tgz",
      "integrity": "sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/nodemon": {
      "version": "3.1.11",
      "resolved": "https://registry.npmjs.org/nodemon/-/nodemon-3.1.11.tgz",
      "integrity": "sha512-is96t8F/1//UHAjNPHpbsNY46ELPpftGUoSVNXwUfMk/qdjSylYrWSu1XavVTBOn526kFiOR733ATgNBCQyH0g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "chokidar": "^3.5.2",
        "debug": "^4",
        "ignore-by-default": "^1.0.1",
        "minimatch": "^3.1.2",
        "pstree.remy": "^1.1.8",
        "semver": "^7.5.3",
        "simple-update-notifier": "^2.0.0",
        "supports-color": "^5.5.0",
        "touch": "^3.1.0",
        "undefsafe": "^2.0.5"
      },
      "bin": {
        "nodemon": "bin/nodemon.js"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/nodemon"
      }
    },
    "node_modules/nodemon/node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/nodemon/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/normalize-path": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
      "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-inspect": {
      "version": "1.13.4",
      "resolved": "https://registry.npmjs.org/object-inspect/-/object-inspect-1.13.4.tgz",
      "integrity": "sha512-W67iLl4J2EXEGTbfeHCffrjDfitvLANg0UlX3wFUUSTx92KXRFegMHUVgSqE+wvhAbi4WqjGg9czysTV2Epbew==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/on-finished": {
      "version": "2.4.1",
      "resolved": "https://registry.npmjs.org/on-finished/-/on-finished-2.4.1.tgz",
      "integrity": "sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==",
      "license": "MIT",
      "dependencies": {
        "ee-first": "1.1.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/one-time": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/one-time/-/one-time-1.0.0.tgz",
      "integrity": "sha512-5DXOiRKwuSEcQ/l0kGCF6Q3jcADFv5tSmRaJck/OqkVFcOzutB134KRSfF0xDrL39MNnqxbHBbUUcjZIhTgb2g==",
      "license": "MIT",
      "dependencies": {
        "fn.name": "1.x.x"
      }
    },
    "node_modules/parseurl": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/parseurl/-/parseurl-1.3.3.tgz",
      "integrity": "sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/path-to-regexp": {
      "version": "0.1.12",
      "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
      "integrity": "sha512-RA1GjUVMnvYFxuqovrEqZoxxW5NUZqbwKtYz/Tt7nXerk0LbLblQmrsgdeOxV5SFHf0UDggjS/bSeOZwt1pmEQ==",
      "license": "MIT"
    },
    "node_modules/picomatch": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
      "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/process-nextick-args": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
      "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==",
      "license": "MIT"
    },
    "node_modules/proxy-addr": {
      "version": "2.0.7",
      "resolved": "https://registry.npmjs.org/proxy-addr/-/proxy-addr-2.0.7.tgz",
      "integrity": "sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==",
      "license": "MIT",
      "dependencies": {
        "forwarded": "0.2.0",
        "ipaddr.js": "1.9.1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/pstree.remy": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/pstree.remy/-/pstree.remy-1.1.8.tgz",
      "integrity": "sha512-77DZwxQmxKnu3aR542U+X8FypNzbfJ+C5XQDk3uWjWxn6151aIMGthWYRXTqT1E5oJvg+ljaa2OJi+VfvCOQ8w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/qs": {
      "version": "6.14.0",
      "resolved": "https://registry.npmjs.org/qs/-/qs-6.14.0.tgz",
      "integrity": "sha512-YWWTjgABSKcvs/nWBi9PycY/JiPJqOD4JA6o9Sej2AtvSGarXxKC3OQSk4pAarbdQlKAh5D4FCQkJNkW+GAn3w==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "side-channel": "^1.1.0"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/range-parser": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/range-parser/-/range-parser-1.2.1.tgz",
      "integrity": "sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/raw-body": {
      "version": "2.5.3",
      "resolved": "https://registry.npmjs.org/raw-body/-/raw-body-2.5.3.tgz",
      "integrity": "sha512-s4VSOf6yN0rvbRZGxs8Om5CWj6seneMwK3oDb4lWDH0UPhWcxwOWw5+qk24bxq87szX1ydrwylIOp2uG1ojUpA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/readable-stream": {
      "version": "2.3.8",
      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-2.3.8.tgz",
      "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
      "license": "MIT",
      "dependencies": {
        "core-util-is": "~1.0.0",
        "inherits": "~2.0.3",
        "isarray": "~1.0.0",
        "process-nextick-args": "~2.0.0",
        "safe-buffer": "~5.1.1",
        "string_decoder": "~1.1.1",
        "util-deprecate": "~1.0.1"
      }
    },
    "node_modules/readable-stream/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/readdirp": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/readdirp/-/readdirp-3.6.0.tgz",
      "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "picomatch": "^2.2.1"
      },
      "engines": {
        "node": ">=8.10.0"
      }
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/safe-stable-stringify": {
      "version": "2.5.0",
      "resolved": "https://registry.npmjs.org/safe-stable-stringify/-/safe-stable-stringify-2.5.0.tgz",
      "integrity": "sha512-b3rppTKm9T+PsVCBEOUR46GWI7fdOs00VKZ1+9c1EWDaDMvjQc6tUwuFyIprgGgTcWoVHSKrU8H31ZHA2e0RHA==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
      "license": "MIT"
    },
    "node_modules/semver": {
      "version": "7.7.3",
      "resolved": "https://registry.npmjs.org/semver/-/semver-7.7.3.tgz",
      "integrity": "sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==",
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/send": {
      "version": "0.19.1",
      "resolved": "https://registry.npmjs.org/send/-/send-0.19.1.tgz",
      "integrity": "sha512-p4rRk4f23ynFEfcD9LA0xRYngj+IyGiEYyqqOak8kaN0TvNmuxC2dcVeBn62GpCeR2CpWqyHCNScTP91QbAVFg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "2.0.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/send/node_modules/http-errors": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.0.tgz",
      "integrity": "sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "2.0.0",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "toidentifier": "1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/send/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/send/node_modules/statuses": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.1.tgz",
      "integrity": "sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/seq-queue": {
      "version": "0.0.5",
      "resolved": "https://registry.npmjs.org/seq-queue/-/seq-queue-0.0.5.tgz",
      "integrity": "sha512-hr3Wtp/GZIc/6DAGPDcV4/9WoZhjrkXsi5B/07QgX8tsdc6ilr7BFM6PM6rbdAX1kFSDYeZGLipIZZKyQP0O5Q=="
    },
    "node_modules/serve-static": {
      "version": "1.16.2",
      "resolved": "https://registry.npmjs.org/serve-static/-/serve-static-1.16.2.tgz",
      "integrity": "sha512-VqpjJZKadQB/PEbEwvFdO43Ax5dFBZ2UECszz8bQ7pi7wt//PWe1P6MN7eCnjsatYtBT6EuiClbjSWP2WrIoTw==",
      "license": "MIT",
      "dependencies": {
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "parseurl": "~1.3.3",
        "send": "0.19.0"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/serve-static/node_modules/http-errors": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.0.tgz",
      "integrity": "sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "2.0.0",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "toidentifier": "1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/serve-static/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/serve-static/node_modules/send": {
      "version": "0.19.0",
      "resolved": "https://registry.npmjs.org/send/-/send-0.19.0.tgz",
      "integrity": "sha512-dW41u5VfLXu8SJh5bwRmyYUbAoSB3c9uQh6L8h/KtsFREPWpbX1lrljJo186Jc4nmci/sGUZ9a0a0J2zgfq2hw==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~1.0.2",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "2.0.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/serve-static/node_modules/send/node_modules/encodeurl": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-1.0.2.tgz",
      "integrity": "sha512-TPJXq8JqFaVYm2CWmPvnP2Iyo4ZSM7/QKcSmuMLDObfpH5fi7RUGmd/rTDf+rut/saiDiQEeVTNgAmJEdAOx0w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/serve-static/node_modules/statuses": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.1.tgz",
      "integrity": "sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "license": "ISC"
    },
    "node_modules/side-channel": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/side-channel/-/side-channel-1.1.0.tgz",
      "integrity": "sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3",
        "side-channel-list": "^1.0.0",
        "side-channel-map": "^1.0.1",
        "side-channel-weakmap": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-list": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/side-channel-list/-/side-channel-list-1.0.0.tgz",
      "integrity": "sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-map": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/side-channel-map/-/side-channel-map-1.0.1.tgz",
      "integrity": "sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-weakmap": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz",
      "integrity": "sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3",
        "side-channel-map": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/simple-update-notifier": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/simple-update-notifier/-/simple-update-notifier-2.0.0.tgz",
      "integrity": "sha512-a2B9Y0KlNXl9u/vsW6sTIu9vGEpfKu2wRV6l1H3XEas/0gUIzGzBoP/IouTcUQbm9JWZLH3COxyn03TYlFax6w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "semver": "^7.5.3"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/sqlstring": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/sqlstring/-/sqlstring-2.3.3.tgz",
      "integrity": "sha512-qC9iz2FlN7DQl3+wjwn3802RTyjCx7sDvfQEXchwa6CWOx07/WVfh91gBmQ9fahw8snwGEWU3xGzOt4tFyHLxg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/stack-trace": {
      "version": "0.0.10",
      "resolved": "https://registry.npmjs.org/stack-trace/-/stack-trace-0.0.10.tgz",
      "integrity": "sha512-KGzahc7puUKkzyMt+IqAep+TVNbKP+k2Lmwhub39m1AsTSkaDutx56aDCo+HLDzf/D26BIHTJWNiTG1KAJiQCg==",
      "license": "MIT",
      "engines": {
        "node": "*"
      }
    },
    "node_modules/statuses": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.2.tgz",
      "integrity": "sha512-DvEy55V3DB7uknRo+4iOGT5fP1slR8wQohVdknigZPMpMstaKJQWhwiYBACJE3Ul2pTnATihhBYnRhZQHGBiRw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/streamsearch": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/streamsearch/-/streamsearch-1.1.0.tgz",
      "integrity": "sha512-Mcc5wHehp9aXz1ax6bZUyY5afg9u2rv5cqQI3mRrYkGC8rW2hM02jWuwjtL++LS5qinSyhj2QfLyNsuc+VsExg==",
      "engines": {
        "node": ">=10.0.0"
      }
    },
    "node_modules/string_decoder": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/string_decoder/-/string_decoder-1.1.1.tgz",
      "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "~5.1.0"
      }
    },
    "node_modules/string_decoder/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/supports-color": {
      "version": "5.5.0",
      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
      "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "has-flag": "^3.0.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/text-hex": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/text-hex/-/text-hex-1.0.0.tgz",
      "integrity": "sha512-uuVGNWzgJ4yhRaNSiubPY7OjISw4sw4E5Uv0wbjp+OzcbmVU/rsT8ujgcXJhn9ypzsgr5vlzpPqP+MBBKcGvbg==",
      "license": "MIT"
    },
    "node_modules/to-regex-range": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-number": "^7.0.0"
      },
      "engines": {
        "node": ">=8.0"
      }
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/touch": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/touch/-/touch-3.1.1.tgz",
      "integrity": "sha512-r0eojU4bI8MnHr8c5bNo7lJDdI2qXlWWJk6a9EAFG7vbhTjElYhBVS3/miuE0uOuoLdb8Mc/rVfsmm6eo5o9GA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "nodetouch": "bin/nodetouch.js"
      }
    },
    "node_modules/triple-beam": {
      "version": "1.4.1",
      "resolved": "https://registry.npmjs.org/triple-beam/-/triple-beam-1.4.1.tgz",
      "integrity": "sha512-aZbgViZrg1QNcG+LULa7nhZpJTZSLm/mXnHXnbAbjmN5aSa0y7V+wvv6+4WaBtpISJzThKy+PIPxc1Nq1EJ9mg==",
      "license": "MIT",
      "engines": {
        "node": ">= 14.0.0"
      }
    },
    "node_modules/type-is": {
      "version": "1.6.18",
      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
      "license": "MIT",
      "dependencies": {
        "media-typer": "0.3.0",
        "mime-types": "~2.1.24"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/typedarray": {
      "version": "0.0.6",
      "resolved": "https://registry.npmjs.org/typedarray/-/typedarray-0.0.6.tgz",
      "integrity": "sha512-/aCDEGatGvZ2BIk+HmLf4ifCJFwvKFNb9/JeZPMulfgFracn9QFcAf5GO8B/mweUjSoblS5In0cWhqpfs/5PQA==",
      "license": "MIT"
    },
    "node_modules/undefsafe": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/undefsafe/-/undefsafe-2.0.5.tgz",
      "integrity": "sha512-WxONCrssBM8TSPRqN5EmsjVrsv4A8X12J4ArBiiayv3DyyG3ZlIg6yysuuSYdZsVz3TKcTg2fd//Ujd4CHV1iA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/unpipe": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "license": "MIT"
    },
    "node_modules/utils-merge": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/validator": {
      "version": "13.15.23",
      "resolved": "https://registry.npmjs.org/validator/-/validator-13.15.23.tgz",
      "integrity": "sha512-4yoz1kEWqUjzi5zsPbAS/903QXSYp0UOtHsPpp7p9rHAw/W+dkInskAE386Fat3oKRROwO98d9ZB0G4cObgUyw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/vary": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/winston": {
      "version": "3.19.0",
      "resolved": "https://registry.npmjs.org/winston/-/winston-3.19.0.tgz",
      "integrity": "sha512-LZNJgPzfKR+/J3cHkxcpHKpKKvGfDZVPS4hfJCc4cCG0CgYzvlD6yE/S3CIL/Yt91ak327YCpiF/0MyeZHEHKA==",
      "license": "MIT",
      "dependencies": {
        "@colors/colors": "^1.6.0",
        "@dabh/diagnostics": "^2.0.8",
        "async": "^3.2.3",
        "is-stream": "^2.0.0",
        "logform": "^2.7.0",
        "one-time": "^1.0.0",
        "readable-stream": "^3.4.0",
        "safe-stable-stringify": "^2.3.1",
        "stack-trace": "0.0.x",
        "triple-beam": "^1.3.0",
        "winston-transport": "^4.9.0"
      },
      "engines": {
        "node": ">= 12.0.0"
      }
    },
    "node_modules/winston-transport": {
      "version": "4.9.0",
      "resolved": "https://registry.npmjs.org/winston-transport/-/winston-transport-4.9.0.tgz",
      "integrity": "sha512-8drMJ4rkgaPo1Me4zD/3WLfI/zPdA9o2IipKODunnGDcuqbHwjsbB79ylv04LCGGzU0xQ6vTznOMpQGaLhhm6A==",
      "license": "MIT",
      "dependencies": {
        "logform": "^2.7.0",
        "readable-stream": "^3.6.2",
        "triple-beam": "^1.3.0"
      },
      "engines": {
        "node": ">= 12.0.0"
      }
    },
    "node_modules/winston-transport/node_modules/readable-stream": {
      "version": "3.6.2",
      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
      "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
      "license": "MIT",
      "dependencies": {
        "inherits": "^2.0.3",
        "string_decoder": "^1.1.1",
        "util-deprecate": "^1.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/winston/node_modules/readable-stream": {
      "version": "3.6.2",
      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
      "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
      "license": "MIT",
      "dependencies": {
        "inherits": "^2.0.3",
        "string_decoder": "^1.1.1",
        "util-deprecate": "^1.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/xtend": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/xtend/-/xtend-4.0.2.tgz",
      "integrity": "sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4"
      }
    }
  }
}




{
  "name": "dormitory-management-server",
  "version": "1.0.0",
  "description": "å®¿èˆç®¡ç†ç³»ç»Ÿåç«¯",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mysql2": "^3.6.0",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "dotenv": "^16.3.1",
    "cors": "^2.8.5",
    "express-validator": "^7.0.1",
    "multer": "^1.4.5-lts.1",
    "moment": "^2.29.4",
    "winston": "^3.10.0",
    "helmet": "^7.0.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}



const app = require('./app');
require('dotenv').config();

const PORT = process.env.PORT || 3000;

// å¯åŠ¨æœåŠ¡å™¨
const server = app.listen(PORT, () => {
  console.log(`ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`);
  console.log(`ğŸ“¡ ç›‘å¬ç«¯å£: ${PORT}`);
  console.log(`ğŸŒ è®¿é—®åœ°å€: http://localhost:${PORT}`);
  console.log(`ğŸ•’ å¯åŠ¨æ—¶é—´: ${new Date().toISOString()}`);
});

// ä¼˜é›…å…³é—­
const gracefulShutdown = () => {
  console.log('æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...');
  
  server.close(() => {
    console.log('HTTPæœåŠ¡å™¨å·²å…³é—­');
    process.exit(0);
  });

  // å¦‚æœ10ç§’åè¿˜æ²¡å…³é—­ï¼Œå¼ºåˆ¶é€€å‡º
  setTimeout(() => {
    console.error('å¼ºåˆ¶å…³é—­æœåŠ¡å™¨...');
    process.exit(1);
  }, 10000);
};

// ç›‘å¬é€€å‡ºä¿¡å·
process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);

// æœªæ•è·å¼‚å¸¸å¤„ç†
process.on('uncaughtException', (err) => {
  console.error('æœªæ•è·å¼‚å¸¸:', err);
  gracefulShutdown();
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);
  gracefulShutdown();
});



// app.js
App({
  onLaunch() {
    // å±•ç¤ºæœ¬åœ°å­˜å‚¨èƒ½åŠ›
    const logs = wx.getStorageSync('logs') || []
    logs.unshift(Date.now())
    wx.setStorageSync('logs', logs)

    // ç™»å½•
    wx.login({
      success: res => {
        // å‘é€ res.code åˆ°åå°æ¢å– openId, sessionKey, unionId
      }
    })
    
    // è·å–ç³»ç»Ÿä¿¡æ¯ï¼ˆå…¼å®¹è€ç‰ˆæœ¬APIï¼‰
    try {
      wx.getSystemInfo({
        success: res => {
          this.globalData.systemInfo = res
        }
      })
    } catch (error) {
      console.log('getSystemInfo deprecated, using new APIs')
    }
    
    // è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆæ–°APIï¼‰
    try {
      wx.getDeviceInfo({
        success: (res) => {
          this.globalData.deviceInfo = res
        }
      })
    } catch (error) {
      console.log('getDeviceInfo not available')
    }
  },

  globalData: {
    userInfo: null,
    systemInfo: null,
    deviceInfo: null,
    apiBaseUrl: 'http://localhost:3000/api', // åç«¯APIåœ°å€ï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    token: null,
    userRole: null
  },

  // è®¾ç½®token
  setToken(token) {
    this.globalData.token = token
    wx.setStorageSync('token', token)
  },

  // è·å–token
  getToken() {
    if (!this.globalData.token) {
      this.globalData.token = wx.getStorageSync('token')
    }
    return this.globalData.token
  },

  // æ¸…é™¤token
  clearToken() {
    this.globalData.token = null
    this.globalData.userInfo = null
    this.globalData.userRole = null
    wx.removeStorageSync('token')
    wx.removeStorageSync('userInfo')
  },

  // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
  setUserInfo(userInfo) {
    this.globalData.userInfo = userInfo
    this.globalData.userRole = userInfo.role
    wx.setStorageSync('userInfo', userInfo)
  },

  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo() {
    if (!this.globalData.userInfo) {
      this.globalData.userInfo = wx.getStorageSync('userInfo')
      if (this.globalData.userInfo) {
        this.globalData.userRole = this.globalData.userInfo.role
      }
    }
    return this.globalData.userInfo
  },

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLogin() {
    const token = this.getToken()
    const userInfo = this.getUserInfo()
    return token && userInfo
  },

  // ç»Ÿä¸€çš„APIè¯·æ±‚æ–¹æ³•
  request(url, method = 'GET', data = {}, showLoading = true) {
    const app = this
    const token = app.getToken()
    
    return new Promise((resolve, reject) => {
      if (showLoading) {
        wx.showLoading({
          title: 'åŠ è½½ä¸­...',
          mask: true
        })
      }

      const header = {
        'Content-Type': 'application/json'
      }

      if (token) {
        header['Authorization'] = `Bearer ${token}`
      }

      wx.request({
        url: `${app.globalData.apiBaseUrl}${url}`,
        method,
        data,
        header,
        success: (res) => {
          if (showLoading) {
            wx.hideLoading()
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„token
          if (res.header && res.header['X-New-Token']) {
            app.setToken(res.header['X-New-Token'])
          }

          if (res.statusCode === 200) {
            if (res.data.code === 200) {
              resolve(res.data)
            } else if (res.data.code === 401) {
              // tokenè¿‡æœŸï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€
              app.clearToken()
              wx.showToast({
                title: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
                icon: 'none',
                duration: 2000
              })
              setTimeout(() => {
                wx.reLaunch({
                  url: '/pages/login/login'
                })
              }, 1500)
              reject(new Error('ç™»å½•å·²è¿‡æœŸ'))
            } else {
              wx.showToast({
                title: res.data.message || 'è¯·æ±‚å¤±è´¥',
                icon: 'none',
                duration: 2000
              })
              reject(res.data)
            }
          } else {
            wx.showToast({
              title: `è¯·æ±‚å¤±è´¥ ${res.statusCode}`,
              icon: 'none',
              duration: 2000
            })
            reject(new Error(`HTTP ${res.statusCode}`))
          }
        },
        fail: (err) => {
          if (showLoading) {
            wx.hideLoading()
          }
          
          // å¤„ç†ç½‘ç»œé”™è¯¯
          if (err.errMsg && err.errMsg.includes('network')) {
            wx.showToast({
              title: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ',
              icon: 'none',
              duration: 2000
            })
          } else {
            wx.showToast({
              title: 'è¯·æ±‚å¤±è´¥',
              icon: 'none',
              duration: 2000
            })
          }
          reject(err)
        }
      })
    })
  },

  // ä¸Šä¼ æ–‡ä»¶
  uploadFile(url, filePath, formData = {}) {
    const app = this
    const token = app.getToken()
    
    return new Promise((resolve, reject) => {
      wx.showLoading({
        title: 'ä¸Šä¼ ä¸­...',
        mask: true
      })

      const header = {}
      if (token) {
        header['Authorization'] = `Bearer ${token}`
      }

      wx.uploadFile({
        url: `${app.globalData.apiBaseUrl}${url}`,
        filePath,
        name: 'file',
        formData,
        header,
        success: (res) => {
          wx.hideLoading()
          if (res.statusCode === 200) {
            try {
              const data = JSON.parse(res.data)
              if (data.code === 200) {
                resolve(data)
              } else {
                wx.showToast({
                  title: data.message || 'ä¸Šä¼ å¤±è´¥',
                  icon: 'none',
                  duration: 2000
                })
                reject(data)
              }
            } catch (e) {
              wx.showToast({
                title: 'è§£æå“åº”å¤±è´¥',
                icon: 'none',
                duration: 2000
              })
              reject(e)
            }
          } else {
            wx.showToast({
              title: `ä¸Šä¼ å¤±è´¥ ${res.statusCode}`,
              icon: 'none',
              duration: 2000
            })
            reject(new Error(`HTTP ${res.statusCode}`))
          }
        },
        fail: (err) => {
          wx.hideLoading()
          wx.showToast({
            title: 'ä¸Šä¼ å¤±è´¥',
            icon: 'none',
            duration: 2000
          })
          reject(err)
        }
      })
    })
  },

  // æ£€æŸ¥æƒé™
  checkPermission(requiredRoles = []) {
    const userInfo = this.getUserInfo()
    if (!userInfo) {
      return false
    }
    
    if (requiredRoles.length === 0) {
      return true
    }
    
    return requiredRoles.includes(userInfo.role)
  },

  // è·³è½¬åˆ°æƒé™ä¸è¶³é¡µé¢æˆ–æ˜¾ç¤ºæç¤º
  showPermissionError() {
    wx.showModal({
      title: 'æƒé™ä¸è¶³',
      content: 'æ‚¨æ²¡æœ‰æƒé™è¿›è¡Œæ­¤æ“ä½œ',
      showCancel: false,
      confirmText: 'ç¡®å®š',
      success: () => {
        wx.navigateBack()
      }
    })
  },

  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  showError(message) {
    wx.showToast({
      title: message || 'æ“ä½œå¤±è´¥',
      icon: 'none',
      duration: 2000
    })
  },

  // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
  showSuccess(message) {
    wx.showToast({
      title: message || 'æ“ä½œæˆåŠŸ',
      icon: 'success',
      duration: 2000
    })
  }
})



{
  "pages": [
    
    "pages/index/index",
    "pages/login/login",
    "pages/register/register",
    "pages/profile/profile",
    "pages/dormitory/buildings/buildings",
    "pages/dormitory/rooms/rooms",
    "pages/dormitory/building-detail/building-detail",
    "pages/dormitory/room-detail/room-detail",
    "pages/dormitory/building-edit/building-edit",
    "pages/dormitory/room-edit/room-edit",
    "pages/dormitory/building-stats/building-stats",
    "pages/dormitory/room-assign/room-assign",
    "pages/repair/list/list",
    "pages/repair/submit/submit",
    "pages/repair/detail/detail",
    "pages/visitor/register/register",
    "pages/visitor/list/list",
    "pages/visitor/detail/detail",
    "pages/hygiene/check/check",
    "pages/hygiene/detail/detail",
    "pages/notice/list/list",
    "pages/notice/detail/detail",
    "pages/notice/edit/edit"
    
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#1890ff",
    "navigationBarTitleText": "å®¿èˆç®¡ç†ç³»ç»Ÿ",
    "navigationBarTextStyle": "white"
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1890ff",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "é¦–é¡µ",
        "iconPath": "images/tabbar/home.png",
        "selectedIconPath": "images/tabbar/home_active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "æˆ‘çš„",
        "iconPath": "images/tabbar/profile.png",
        "selectedIconPath": "images/tabbar/profile_active.png"
      }
    ]
  },
  "style": "v2",
  "sitemapLocation": "sitemap.json",
  "permission": {
    "scope.userLocation": {
      "desc": "ä½ çš„ä½ç½®ä¿¡æ¯å°†ç”¨äºå®¿èˆå®šä½"
    }
  },
  "requiredPrivateInfos": [
    "getLocation"
  ]
}



/* app.wxss */
page {
  background-color: #f5f5f5;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.container {
  padding: 20rpx;
}

/* å¡ç‰‡æ ·å¼ */
.card {
  background: #fff;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
}

/* æŒ‰é’®æ ·å¼ */
.btn-primary {
  background: #1890ff;
  color: #fff;
  border-radius: 8rpx;
  font-size: 32rpx;
  height: 88rpx;
  line-height: 88rpx;
  text-align: center;
  margin: 40rpx 0;
}

.btn-secondary {
  background: #fff;
  color: #1890ff;
  border: 2rpx solid #1890ff;
  border-radius: 8rpx;
  font-size: 32rpx;
  height: 88rpx;
  line-height: 88rpx;
  text-align: center;
  margin: 40rpx 0;
}

.btn-disabled {
  background: #d9d9d9;
  color: #999;
  border-radius: 8rpx;
  font-size: 32rpx;
  height: 88rpx;
  line-height: 88rpx;
  text-align: center;
  margin: 40rpx 0;
}

/* è¾“å…¥æ¡†æ ·å¼ */
.input-group {
  margin-bottom: 32rpx;
}

.input-label {
  font-size: 28rpx;
  color: #333;
  margin-bottom: 16rpx;
  display: block;
}

.input-field {
  background: #fff;
  border: 2rpx solid #d9d9d9;
  border-radius: 8rpx;
  padding: 24rpx;
  font-size: 28rpx;
  min-height: 80rpx;
  box-sizing: border-box;
}

.input-field:focus {
  border-color: #1890ff;
}

/* çŠ¶æ€æ ‡ç­¾ */
.status-tag {
  display: inline-block;
  padding: 8rpx 16rpx;
  border-radius: 16rpx;
  font-size: 24rpx;
  font-weight: 500;
}

.status-pending {
  background: #fff7e6;
  color: #fa8c16;
}

.status-processing {
  background: #e6f7ff;
  color: #1890ff;
}

.status-completed {
  background: #f6ffed;
  color: #52c41a;
}

.status-cancelled {
  background: #f5f5f5;
  color: #999;
}

/* åˆ—è¡¨é¡¹æ ·å¼ */
.list-item {
  background: #fff;
  padding: 32rpx;
  margin-bottom: 20rpx;
  border-radius: 16rpx;
  box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
}

.list-item-title {
  font-size: 32rpx;
  color: #333;
  font-weight: 500;
  margin-bottom: 16rpx;
}

.list-item-desc {
  font-size: 28rpx;
  color: #666;
  margin-bottom: 8rpx;
}

.list-item-time {
  font-size: 24rpx;
  color: #999;
  text-align: right;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 100rpx 0;
}

.empty-image {
  width: 200rpx;
  height: 200rpx;
  margin-bottom: 32rpx;
}

.empty-text {
  font-size: 28rpx;
  color: #999;
}

/* åŠ è½½æ›´å¤š */
.load-more {
  text-align: center;
  padding: 32rpx;
  font-size: 28rpx;
  color: #999;
}

/* é¡µå¤´æ“ä½œæŒ‰é’® */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 32rpx;
  background: #fff;
}

.page-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
}

.header-actions {
  display: flex;
  gap: 16rpx;
}

.header-btn {
  padding: 16rpx 24rpx;
  font-size: 28rpx;
  color: #1890ff;
  background: #fff;
  border: 2rpx solid #1890ff;
  border-radius: 8rpx;
}

/* ç­›é€‰å™¨ */
.filter-bar {
  display: flex;
  gap: 16rpx;
  padding: 32rpx;
  background: #fff;
  margin-bottom: 20rpx;
  flex-wrap: wrap;
}

.filter-item {
  flex: 1;
  min-width: 200rpx;
}

/* è¡¨æ ¼æ ·å¼ */
.table-container {
  background: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  margin-bottom: 20rpx;
}

.table-header {
  background: #fafafa;
  display: flex;
  padding: 24rpx;
  font-weight: 600;
  color: #333;
  font-size: 28rpx;
}

.table-row {
  display: flex;
  padding: 24rpx;
  border-top: 2rpx solid #f0f0f0;
}

.table-cell {
  flex: 1;
  font-size: 28rpx;
  color: #666;
}

/* å“åº”å¼è¾…åŠ©ç±» */
.text-center {
  text-align: center;
}

.text-right {
  text-align: right;
}

.text-left {
  text-align: left;
}

.mt-10 { margin-top: 10rpx; }
.mt-20 { margin-top: 20rpx; }
.mt-30 { margin-top: 30rpx; }
.mt-40 { margin-top: 40rpx; }

.mb-10 { margin-bottom: 10rpx; }
.mb-20 { margin-bottom: 20rpx; }
.mb-30 { margin-bottom: 30rpx; }
.mb-40 { margin-bottom: 40rpx; }

.ml-10 { margin-left: 10rpx; }
.ml-20 { margin-left: 20rpx; }
.ml-30 { margin-left: 30rpx; }
.ml-40 { margin-left: 40rpx; }

.mr-10 { margin-right: 10rpx; }
.mr-20 { margin-right: 20rpx; }
.mr-30 { margin-right: 30rpx; }
.mr-40 { margin-right: 40rpx; }

.p-20 { padding: 20rpx; }
.p-30 { padding: 30rpx; }
.p-40 { padding: 40rpx; }

.flex { display: flex; }
.flex-column { flex-direction: column; }
.flex-row { flex-direction: row; }
.flex-wrap { flex-wrap: wrap; }
.flex-1 { flex: 1; }
.flex-center { 
  display: flex;
  align-items: center;
  justify-content: center;
}

.align-center { align-items: center; }
.justify-between { justify-content: space-between; }
.justify-center { justify-content: center; }
.justify-end { justify-content: flex-end; }





{
  "description": "é¡¹ç›®é…ç½®æ–‡ä»¶",
  "packOptions": {
    "ignore": [
      {
        "type": "file",
        "value": ".eslintrc.js"
      }
    ]
  },
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": false,
    "coverView": true,
    "nodeModules": true,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "lazyloadPlaceholderEnable": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    },
    "enableEngineNative": false,
    "useIsolateContext": true,
    "userConfirmedBundleSwitch": false,
    "packNpmManually": false,
    "packNpmRelationList": [],
    "minifyWXSS": true,
    "disableUseStrict": false,
    "minifyWXML": true,
    "showES6CompileOption": false,
    "useCompilerPlugins": false,
    "ignoreUploadUnusedFiles": true
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "appid": "wxf7cdaa7cc8480cf3",
  "projectname": "å®¿èˆç®¡ç†ç³»ç»Ÿ",
  "debugOptions": {
    "hidedInDevtools": []
  },
  "scripts": {},
  "staticServerOptions": {
    "baseURL": "",
    "servePath": ""
  },
  "isGameTourist": false,
  "condition": {
    "search": {
      "list": []
    },
    "conversation": {
      "list": []
    },
    "game": {
      "list": []
    },
    "plugin": {
      "list": []
    },
    "gamePlugin": {
      "list": []
    },
    "miniprogram": {
      "list": [
        {
          "id": -1,
          "name": "é¦–é¡µ",
          "pathName": "pages/index/index",
          "query": ""
        }
      ]
    }
  }
}
